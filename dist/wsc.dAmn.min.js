function EventEmitter(){function a(a,b){var c=e[a]||!1;return c===!1?(e[a]=[b],f):(e[a].push(b),f)}function b(a){return e[a]=[],f}function c(){var a=Array.prototype.slice.call(arguments),b=a.shift(),c=e[b]||!1,d=0;if(c===!1)return d;for(var f in c)if(c.hasOwnProperty(f)&&(bubble=c[f].apply({},a),d++,bubble===!1))break;return d}function d(a){return e[a]||[]}var e={},f=this;this.addListener=a,this.removeListeners=b,this.emit=c,this.listeners=d}function $_GET(a,b){b=b||window.location.search;var c=new RegExp("&"+a+"(?:=([^&]*))?(?=&|$)","i");return b=b.replace(/^\?/,"&").match(c),b?"undefined"!=typeof b[1]?decodeURIComponent(b[1].replace(/\+/g,"%20")):"":void 0}function UnixTimestamp(a){return ret=new Date(1e3*a)}function PosEnd(a){return"1"==a?"st":"2"==a?"nd":"3"==a?"rd":"th"}function DateStamp(a){return a=UnixTimestamp(a),date=String(a.getDate()),month=a.getMonth(),df=date[date.length-1],date+PosEnd(df)+" of "+Months[month]+", "+a.getFullYear()}function caseInsensitiveSort(a,b){return a=a.toLowerCase(),b=b.toLowerCase(),a>b?1:b>a?-1:0}function EscapeRegExp(a){return a.replace(new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g"),"\\$1")}function zeroPad(a,b){return b=b||2,b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a+""}function formatTime(a,b){return b=b||new Date,HH=b.getHours(),hh=HH,a=replaceAll(a,"{mm}",zeroPad(b.getMinutes(),2)),a=replaceAll(a,"{ss}",zeroPad(b.getSeconds(),2)),mr="am",hh>11?(mr="pm",hh>12&&(hh-=12)):0==hh&&(hh="12"),a=replaceAll(a,"{hh}",zeroPad(hh,2)),a=replaceAll(a,"{HH}",zeroPad(HH,2)),a=replaceAll(a,"{mr}",mr)}function oxlist(a){return last=a.pop(),ret=a.join(", "),ret+(ret.length>0?", and ":"")+last}function pluralise(a,b){return a+(1==b?"":"s")}function timeLengthString(a){if(0>=a)return"0 seconds.";var b=a,c=[];c.unshift(["second",Math.round(b%60)]),b/=Math.round(60),c.unshift(["minute",Math.round(b%60)]),b/=Math.round(60),c.unshift(["hour",Math.round(b%24)]),b/=Math.round(24),c.unshift(["day",b]);var d=[];for(i in c)lapse=c[i],lapse[1]<1||d.push(lapse[1].toString()+" "+pluralise(lapse[0],lapse[1]));return oxlist(d)}function StringSet(a){this.items=a||[]}function wsc_packetstr(a,b,c,d){var e="";if(a&&(e=a,b&&(e=e+" "+b)),c)for(var f in c)e=e+"\n"+f+"="+c[f];return e+="\n",d&&(e=e+"\n"+d),e}function packetToString(a){return wsc_packetstr(a.cmd,a.param,a.arg,a.body)}function packetEvtName(a){var b=a.cmd,c=null;for(var d in chains)if(c=chains[d],c[0]==b){var e=a.sub[0];if(b=b+"_"+e.cmd,c.length>1&&void 0!=e.param&&c[1]==e.cmd)return b+"_"+e.param}return b}var wsc={};wsc.VERSION="1.8.55",wsc.STATE="release candidate",wsc.REVISION="0.22.140",wsc.defaults={},wsc.defaults.theme="wsct_dark",wsc.defaults.themes=["wsct_dAmn","wsct_dark"];var CryptoJS=CryptoJS||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(a){function b(a,b,c,d,e,f,g){return a=a+(b&c|~b&d)+e+g,(a<<f|a>>>32-f)+b}function c(a,b,c,d,e,f,g){return a=a+(b&d|c&~d)+e+g,(a<<f|a>>>32-f)+b}function d(a,b,c,d,e,f,g){return a=a+(b^c^d)+e+g,(a<<f|a>>>32-f)+b}function e(a,b,c,d,e,f,g){return a=a+(c^(b|~d))+e+g,(a<<f|a>>>32-f)+b}for(var f=CryptoJS,g=f.lib,h=g.WordArray,i=g.Hasher,g=f.algo,j=[],k=0;64>k;k++)j[k]=4294967296*a.abs(a.sin(k+1))|0;g=g.MD5=i.extend({_doReset:function(){this._hash=new h.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(a,f){for(var g=0;16>g;g++){var h=f+g,i=a[h];a[h]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var g=this._hash.words,h=a[f+0],i=a[f+1],k=a[f+2],l=a[f+3],m=a[f+4],n=a[f+5],o=a[f+6],p=a[f+7],q=a[f+8],r=a[f+9],s=a[f+10],t=a[f+11],u=a[f+12],v=a[f+13],w=a[f+14],x=a[f+15],y=g[0],z=g[1],A=g[2],B=g[3],y=b(y,z,A,B,h,7,j[0]),B=b(B,y,z,A,i,12,j[1]),A=b(A,B,y,z,k,17,j[2]),z=b(z,A,B,y,l,22,j[3]),y=b(y,z,A,B,m,7,j[4]),B=b(B,y,z,A,n,12,j[5]),A=b(A,B,y,z,o,17,j[6]),z=b(z,A,B,y,p,22,j[7]),y=b(y,z,A,B,q,7,j[8]),B=b(B,y,z,A,r,12,j[9]),A=b(A,B,y,z,s,17,j[10]),z=b(z,A,B,y,t,22,j[11]),y=b(y,z,A,B,u,7,j[12]),B=b(B,y,z,A,v,12,j[13]),A=b(A,B,y,z,w,17,j[14]),z=b(z,A,B,y,x,22,j[15]),y=c(y,z,A,B,i,5,j[16]),B=c(B,y,z,A,o,9,j[17]),A=c(A,B,y,z,t,14,j[18]),z=c(z,A,B,y,h,20,j[19]),y=c(y,z,A,B,n,5,j[20]),B=c(B,y,z,A,s,9,j[21]),A=c(A,B,y,z,x,14,j[22]),z=c(z,A,B,y,m,20,j[23]),y=c(y,z,A,B,r,5,j[24]),B=c(B,y,z,A,w,9,j[25]),A=c(A,B,y,z,l,14,j[26]),z=c(z,A,B,y,q,20,j[27]),y=c(y,z,A,B,v,5,j[28]),B=c(B,y,z,A,k,9,j[29]),A=c(A,B,y,z,p,14,j[30]),z=c(z,A,B,y,u,20,j[31]),y=d(y,z,A,B,n,4,j[32]),B=d(B,y,z,A,q,11,j[33]),A=d(A,B,y,z,t,16,j[34]),z=d(z,A,B,y,w,23,j[35]),y=d(y,z,A,B,i,4,j[36]),B=d(B,y,z,A,m,11,j[37]),A=d(A,B,y,z,p,16,j[38]),z=d(z,A,B,y,s,23,j[39]),y=d(y,z,A,B,v,4,j[40]),B=d(B,y,z,A,h,11,j[41]),A=d(A,B,y,z,l,16,j[42]),z=d(z,A,B,y,o,23,j[43]),y=d(y,z,A,B,r,4,j[44]),B=d(B,y,z,A,u,11,j[45]),A=d(A,B,y,z,x,16,j[46]),z=d(z,A,B,y,k,23,j[47]),y=e(y,z,A,B,h,6,j[48]),B=e(B,y,z,A,p,10,j[49]),A=e(A,B,y,z,w,15,j[50]),z=e(z,A,B,y,n,21,j[51]),y=e(y,z,A,B,u,6,j[52]),B=e(B,y,z,A,l,10,j[53]),A=e(A,B,y,z,s,15,j[54]),z=e(z,A,B,y,i,21,j[55]),y=e(y,z,A,B,q,6,j[56]),B=e(B,y,z,A,x,10,j[57]),A=e(A,B,y,z,o,15,j[58]),z=e(z,A,B,y,v,21,j[59]),y=e(y,z,A,B,m,6,j[60]),B=e(B,y,z,A,t,10,j[61]),A=e(A,B,y,z,k,15,j[62]),z=e(z,A,B,y,r,21,j[63]);g[0]=g[0]+y|0,g[1]=g[1]+z|0,g[2]=g[2]+A|0,g[3]=g[3]+B|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;c[e>>>5]|=128<<24-e%32;var f=a.floor(d/4294967296);for(c[(e+64>>>9<<4)+15]=16711935&(f<<8|f>>>24)|4278255360&(f<<24|f>>>8),c[(e+64>>>9<<4)+14]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8),b.sigBytes=4*(c.length+1),this._process(),b=this._hash,c=b.words,d=0;4>d;d++)e=c[d],c[d]=16711935&(e<<8|e>>>24)|4278255360&(e<<24|e>>>8);return b},clone:function(){var a=i.clone.call(this);return a._hash=this._hash.clone(),a}}),f.MD5=i._createHelper(g),f.HmacMD5=i._createHmacHelper(g)}(Math),wsc.Transport=function(a,b,c,d){this.sock=null,this.conn=null,this.server=a,this.open(b),this.message(c),this.disconnect(d)},wsc.Transport.Create=function(a,b,c,d){if("undefined"!=typeof io)return new wsc.SocketIO(a,b,c,d);if(!window.WebSocket)throw"This browser does not support websockets.";return new wsc.WebSocket(a,b,c,d)},wsc.Transport.prototype.open=function(a){this._open=a||this.sopen},wsc.Transport.prototype.message=function(a){this._message=a||this.smessage},wsc.Transport.prototype.disconnect=function(a){this._disconnect=a||this.sdisconnect},wsc.Transport.prototype.sopen=function(){},wsc.Transport.prototype.smessage=function(){},wsc.Transport.prototype.sdisconnect=function(){},wsc.Transport.prototype._open=function(){},wsc.Transport.prototype._message=function(){},wsc.Transport.prototype._disconnect=function(){},wsc.Transport.prototype.connect=function(){},wsc.Transport.prototype.send=function(){},wsc.Transport.prototype.close=function(){},wsc.WebSocket=function(a,b,c,d){this.sock=null,this.conn=null,this.server=a,this.cause=null,this.open(b),this.message(c),this.disconnect(d)},wsc.WebSocket.prototype=new wsc.Transport,wsc.WebSocket.prototype.constructor=wsc.WebSocket,wsc.WebSocket.prototype.onopen=function(a,b){this.sock=b||this.conn,this._open(a,this)},wsc.WebSocket.prototype.ondisconnect=function(a){this.sock=null,this.conn=null,this._disconnect({wsEvent:a,cause:this.cause})},wsc.WebSocket.prototype.connect=function(){var a=this;this.conn=new WebSocket(this.server),this.conn.onopen=function(b,c){a.onopen(b,c)},this.conn.onmessage=this._message,this.conn.onclose=function(b){a.ondisconnect(b)}},wsc.WebSocket.prototype.send=function(a){return null==this.sock?-1:this.sock.send(replaceAll(escape(a).replace(/\%u([\dA-F]{4})/g,"%26%23x$1%3B"),"+","%2B"))},wsc.WebSocket.prototype.close=function(a){null!=this.sock&&(this.cause=a,this.sock.close())},wsc.SocketIO=function(a,b,c,d){this.sock=null,this.conn=null,this.server=a,this.open(b),this.message(c),this.disconnect(d)},wsc.SocketIO.prototype=new wsc.Transport(""),wsc.SocketIO.prototype.constructor=wsc.SocketIO,wsc.SocketIO.prototype.connect=function(){var a=this;this.conn=io.connect(this.server),this.conn.on("connect",function(b,c){a.onopen(b,c)}),this.conn.on("message",function(b){a._message({data:b})}),this.conn.on("close",function(b){a.ondisconnect(b)})},wsc.SocketIO.prototype.onopen=function(a,b){this.sock=b||this.conn,this._open(a,this)},wsc.SocketIO.prototype.ondisconnect=function(a){this.sock=null,this.conn=null,this._disconnect(a)},wsc.SocketIO.prototype.send=function(a){return null==this.sock?-1:this.sock.send(replaceAll(escape(a).replace(/\%u([\dA-F]{4})/g,"%26%23x$1%3B"),"+","%2B"))},wsc.SocketIO.prototype.close=function(){null!=this.sock&&this.sock.close()};var Months=["January","February","March","April","May","June","July","August","September","October","November","December"];String.format=function(){var a=Array.prototype.slice.call(arguments),b=a.shift();if(a=a.shift(),0==a.length)return b;var c=a.length;return b.replace(/{(\d+)}/g,function(b,d){return c<=parseInt(d)?b:"undefined"!=typeof a[d]?a[d]:b})},replaceAllRaw=function(a,b,c){for(;a.indexOf(b)>-1;)a=a.replace(b,c);return a},replaceAll=function(a,b,c){return a.split(b).join(c)},Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},Object.steal=function(a,b){for(var c in b)(a.hasOwnProperty(c)||b.hasOwnProperty(c))&&(a[c]="object"==typeof a[c]?Object.extend(a[c],b[c]):b[c])},Object.extend=function(a,b){var c={};return Object.steal(c,a),Object.steal(c,b),c},StringSet.prototype.add=function(a,b){return a?(a=a.toLowerCase(),this.contains(a)?!0:(b?this.items.unshift(a):this.items.push(a),!0)):!1},StringSet.prototype.remove=function(a){return a?(a=a.toLowerCase(),this.contains(a)?(this.items.splice(this.items.indexOf(a),1),!0):!0):!1},StringSet.prototype.contains=function(a){return a?-1!=this.items.indexOf(a.toLowerCase()):!1},wsc.Middleware=function(){this.callbacks={}},wsc.Middleware.prototype.add=function(a,b){var c=this.callbacks[a]||!1;return c===!1&&(this.callbacks[a]=[]),this.callbacks[a].push(b),this.callbacks[a].length},wsc.Middleware.prototype.run=function(a,b,c){var d=(this.callbacks[a]||[]).slice();d.push(b);var e=function(a){d.shift()(a,e)};e(c)},wsc.Storage=function(a,b){this.ns=a||null,this.parent=b||null},wsc.Storage.prototype.folder=function(a){return null!=this.ns&&(a=this.ns+"."+a),new wsc.Storage(a,this)},wsc.Storage.prototype.get=function(a,b){null!=this.ns&&(a=this.ns+"."+a);try{return localStorage.hasOwnProperty(a)?localStorage[a]:b}catch(c){return b}},wsc.Storage.prototype.set=function(a,b){null!=this.ns&&(a=this.ns+"."+a);try{localStorage[a]=b}catch(c){}},wsc.Storage.prototype.remove=function(a){null!=this.ns&&(a=this.ns+"."+a);try{return localStorage.hasOwnProperty(a)?delete localStorage[a]:!1}catch(b){}return!1};var chains=[["recv","admin"]];with(wsc.Packet=function(a,b,c){if(!a)return null;void 0===c&&(c=!0),b=b||"=";var d={cmd:null,param:null,arg:{},body:null,sub:[],raw:a},e=null,f=-1;try{f=a.indexOf("\n\n"),f>-1&&(d.body=a.substr(f+2),a=a.substr(0,f)),e=a.split("\n"),-1==e[0].indexOf(b)&&(cline=e.shift().split(" "),d.cmd=cline.shift()||null,d.param=cline.join(" ")||null);for(var g in e)arg=e[g],f=arg.search(b),-1!=f&&(d.arg[arg.substr(0,f)]=arg.substr(f+b.length)||"");if(null!=d.body&&c){subs=d.body.split("\n\n");for(var h in subs){if(sub=wsc.Packet(subs[h],b,!1),null==sub)break;sub.body=subs.slice(h+1).join("\n\n"),d.sub.push(sub)}}}catch(i){return null}return d.toString=function(){return packetToString(d)},d.name=packetEvtName(d),d},wsc.Channel=function(a,b,c,d){this.info={members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""}},this.client=a,this.hidden=c,this.monitor=void 0==d?!1:d,this.raw=a.format_ns(b),this.selector=("pc"==this.raw.substr(0,2)?"pc":"c")+"-"+a.deform_ns(b).slice(1).toLowerCase(),this.namespace=a.deform_ns(b),this.monitor=0==Object.size(this.client.channelo)},wsc.Channel.prototype.build=function(){this.info.members={},"@"==this.namespace[0]&&this.set_privclasses({pkt:{body:""}})},wsc.Channel.prototype.property=function(a){var b=a.pkt.arg.p;switch(b){case"title":case"topic":this.set_header(b,a);break;case"privclasses":this.set_privclasses(a);break;case"members":this.set_members(a);break;default:this.server_message("Received unknown property "+b+" received in "+this.info.namespace+".")}},wsc.Channel.prototype.set_header=function(a,b){this.info[a].content=b.value.text()||"",this.info[a].by=b.by,this.info[a].ts=b.ts},wsc.Channel.prototype.set_privclasses=function(a){if("@"==this.namespace[0])this.info.pc={100:"Room Members"},this.info.pc_order=[100];else{this.info.pc={},this.info.pc_order=[];var b=a.pkt.body.split("\n"),c=[];for(var d in b)b.hasOwnProperty(d)&&(c=b[d].split(":"),1!=c.length&&(this.info.pc_order.push(parseInt(c[0])),this.info.pc[parseInt(c[0])]=c[1]))}this.info.pc_order.sort(function(a,b){return b-a});this.info.pc,this.info.pc_order.slice(0)},wsc.Channel.prototype.get_privclass_order=function(a){a=a.toLowerCase();for(var b in this.info.pc)if(this.info.pc.hasOwnProperty(b)&&this.info.pc[b].toLowerCase()==a)return b},wsc.Channel.prototype.set_members=function(a){this.info.members={};for(var b in a.pkt.sub)a.pkt.sub.hasOwnProperty(b)&&this.register_user(a.pkt.sub[b],!0);this.set_user_list()},wsc.Channel.prototype.set_user_list=function(){if(0!=Object.size(this.info.members)){var a=this.get_usernames(),b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(this.info.members[a[c]]);this.client.trigger("ns.user.list",{name:"set.userlist",ns:this.namespace,users:b})}},wsc.Channel.prototype.user_info=function(a){var b=this.info.members[a],c=b.symbol;return{name:a,pc:b.pc||"Room Members",symbol:c,conn:b.conn,hover:{member:b,name:a,avatar:'<img class="avatar" src="" height="50" width="50" />',link:c+'<a target="_blank" href="http://'+a+"."+this.client.settings.domain+'/">'+a+"</a>",info:[]}}},wsc.Channel.prototype.register_user=function(a,b){var c=a.param;if(void 0==this.info.members[c])this.info.members[c]=a.arg,this.info.members[c].username=c,this.info.members[c].conn=1,this.info.members[c]=this.user_info(c);else{for(i in a.arg)this.info.members[c][i]=a.arg[i];this.info.members[c].conn++}"pc"in this.info.members[c]||(this.info.members[c].pc="Room Members"),b=b||!1,b||this.client.trigger("ns.user.registered",{name:"ns.user.registered",ns:this.namespace,user:c})},wsc.Channel.prototype.get_usernames=function(){var a=[];for(var b in this.info.members)a.push(b);return a.sort(caseInsensitiveSort),a},wsc.Channel.prototype.remove_user=function(a,b){b=b||!1;var c=this.info.members[a];void 0!=c&&(c.conn--,(0==c.conn||b)&&delete this.info.members[a],this.client.trigger("ns.user.remove",{user:c.name,ns:this.namespace}))},wsc.Channel.prototype.recv_join=function(a){var b=new wsc.Packet("user "+a.user+"\n"+a.info);this.register_user(b)},wsc.Channel.prototype.recv_part=function(a){this.remove_user(a.user)},wsc.Channel.prototype.recv_privchg=function(a){var b=this;this.client.cascade("ns.user.privchg",function(a){var c=b.info.members[a.user];c&&(c.pc=a.pc)},a)},wsc.Channel.prototype.recv_kicked=function(a){this.remove_user(a.user,!0),this.set_user_list()},wsc.MessageString=function(a,b){this._parser=b||new wsc.MessageParser,this.raw=a},wsc.MessageString.prototype=new String)constructor=wsc.MessageParser,toString=valueOf=function(){return this.raw};with(wsc.MessageString.prototype.html=function(){return this.raw},wsc.MessageString.prototype.text=function(){return this.raw},wsc.MessageString.prototype.ansi=function(){return this.raw},wsc.MessageParser=function(){},wsc.MessageParser.prototype.parse=function(a){return new wsc.MessageString(a,this)},wsc.MessageParser.prototype.render=function(a,b){return b.raw},wsc.Protocol=function(a){this.mparser=a||new wsc.MessageParser,this.chains=[["recv","admin"]],this.maps={chatserver:["version"],login:["username",["e"],"data"],join:["ns",["e"]],part:["ns",["e","*r"]],property:["ns",["p","by","ts"],"*value"],recv_msg:[null,[["from","user"]],"*message"],recv_npmsg:[null,[["from","user"]],"message"],recv_action:[null,["s",["from","user"]],"*message"],recv_join:["user",["s"],"*info"],recv_part:["user",["s","r"]],recv_privchg:["user",["s","by","pc"]],recv_kicked:["user",[["i","s"],"by"],"*r"],recv_admin_create:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_update:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_rename:[null,["p",["by","user"],"prev",["name","pc"]]],recv_admin_move:[null,["p",["by","user"],"prev",["name","pc"],["n","affected"]]],recv_admin_remove:[null,["p",["by","user"],["name","pc"],["n","affected"]]],recv_admin_show:[null,["p"],"info"],recv_admin_showverbose:[null,["p"],"info"],recv_admin_privclass:[null,["p","e"],"command"],kicked:["ns",[["by","user"]],"*r"],ping:[],disconnect:[null,["e"]],send:["ns",["e"]],kick:["ns",[["u","user"],"e"]],get:["ns",["p","e"]],set:["ns",["p","e"]],kill:["ns",["e"]],unknown:[null,null,null,"packet"]};var b=this;this.mapper={recv:function(a,c,d){return c.ns=a.param,b.map(a.sub[0],c,d)}}},wsc.Protocol.prototype.extend_maps=function(a){for(var b in a)this.maps[b]=a[b]},wsc.Protocol.prototype.populate_keys=function(){this.tkeys={};for(var a in this.maps)if(this.maps.hasOwnProperty(a)){var b=this.maps[a],c="";this.tkeys[a]=[];for(var d in b)if(b.hasOwnProperty(d)&&(c=b[d]))if(1!=d)this.tkeys[a].push("*"==c[0]?c.substr(1):c);else{var e="";for(var f in c)c.hasOwnProperty(f)&&(e=c[f],e&&(e instanceof Array&&(e=e[1]),this.tkeys[a].push("*"==e[0]?e.substr(1):e)))}}},wsc.Protocol.prototype.parse=function(a){var b=this.event(a);b in this.maps?mapping=this.maps[b]:(console.log("unknown: ",b),console.log(this.maps),mapping=this.maps.unknown,b="unknown");var c={name:b,pkt:a,ns:null};return cmd=a.cmd,this.mapper[cmd]?this.mapper[cmd](a,c,mapping):this.map(a,c,mapping),c},wsc.Protocol.prototype.event=function(a){var b=a.cmd,c=null;for(var d in this.chains)if(c=this.chains[d],c[0]==b){var e=a.sub[0];if(b=b+"_"+e.cmd,c.length>1&&void 0!=e.param&&c[1]==e.cmd)return b+"_"+e.param}return b},wsc.Protocol.prototype.map=function(a,b,c){for(var d in c)if(null!=c[d]){var e=c[d],f=e,g="",h="";switch(parseInt(d)){case 0:b[e]=a.param;break;case 1:if(c[1]instanceof Array)for(var i in c[1])if(e=c[1][i],e instanceof Array)b[e[1]]=a.arg[e[0]],f=e[1];else{var g="*"==e[0]?e.slice(1):e;b[e]=a.arg[g]||"",f=e}"string"==typeof c[1]&&(b[e]=a.arg.slice(0));break;case 2:e instanceof Array?(a.sub[0].sub=a.sub.slice(1),this.map(a.sub[0],b,e)):b[e]=a.body;break;case 3:b[e]=a.raw}"*"==f[0]&&(g=f.slice(1),h=this.mparser.parse(b[f]),b[g]=h)}},wsc.Flow=function(a){this.protocol=a||new wsc.Protocol},wsc.Flow.prototype.open=function(a){a.trigger("connected",{name:"connected",pkt:new wsc.Packet("connected\n\n")}),a.connected=!0,a.handshake(),a.attempts=0},wsc.Flow.prototype.close=function(a,b){var c={name:"closed",pkt:new wsc.Packet("connection closed\n\n"),reason:"",evt:b,connected:a.connected,sio:a.conn instanceof wsc.SocketIO,cause:b.cause||null,reconnect:!0},d={name:"log",ns:"~System",msg:"",info:""};if(a.trigger("closed",c),a.connected){if(d.msg="Connection closed",a.trigger("log",d),a.connected=!1,a.conn instanceof wsc.SocketIO)return d.msg="At the moment there is a problem with reconnecting with socket.io",d.info="Refresh to connect",a.trigger("log",d),void(d.info="")}else d.msg="Connection failed",a.trigger("log",d);return c.name="quit",a.attempts>2?(c.reconnect=!1,a.attempts=0,void a.trigger("quit",c)):b.cause&&b.cause.hasOwnProperty("name")&&"login"==b.cause.name?void a.trigger("quit",c):void setTimeout(function(){a.connect()},2e3)},wsc.Flow.prototype.message=function(a,b){var c=new wsc.Packet(unescape(replaceAll(b.data,"+"," ")));if(null!=c){var d=this.protocol.parse(c);null==d.ns&&(d.ns=a.mns),d.sns=a.deform_ns(d.ns),this.handle(a,d),a.trigger("pkt",d),a.trigger("pkt."+d.name,d)}},wsc.Flow.prototype.handle=function(a,b){try{this[b.name](b,a)}catch(c){}},wsc.Flow.prototype.ping=function(a,b){b.pong()},wsc.Flow.prototype.chatserver=function(a,b){b.login()},wsc.Flow.prototype.login=function(a,b){if("ok"==a.pkt.arg.e){var c=a.pkt.sub[0];b.settings.username=a.pkt.param,b.settings.symbol=c.arg.symbol,b.settings.userinfo=c.arg}else b.close(a);b.fresh&&(b.fresh=!1)},wsc.Flow.prototype.join=function(a,b){if("ok"==a.pkt.arg.e){var c=b.deform_ns(a.pkt.param);b.create_ns(c,b.hidden.contains(a.pkt.param))}else b.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:"Failed to join "+b.deform_ns(a.pkt.param),info:a.pkt.arg.e})},wsc.Flow.prototype.part=function(a,b){var c=b.deform_ns(a.ns),d=b.channel(c);if("ok"==a.e){if(info="",a.r.length>0?info="["+a.r+"]":b.remove_ns(a.ns),msg="You have left "+c,d.server_message(msg,info),0==b.channels()){switch(a.r){case"bad data":case"bad msg":case"msg too big":break;default:if(a.r.indexOf("killed:")<0)return}this.message(b,{data:"disconnect\ne="+e.r+"\n"})}}else b.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:"Couldn't leave "+c,info:a.e})},wsc.Flow.prototype.kicked=function(a,b){a.r.toLowerCase().indexOf("autokicked")>-1||b.join(a.ns)},wsc.Flow.prototype.property=function(a,b){chan=b.channel(a.pkt.param),chan&&chan.property(a)},wsc.Flow.prototype.recv_joinpart=function(a,b){c=b.channel(a.ns),"recv_join"==a.name?c.recv_join(a):c.recv_part(a)},wsc.Flow.prototype.recv_join=wsc.Flow.prototype.recv_joinpart,wsc.Flow.prototype.recv_part=wsc.Flow.prototype.recv_joinpart,wsc.Flow.prototype.recv_msg=function(a,b){b.channel(a.ns).recv_msg(a)},wsc.Flow.prototype.recv_action=wsc.Flow.prototype.recv_msg,wsc.Flow.prototype.recv_npmsg=wsc.Flow.prototype.recv_msg,wsc.Flow.prototype.recv_privchg=function(a,b){b.channel(a.ns).recv_privchg(a)},wsc.Flow.prototype.recv_kicked=function(a,b){b.channel(a.ns).recv_kicked(a)},wsc.defaults.Extension=function(a){var b={},c=function(){a.bind("cmd.connect",d.connection),a.bind("cmd.set",d.setter),a.bind("cmd.join",d.join),a.bind("cmd.chat",d.pjoin),a.bind("cmd.part",d.part),a.bind("cmd.say",d.say),a.bind("cmd.npmsg",d.npmsg),a.bind("cmd.me",d.action),a.bind("cmd.promote",d.chgpriv),a.bind("cmd.demote",d.chgpriv),a.bind("cmd.ban",d.ban),a.bind("cmd.unban",d.ban),a.bind("cmd.kick",d.killk),a.bind("cmd.whois",d.whois),a.bind("cmd.title",d.title),a.bind("cmd.topic",d.title),a.bind("cmd.admin",d.admin),a.bind("cmd.disconnect",d.connection),a.bind("cmd.kill",d.killk),a.bind("cmd.raw",d.raw),a.bind("cmd.close",d.close),a.bind("pkt.property",e),a.bind("pkt.recv_admin_show",g),a.bind("pkt.recv_admin_showverbose",g),a.bind("pkt.get",f)};b.save=function(b){a.settings.ui.theme=b.theme,a.settings.ui.clock=b.clock,a.settings.ui.tabclose=b.tabclose};var d={};d.setter=function(b){var c=b.args.split(" "),d=c.shift().toLowerCase(),c=c.join(" ");return 0==c.length?void a.cchannel.serverMessage("Could not set "+d,"No data supplied"):d in a.settings?(a.settings[d]=c,void a.cchannel.serverMessage("Changed "+d+" setting","value: "+c)):void a.cchannel.serverMessage('Unknown setting "'+d+'"')},d.connection=function(b){a[b.cmd]()},d.join=function(b){var c=b.args.split(" "),c=""==c.toString()?[]:c;if(b.ns!=b.target&&c.unshift(b.target),""!=c.toString())for(index in c)a.join(c[index])},d.pjoin=function(b){var c=b.args.split(" "),c=""==c.toString()?[]:c;if(b.ns!=b.target&&c.unshift(b.target),""!=c.toString())for(index in c)a.join("@"+c[index])},d.part=function(b){var c=b.args.split(" ");if(b.ns!=b.target&&c.unshift(b.target),""==c.toString())return void a.part(b.ns);for(index in c)a.part(c[index])},d.title=function(b){a.set(b.target,b.cmd,b.args)},d.chgpriv=function(b){var c=b.args.split(" ");a[b.cmd.toLowerCase()](b.target,c[0],c[1])},d.ban=function(a,b){var c=a.args.split(" "),d=c.shift(),e=a.cmd;"ban"==e&&c.length>0&&b.kick(a.target,d,c.join(" ")),b[e](a.target,d)},d.action=function(b){a.action(b.target,b.args)},d.raw=function(b){a.send(b.args.replace(/\\n/gm,"\n"))},d.killk=function(a,b){var c=a.args.split(" "),d=c.shift(),e=c.length>0?c.join(" "):null;"kick"==a.cmd?b.kick(a.target,d,e):b.kill(d,e)},d.say=function(b){a.channel(b.target).monitor||a.say(b.target,b.args)},d.npmsg=function(b){a.npmsg(b.target,b.args)},d.close=function(b){a.part(b.target),a.remove_ns(b.target)},d.whois=function(a,b){b.whois(a.args.split(" ")[0])},d.admin=function(a,b){b.admin(a.target,a.args)},d.disconnect=function(a,b){b.disconnect()};var e=function(a,b){if("info"==a.p){var c=a.pkt.sub,d=c.shift().arg;d.username=a.sns.substr(1),d.connections=[];for(var e=null,f={};c.length>0;)switch(f=c.shift(),f.cmd){case"conn":null!=e&&d.connections.push(e),e=f.arg,e.channels=[];break;case"agent":e.agent=[["agent",f.arg.agent]],f.arg.hasOwnProperty("url")&&e.agent.push(["url",f.arg.url]),f.arg.hasOwnProperty("browser")&&e.agent.push(["browser",f.arg.browser]);for(var g in f.arg)"agent"!=g&&"url"!=g&&"browser"!=g&&f.arg.hasOwnProperty(g)&&e.agent.push([g,f.arg[g]]);break;case"ns":e.channels.unshift(b.deform_ns(f.param))}d.connections.push(e),b.trigger("pkt.whois",{name:"pkt.whois",pkt:a.pkt,info:d})}},f=function(a,b){if(0==a.ns.indexOf("login:")){var c=a.sns.substr(1);b.ui.pager.notice({ref:"whois-"+c,heading:"Whois Failed",content:"Whois failed for "+c+".\nNo such user online."},!1,5e3)}},g=function(a,b){var c=b.channel(a.ns),d=a.info.split("\n"),e="",f=[],g="";for(var h in d)d.hasOwnProperty(h)&&(e=d[h].split(" "),"privclass"==a.p?f.push([e.shift(),e.shift().split("=")[1],e.join(" ")]):"users"==a.p&&(g=e.shift().split(":",1)[0],f.push([g,c.get_privclass_order(g),e.join(" ")])));b.ui.chatbook.current.log_pc("privclass"==a.p,f)};return c(),wsc.defaults.Extension.Ignore(a,b),wsc.defaults.Extension.Away(a,b),wsc.defaults.Extension.Autojoin(a,b),b},wsc.defaults.Extension.Autojoin=function(a,b){b.autojoin={on:!1,channel:[]};var c=!0,d=a.storage.folder("autojoin"),e=function(){b.autojoin.load(),b.autojoin.save(),a.bind("cmd.autojoin",g),a.bind("pkt.login",f)};b.autojoin.load=function(){b.autojoin.on="true"==d.get("on","true"),b.autojoin.channel=JSON.parse(d.get("channel","[]"))},b.autojoin.save=function(){d.set("on",b.autojoin.on.toString()),d.set("channel",JSON.stringify(b.autojoin.channel))},b.autojoin.join=function(){for(var c in b.autojoin.channel)b.autojoin.channel.hasOwnProperty(c)&&a.join(b.autojoin.channel[c])},b.autojoin.add=function(a){return-1!=b.autojoin.channel.indexOf(a)?!1:(b.autojoin.channel.push(a),b.autojoin.save(),!0)},b.autojoin.remove=function(a){var c=b.autojoin.channel.indexOf(a);return-1==c?!1:(b.autojoin.channel.splice(c,1),b.autojoin.save(),!0)};var f=function(a,d){if("ok"==a.e){if(c)d.join(d.settings.autojoin),b.autojoin.on&&b.autojoin.join();else{var e=!1;for(key in d.channelo)"~"!=d.channelo[key].namespace[0]&&(d.join(key),e=!0);e||b.autojoin.join()}c=!1}},g=function(c){var d=c.args.split(" ");if(d){{var e=d.shift().toLowerCase(),f=null,g="",h="",i=!1;a.channel(c.ns)}switch(e){case"add":f=b.autojoin.add,g="Added {item} to your autojoin.",h="Already have {item} on your autojoin.";break;case"rem":case"remove":f=b.autojoin.remove,g="Removed {item} from your autojoin.",h=j+" is not on your autojoin list.";break;case"on":a.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:"Autojoin on"}),b.autojoin.on||(i=!0,b.autojoin.on=!0);break;case"off":a.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:"Autojoin off"}),b.autojoin.on&&(i=!0,b.autojoin.on=!1);break;default:b.autojoin.join()}var j="",k=!1;if(null!=f)for(var l in d)d.hasOwnProperty(l)&&(j=a.deform_ns(d[l]).toLowerCase(),k=f(j),a.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:replaceAll(k?g:h,"{item}",j)}));i&&b.autojoin.save()}};e()},wsc.defaults.Extension.Away=function(a,b){var c=a.storage.folder("away");b.away={on:!1,reason:"",last:{},since:0,interval:6e4,format:{setaway:"/me is away: {reason}",setback:"/me is back",away:"{user}: I've been away for {timesince}. Reason: {reason}"}},a.away=b.away;var d=function(){b.away.load(),b.away.save(),a.bind("cmd.setaway",e),a.bind("cmd.setback",f),a.bind("pkt.recv_msg",g),a.bind("pkt.recv_action",g)};b.away.away=function(c){b.away.on=!0,b.away.last={},b.away.since=new Date,b.away.reason=c||"";var d=a.say,e=replaceAll(b.away.format.setaway,"{reason}",b.away.reason||"[silent away]");0==e.indexOf("/me ")&&(e=e.substr(4),d=a.action),a.each_channel(function(b){d.call(a,b,e)}),a.trigger("ext.away.away",{name:"ext.away.away",reason:b.away.reason||"[silent away]"})},b.away.back=function(){if(b.away.on){b.away.on=!1;var c=a.say,d=b.away.format.setback;0==d.indexOf("/me ")&&(d=d.substr(4),c=a.action),a.each_channel(function(b){c.call(a,b,d)}),a.trigger("ext.away.back",{name:"ext.away.back"})}};var e=function(a){b.away.away(a.args)},f=function(){b.away.back()},g=function(c){if(b.away.on&&0!=b.away.reason.length&&!a.exclude.contains(c.ns)){var d=c.user.toLowerCase(),e=a.settings.username.toLowerCase();if(d!=e&&-1!=c.message.text().toLowerCase().indexOf(e)){var f=new Date,g=c.sns.toLowerCase();if(!(g in b.away.last&&f-b.away.last[g]<=b.away.interval)){var h=timeLengthString((f-b.away.since)/1e3),i=replaceAll(b.away.format.away,"{user}",c.user);
i=replaceAll(i,"{timesince}",h),a.say(c.ns,replaceAll(i,"{reason}",b.away.reason)),b.away.last[g]=f}}}};b.away.load=function(){b.away.format.setaway=c.get("setaway","/me is away: {reason}"),b.away.format.setback=c.get("setback","/me is back"),b.away.format.away=c.get("away","{user}: I've been away for {timesince}. Reason: {reason}"),b.away.interval=parseInt(c.get("interval",6e4))},b.away.save=function(){c.set("interval",b.away.interval),c.set("setaway",b.away.format.setaway),c.set("setback",b.away.format.setback),c.set("away",b.away.format.away)},d()},wsc.defaults.Extension.Ignore=function(a,b){var c=a.storage.folder("ignore");b.ignore={fignore:"/me is ignoring {user} now",funignore:"/me is not ignoring {user} anymore",ignored:[]};var d=function(){b.ignore.load(),b.ignore.save(),a.bind("cmd.ignore",e),a.bind("cmd.unignore",f)};b.ignore.load=function(){b.ignore.fignore=c.get("ignore",b.ignore.fignore),b.ignore.funignore=c.get("unignore",b.ignore.funignore),b.ignore.ignored=JSON.parse(c.get("ignored",JSON.stringify(b.ignore.ignored))),a.trigger("ignore.loaded",{name:"ignore.loaded",ignored:b.ignore.ignored})},b.ignore.save=function(){c.set("ignore",b.ignore.fignore),c.set("unignore",b.ignore.funignore),c.set("ignored",JSON.stringify(b.ignore.ignored))},b.ignore.add=function(c,d){var c=c.split(" "),e="";d=d||!1;for(var f=0;f<c.length;f++)c.hasOwnProperty(f)&&(e=c[f].toLowerCase(),-1==b.ignore.ignored.indexOf(e)&&(b.ignore.ignored.push(e),a.trigger("ignore.add",{name:"ignore.add",user:c[f],suppress:d})));b.ignore.save()},b.ignore.remove=function(c,d){var c=c.split(" "),e="",f=-1;d=d||!1;for(var g=0;g<c.length;g++)c.hasOwnProperty(g)&&(e=c[g].toLowerCase(),f=b.ignore.ignored.indexOf(e),-1!=f&&(b.ignore.ignored.splice(f,1),a.trigger("ignore.remove",{name:"ignore.remove",user:c[g],suppress:d})));b.ignore.save()};var e=function(a){b.ignore.add(a.args)},f=function(a){b.ignore.remove(a.args)};d()},wsc.Client=function(a,b,c){this.mozilla=c,this.storage=new wsc.Storage,this.storage.aj=this.storage.folder("autojoin"),this.storage.aj.channel=this.storage.aj.folder("channel"),this.fresh=!0,this.attempts=0,this.connected=!1,this.protocol=null,this.flow=null,this.ui=null,this.events=new EventEmitter,this.conn=null,this.channelo={},this.cchannel=null,this.cmds=[],this.settings={domain:"website.com",server:"ws://website.com/wsendpoint",symbol:"",username:"",userinfo:{},pk:"",monitor:["~Monitor",!0],welcome:"Welcome to the wsc web client!",autojoin:"chat:channel",protocol:wsc.Protocol,mparser:wsc.MessageParser,flow:wsc.Flow,extend:[wsc.defaults.Extension],client:"chatclient",clientver:"0.3",developer:!1};this.exclude=new StringSet,this.hidden=new StringSet,this.settings=Object.extend(this.settings,b),this.config_load(),this.config_save(),this.mw=new wsc.Middleware,this.settings.agent="Client ("+navigator.platform+"; HTML5; JavaScript) wsc/"+wsc.VERSION+"-r"+wsc.REVISION,this.mns=this.format_ns(this.settings.monitor[0]),this.lun=this.settings.username.toLowerCase(),this.protocol=new this.settings.protocol(new this.settings.mparser),this.flow=new this.settings.flow(this.protocol),this.build(),this.ext={},this.ext.defaults=wsc.defaults.Extension(this)},wsc.Client.prototype.config_load=function(){this.settings.developer="true"==this.storage.get("developer",this.settings.developer.toString())},wsc.Client.prototype.config_save=function(){this.storage.set("developer",this.settings.developer)},wsc.Client.prototype.build=function(){this.create_ns(this.settings.monitor[0],!0,!0)},wsc.Client.prototype.loop=function(){},wsc.Client.prototype.add_extension=function(a){this.settings.extend.push(a),a(this)},wsc.Client.prototype.bind=function(a,b){this.events.addListener(a,b),0!=a.indexOf("cmd.")||a.length<=4||(cmd=a.slice(4).toLowerCase(),this.cmds.push(cmd))},wsc.Client.prototype.clear_listeners=function(a){this.events.removeListeners(a)},wsc.Client.prototype.trigger=function(a,b){return this.events.emit(a,b,this)},wsc.Client.prototype.middle=function(a,b){return this.mw.add(a,b)},wsc.Client.prototype.cascade=function(a,b,c){this.mw.run(a,b,c)},wsc.Client.prototype.connect=function(){if(!this.connected){this.attempts++;try{var a=this;this.conn=wsc.Transport.Create(this.settings.server),this.conn.open(function(b,c){a.flow.open(a,b,c)}),this.conn.disconnect(function(b){a.flow.close(a,b)}),this.conn.message(function(b){a.flow.message(a,b)}),this.conn.connect(),this.trigger("start",new wsc.Packet("client connecting\ne=ok\n\n"))}catch(b){console.log(b),this.trigger("start",new wsc.Packet("client connecting\ne=no websockets available\n\n"))}}},wsc.Client.prototype.close=function(a){this.conn.close(a)},wsc.Client.prototype.channel=function(a,b){return a=this.format_ns(a).toLowerCase(),this.channelo[a]?this.channelo[a]:b?(this.channelo[a]=b,b):null},wsc.Client.prototype.channels=function(a){var b=[];for(ns in this.channelo)this.channelo.hasOwnProperty(ns)&&(this.channelo[ns].hidden||b.push(this.channelo[ns].namespace));return a?b:b.length},wsc.Client.prototype.each_channel=function(a,b){var c=null;for(var d in this.channelo)if(this.channelo.hasOwnProperty(d)&&(c=this.channelo[d],(b||!this.exclude.contains(c.raw))&&a(c.raw,c)===!1))break},wsc.Client.prototype.deform_ns=function(a){var b=a[0];if("#"==b||"@"==b||"~"==b||"+"==b)return a;if(0==a.indexOf("chat:"))return"#"+a.slice(5);if(0==a.indexOf("server:"))return"~"+a.slice(7);if(0==a.indexOf("feed:"))return"#"+a.slice(5);if(0==a.indexOf("login:"))return"@"+a.slice(6);if(0==a.indexOf("pchat:")){var c=a.split(":");c.shift();for(i in c)if(name=c[i],name.toLowerCase()!=this.lun)return"@"+name}return"#"+a},wsc.Client.prototype.format_ns=function(a){var b=a.slice(1);switch(a[0]){case"@":var c=[b,this.lun];c.sort(caseInsensitiveSort),c.unshift("pchat"),a=c.join(":");break;case"~":a="server:"+b;break;case"+":a="feed:"+b;break;case"#":a="chat:"+b;break;default:if(0==a.indexOf("chat:")||0==a.indexOf("pchat:")||0==a.indexOf("server:")||0==a.indexOf("feed:"))break;a="chat:"+a}return a},wsc.Client.prototype.create_ns=function(a,b,c){var d=this.channel(a,new wsc.Channel(this,a,b,c));this.trigger("ns.create",{name:"ns.create",ns:a,chan:d,client:this}),d.build()},wsc.Client.prototype.remove_ns=function(a){a&&this.cascade("ns.remove",function(a){var b=a.client.channel(a.ns);b&&delete a.client.channelo[b.raw.toLowerCase()]},{ns:a,client:this})},wsc.Client.prototype.select_ns=function(a){this.cchannel=this.channel(a)||this.cchannel},wsc.Client.prototype.log=function(a,b){var c=this.channel(a);c&&c.log(b)},wsc.Client.prototype.monitor=function(a){console.log(a)},wsc.Client.prototype.mute_user=function(){},wsc.Client.prototype.unmute_user=function(){},wsc.Client.prototype.send=function(a){return this.conn.send(a)},wsc.Client.prototype.handshake=function(){this.send(wsc_packetstr(this.settings.client,this.settings.clientver,{agent:this.settings.agent,url:window.location.href,browser:navigator.userAgent}))},wsc.Client.prototype.login=function(){pkt="login "+this.settings.username+"\npk="+this.settings.pk+"\n",this.send(pkt)},wsc.Client.prototype.pong=function(){this.send(wsc_packetstr("pong"))},wsc.Client.prototype.join=function(a){this.send(wsc_packetstr("join",this.format_ns(a)))},wsc.Client.prototype.part=function(a){this.send(wsc_packetstr("part",this.format_ns(a)))},wsc.Client.prototype.say=function(a,b){var c=this;this.cascade("send.msg",function(a){c.send(wsc_packetstr("send",c.format_ns(a.ns),{},wsc_packetstr("msg","main",{},a.input)))},{input:b,ns:a})},wsc.Client.prototype.npmsg=function(a,b){var c=this;this.cascade("send.npmsg",function(a){c.send(wsc_packetstr("send",c.format_ns(a.ns),{},wsc_packetstr("npmsg","main",{},a.input)))},{input:b,ns:a})},wsc.Client.prototype.action=function(a,b){var c=this;this.cascade("send.action",function(a){c.send(wsc_packetstr("send",c.format_ns(a.ns),{},wsc_packetstr("action","main",{},a.input)))},{input:b,ns:a})},wsc.Client.prototype.promote=function(a,b,c){this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("promote",b,{},c?c:"")))},wsc.Client.prototype.demote=function(a,b,c){this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("demote",b,{},c?c:"")))},wsc.Client.prototype.ban=function(a,b){this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("ban",b)))},wsc.Client.prototype.unban=function(a,b){this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("unban",b)))},wsc.Client.prototype.kick=function(a,b,c){var d=this;this.cascade("send.kick",function(a){d.send(wsc_packetstr("kick",d.format_ns(a.ns),{u:a.user},a.input||null))},{input:c||"",ns:a,user:b})},wsc.Client.prototype.kill=function(a,b){this.send(wsc_packetstr("kill","login:"+a,{},b||null))},wsc.Client.prototype.admin=function(a,b){this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("admin","",{},b)))},wsc.Client.prototype.property=function(a,b){this.send(wsc_packetstr("get",this.format_ns(a),{p:b}))},wsc.Client.prototype.set=function(a,b,c){var d=this;this.cascade("send.set",function(a){d.send(wsc_packetstr("set",d.format_ns(a.ns),{p:a.property},a.input))},{input:c,ns:a,property:b})},wsc.Client.prototype.whois=function(a){this.send(wsc_packetstr("get","login:"+a,{p:"info"}))},wsc.Client.prototype.disconnect=function(){this.send(wsc_packetstr("disconnect"))},wsc.dAmn={},wsc.dAmn.VERSION="0.12.43",wsc.dAmn.STATE="alpha",wsc.dAmn.wsc=function(a){a.settings.client="dAmnClient",a.settings.clientver="0.3",a.settings.domain="deviantart.com",a.settings.agent+=" wsc/dAmn/"+wsc.dAmn.VERSION;var b=a.storage.folder("dAmn");b.bds=b.folder("bds"),b.emotes=b.folder("emotes"),b.colours=b.folder("colours");var c={emotes:{on:!1,emote:[]},colours:{on:!1,send:!1,msg:"000000",user:"000000"}};return c.save=function(){b.emotes.set("on",c.emotes.on),b.colours.set("on",c.colours.on),b.colours.set("send",c.colours.send),b.colours.set("msg",c.colours.msg),b.colours.set("user",c.colours.user)},c.load=function(){c.emotes.on="true"==b.emotes.get("on","false"),c.colours.on="true"==b.colours.get("on","false"),c.colours.send="true"==b.colours.get("send","false"),c.colours.msg=b.colours.get("msg",""),c.colours.user=b.colours.get("user","")},c.load(),c.save(),a.protocol.extend_maps({dAmnServer:["version"]}),a.protocol.mparser=new wsc.dAmn.TablumpParser,a.flow.dAmnServer=a.flow.chatserver,a.exclude.add("chat:devart"),a.exclude.add("chat:damnidlers"),wsc.dAmn.BDS(a,b.bds,c),wsc.dAmn.BDS.Link(a,b.bds,c),wsc.dAmn.BDS.Peer(a,b.bds,c),wsc.dAmn.wsc.Colours(a,b.colours,c),wsc.dAmn.wsc.Emotes(a,b.emotes,c),c},wsc.dAmn.chatterbox=function(a){var b=a.client,c={colours:{},emotes:{}};return a.on("settings.save",b.ext.dAmn.save),a.on("settings.close",b.ext.dAmn.load),a.protocol.extend_messages({dAmnServer:{keys:["version"],template:'<span class="servermsg">** Connected to dAmnServer {version} *</span>',global:!0}}),a.middle("user.hover",function(a,b){a.avatar=wsc.dAmn.avatar.link(a.name,a.member.usericon),a.member.realname&&-1==a.info.indexOf(a.member.realname)&&a.info.push(a.member.realname),a.member.typename&&-1==a.info.indexOf(a.member.typename)&&a.info.push(a.member.typename),b(a)}),a.on("log_whois.before",function(a){a.avatar=wsc.dAmn.avatar.link(a.raw.username,a.raw.usericon),a.username=a.raw.symbol+'<b><a href="http://'+a.raw.username+'.deviantart.com/">'+a.raw.username+"</a></b>",a.raw.realname&&a.info.push(a.raw.realname),a.raw.typename&&a.info.push(a.raw.typename)}),wsc.dAmn.chatterbox.Colours(b,a,c),wsc.dAmn.chatterbox.Emotes(b,a,c),wsc.dAmn.chatterbox.Stash(a,c),c},wsc.dAmn.tadpole=function(a,b){var c={};return wsc.dAmn.tadpole.Emotes(a,b,c),wsc.dAmn.tadpole.Stash(a,b,c),c},wsc.dAmn.BDS=function(a,b,c){var d={},e={};c.bds={version:"0.4",mns:"chat:datashare",gate:"chat:dsgateway",channel:new StringSet,provides:["BOTCHECK","CLINK"],versions:[],add_version:function(a,b){c.bds.versions.push({app:a,version:b})},app:function(){for(var a=[],b=0;b<c.bds.versions.length;b++)a.push(c.bds.versions[b].app);return a.join(".")},appv:function(){for(var a=[],b=0;b<c.bds.versions.length;b++)a.push(c.bds.versions[b].version);return a.join("/")}},a.bds=c.bds,c.bds.channel.add(c.bds.mns),c.bds.channel.add(c.bds.gate);var f=function(){a.hidden.add(c.bds.mns),a.exclude.add(c.bds.mns),a.hidden.add(c.bds.gate),a.exclude.add(c.bds.gate),a.bind("pkt.login",g),a.bind("pkt.recv_msg",h),a.bind("pkt.join",i.join),a.bind("BDS.BOTCHECK.DIRECT",i.botcheck),a.bind("BDS.BOTCHECK.ALL",i.botcheck),a.bind("BDS.BOTCHECK.OK",i.checkresp),a.bind("BDS.BOTCHECK.DENIED",i.checkresp),a.bind("CDS.LINK.REQUEST",i.clreq),a.bind("CDS.LINK.REJECT",i.clrj),a.bind("CDS.LINK.ACK",i.clra),a.bind("pkt.recv_join",i.pcrj),a.bind("pkt.recv_part",i.pcrp),a.bind("pkt.property",i.pcp),a.bind("closed",i.closed),a.middle("chan.recv_msg",function(a,b){i.hfilter(a,b)}),c.bds.add_version("wsc",wsc.VERSION),c.bds.add_version("dAmn",wsc.dAmn.VERSION)},g=function(b){"ok"==b.pkt.arg.e&&a.join(c.bds.gate)},h=function(b){if(b.user.toLowerCase()!=a.settings.username.toLowerCase()&&c.bds.channel.contains(b.ns)){var d={ns:b.ns,sns:b.sns,message:b.message,user:b.user,name:"",payload:"",head:[null,null,null],params:[]},e=b.message.split(":"),f=[null,null,null],g=null;for(var h in f)if(f[h]=e.shift()||null,null==f[h])return;g=e.join(":"),d.name=f.join("."),d.payload=g,d.head=f,d.param=g.split(","),a.trigger(f[0],d),a.trigger(f[0]+"."+f[1],d),a.trigger(d.name,d)}},i={filter:function(b,c){if(a.settings.developer)return void c(b);if("@"!=b.ns[0])return void c(b);var d=b.message.match(/<span class="cmsg u-([^"]+)">(.*)<\/span>/);return d?void(d[2].match(/^([A-Z0-9-_]+):([A-Z0-9-_]+):([A-Z0-9-_]+)(:.*|)$/)||c(b)):void c(b)},hfilter:function(b,c){return a.settings.developer?void c(b):"@"!=b.sns[0]?void c(b):void(b.message.match(/^([A-Z0-9-_]+):([A-Z0-9-_]+):([A-Z0-9-_]+)(:.*|)$/)||c(b))},closed:function(){a.remove_ns(c.bds.mns),a.remove_ns(c.bds.gate)},join:function(a){a.ns.toLowerCase()==c.bds.mns&&"ok"!=a.pkt.arg.e},botcheck:function(b){if(!("ALL"!=b.head[2]&&-1==b.payload.toLowerCase().indexOf(a.settings.username.toLowerCase())||b.ns.toLowerCase()==c.bds.gate&&null!=a.channel(c.bds.mns))){var d=c.bds.appv()+"/"+c.bds.version,e=c.bds.app(),f=CryptoJS.MD5((e+d+a.settings.username+b.user).toLowerCase());a.npmsg(b.ns,"BDS:BOTCHECK:CLIENT:"+b.user+","+e+","+d+","+f)}},checkresp:function(b){return b.ns.toLowerCase()==c.bds.gate&&b.param[0].toLowerCase()==a.settings.username.toLowerCase()?("Visitors"==a.channel(b.ns).info.members[a.settings.username].pc&&a.part(b.ns),"OK"==b.head[2]?void(null==a.channel(c.bds.mns)&&a.join(c.bds.mns)):void a.ui.pager.notice({ref:"botcheckdenied",heading:"BDS Error",content:"Denied entry to backend channel.\nReason provided: <code>"+b.param.slice(1).join(",")+"</code>"})):void 0},clreq:function(b){if(b.payload.toLowerCase()==a.settings.username.toLowerCase()){if(-1!=a.ui.umuted.indexOf(b.user.toLowerCase()))return void a.npmsg(b.ns,"CDS:LINK:REJECT:"+b.user+",You have been blocked");if(a.away.on){var c=new Date,d=(b.sns.toLowerCase(),timeLengthString((c-a.away.since)/1e3)),f=replaceAll(a.away.format.away,"{user}",b.user);return f=replaceAll(f,"{timesince}",d),void a.npmsg(b.ns,"CDS:LINK:REJECT:"+b.user+",Away; "+a.away.reason)}a.npmsg(b.ns,"CDS:LINK:ACK:"+b.user);var g=a.ui.pager.notice({ref:"clink-"+b.user,icon:'<img src="'+wsc.dAmn.avatar.src(b.user,a.channel(b.ns).info.members[b.user].usericon)+'" />',heading:"Chat "+b.user,content:b.user+" wants to talk in private.\nType <code>/chat "+b.user+"</code> to talk to them, or use the buttons below.",buttons:{accept:{ref:"accept",target:"accept",label:"Accept",title:"Join the private chat",click:function(){return a.ui.pager.remove_notice(g),a.join("@"+b.user),!1}},reject:{ref:"reject",target:"reject",label:"Reject",title:"Reject the private chat",click:function(){return a.npmsg(b.ns,"CDS:LINK:REJECT:"+b.user),a.ui.pager.remove_notice(g),!1}}}},!0);e[b.user]=g,g.onclose=function(){a.npmsg(b.ns,"CDS:LINK:REJECT:"+b.user)}}},clrj:function(b){var c=b.user.toLowerCase(),e=b.payload.split(","),f=e.shift();e=e.join(","),f.toLowerCase()==a.settings.username.toLowerCase()&&c in d&&(clearTimeout(d[c]),a.channel("@"+c).server_message("Chat request rejected",e))},clra:function(b){var c=b.user.toLowerCase(),e=b.payload.split(","),f=e.shift();f.toLowerCase()==a.settings.username.toLowerCase()&&clearTimeout(d[c])},pcp:function(b){if(0==b.ns.indexOf("pchat")&&!a.bds.channel.contains(b.ns)&&"members"==b.pkt.arg.p){if(2==a.channel(b.ns).get_usernames().length)return void a.bds.channel.add(b.ns);var c=b.sns.substr(1),e=b.ns;a.ui.channel(e).server_message(c+" has not yet joined","Sending them a notice..."),a.npmsg("chat:datashare","CDS:LINK:REQUEST:"+c),d[c.toLowerCase()]=setTimeout(function(){try{a.ui.channel(e).server_message("Notification failed",c+" does not seem to be using a client that supports pchat notices.")}catch(b){}},1e4)}},pcrj:function(b){if("@"==b.sns[0]){try{clearTimeout(d[b.user.toLowerCase()])}catch(c){}a.bds.channel.add(b.ns),b.user in e&&a.ui.pager.remove_notice(e[b.user])}},pcrp:function(b){"@"==b.sns[0]&&a.bds.channel.remove(b.ns)}};f()},wsc.dAmn.wsc.Colours=function(a,b,c){c.colours.send_colour=function(a,b){return c.colours.send?(a.input+='<abbr title="colors:'+c.colours.user+":"+c.colours.msg+'"></abbr>',void b(a)):void b(a)},a.middle("send.msg",c.colours.send_colour),a.middle("send.action",c.colours.send_colour)},wsc.dAmn.chatterbox.Colours=function(a,b,c){var d=a.ext.dAmn;c.colours.page=null,c.colours.configure_page=function(a){var b=a.settings.page("Colours");c.colours.page=b;var e={};e.on=d.colours.on,e.send=d.colours.send,e.msg=d.colours.msg,e.user=d.colours.user,b.item("Form",{ref:"switch",title:"Enable Chromacity Colours",text:"Here you can turn chromacity colours on and off.\n\nYou                    can choose to parse other people's colours, and send your                    own colours.",fields:[["Checkbox",{ref:"enabled",items:[{value:"parse",title:"Parse colours",selected:e.on},{value:"send",title:"Send colours",selected:e.send}]}]],event:{change:function(a){d.colours.on=-1!=a.data.enabled.indexOf("parse"),d.colours.send=-1!=a.data.enabled.indexOf("send")},save:function(){e.on=d.colours.on,e.send=d.colours.send},close:function(){d.colours.on=e.on,d.colours.send=e.send}}}),b.item("Form",{ref:"colours",title:"Custom Colours",text:"Here you can set your own username colour and message colour.",fields:[["Colour",{ref:"usr",label:"Username Colour","default":"#"+e.user}],["Colour",{ref:"msg",label:"Message Colour","default":"#"+e.msg}]],event:{change:function(a){d.colours.user=a.data.usr.substr(1).toUpperCase(),d.colours.msg=a.data.msg.substr(1).toUpperCase()},save:function(){e.user=d.colours.user,e.msg=d.colours.msg},close:function(){d.colours.user=e.user,d.colours.msg=e.msg,c.colours.page=null}}})},c.colours.parse_colour=function(a){if(d.colours.on){var b=a.item.find("abbr");if(0!=b.length){b=b.last();var c=b.prop("title").match(/colors:([A-F0-9]{6}):([A-F0-9]{6})/);null!=c&&(b.remove(),a.item.find(".cmsg, .caction").css("color","#"+c[2]),a.item.find(".cmsg.user, .caction.user").css("color","#"+c[1]))}}},b.on("settings.open",c.colours.configure_page),b.on("log_item.after",c.colours.parse_colour)},wsc.dAmn.Emotes={},wsc.dAmn.wsc.Emotes=function(a,b,c){c.emotes.emote={},c.emotes.fint=null,c.emotes.fetching=!1,c.emotes.loaded=!1,c.emotes.fetch=function(){c.emotes.loaded,c.emotes.fetching=!0,jQuery.getJSON("http://www.thezikes.org/publicemotes.php?format=jsonp&jsoncallback=?&"+(new Date).getDay(),function(b){c.emotes.fetching=!1,c.emotes.emote=b,c.emotes.loaded||c.emotes.on&&a.trigger("dAmn.emotes.loaded",{name:"dAmn.emotes.loaded"}),c.emotes.sort(),c.emotes.loaded=!0,c.emotes.fint=setTimeout(c.emotes.fetch,36e5)},function(){return!1})},c.emotes.swap=function(a,b){if(!c.emotes.on)return void b(a);var d=a.input.match(/:([\S]+):/g),e="",f=-1,g=function(a){return a!=d[f]};for(f in d)e=d[f],d=d.filter(g),c.emotes.emote.hasOwnProperty(e)&&(a.input=replaceAll(a.input,e,":thumb"+c.emotes.emote[e].devid+":"));a.input=replaceAll(a.input,":B",":bucktooth:"),b(a)},c.emotes.prepare=function(a){return a=replaceAll(a,"&","&amp;"),a=replaceAll(a,"<","&lt;"),a=replaceAll(a,">","&gt;"),replaceAll(a,'"',"&quot;")},c.emotes.repair=function(a){return a=replaceAll(a,"&quot;",'"'),a=replaceAll(a,"&lt;","<"),a=replaceAll(a,"&gt;",">"),replaceAll(a,"&amp;","&")},c.emotes.sort=function(){},c.emotes.select=function(b){a.ui.control.set_text(a.ui.control.get_text()+c.emotes.repair(b))},a.middle("send.msg",c.emotes.swap),a.middle("send.action",c.emotes.swap),a.middle("send.kick",c.emotes.swap),a.middle("send.set",c.emotes.swap),c.emotes.on&&c.emotes.fetch()},wsc.dAmn.chatterbox.Emotes=function(a,b,c){var d=a.ext.dAmn;c.emotes.page=null,c.emotes.configure_page=function(a){var b=a.settings.page("Emotes");c.emotes.page=b;var e={};e.on=d.emotes.on;var f="";e.on&&(f=!d.emotes.loaded||d.emotes.fetching?"<em>Fetching emotes...</em>":"<em>Emotes loaded.</em>"),b.item("Form",{ref:"switch",title:"Enable Emotes",text:"Here you can turn custom emotes on and off.",fields:[["Checkbox",{ref:"enabled",items:[{value:"yes",title:"On",selected:e.on}]}]],event:{change:function(a){return d.emotes.on=-1!=a.data.enabled.indexOf("yes"),d.emotes.picker.state(d.emotes.on),d.emotes.on?void d.emotes.fetch():void(null!==d.emotes.fint&&(clearTimeout(d.emotes.fint),d.emotes.fint=null))},save:function(){e.on=d.emotes.on,d.emotes.on&&!d.emotes.fetching},close:function(){d.emotes.on=e.on,d.load(),d.emotes.page=null,null!==d.emotes.fint&&(clearTimeout(d.emotes.fint),d.emotes.fint=null)}}})},b.on("settings.open",c.emotes.configure_page),a.bind("dAmn.emotes.loaded",function(){b.pager.notice({ref:"emotes-loaded",heading:"Emote CLOUD",content:"Emoticons from zike's Emote CLOUD have been loaded."},!1,5e3,!0)})},wsc.dAmn.Emotes.Tablumps=function(a){var b={id:a[0],thumb:a[4],server:parseInt(a[3]),flags:a[5].split(":"),dimensions:"",title:"",anchor:"",otitle:a[1]};b.flags[0]=parseInt(b.flags[0]),b.flags[1]=parseInt(b.flags[1]),b.flags[2]=parseInt(b.flags[2]);var c,d,e=b.thumb.match(/\.gif$/i),f=a[2].split("x"),g=parseInt(f[0]),h=parseInt(f[1]),i=(b.otitle.replace(/[^A-Za-z0-9]+/g,"-").replace(/^-+/,"").replace(/-+$/,"")||"-")+"-"+b.id;return b.title=b.otitle+", "+g+"x"+h,b.anchor='<a target="_blank" href="http://www.deviantart.com/art/'+i+'" title="'+b.title+'">',g/h>1?(d=parseInt(100*h/g),c=100):(c=parseInt(100*g/h),d=100),(c>g||d>h)&&(c=g,d=h),b.dimensions='width="'+c+'" height="'+d+'"',b.flags.push(e&&(g>200||h>200)),wsc.dAmn.Emotes.Thumb(b.id,b)},wsc.dAmn.Emotes.Thumb=function(a,b){b=Object.extend({title:"deviation by user",anchor:'<a href="http://url.com/devation__by_user.gif" target="_blank" title="deviation by user">',aclose:"</a>",thumb:"fs26/f/2008/160/b/2/deviation_by_username.gif",otitle:"deviation",flags:!1,dimensions:"",server:"1"},b||{});var c=!1,e=b.thumb.match(/\.gif$/i);if(b.flags){if(b.flags[1]>0)return b.anchor+"[mature deviation: "+b.otitle+"]"+b.aclose;if(b.flags[2]>0)return b.anchor+"[deviation: "+b.otitle+"]"+b.aclose;if(b.flags[3])return b.anchor+"[deviation: "+d.otitle+"]"+b.aclose;c=0==b.flags[0]}var f="";if(e){var g=b.thumb.replace(/:/,"/");f="http://fc0"+b.server+".deviantart.net/"+g;var h=g.split("/");return h.length>1&&(h=h["."],h&&h.length>2&&(f="http://"+b.thumb)),b.anchor+'<img class="thumb" title="'+b.title+'"'+b.dimensions+' alt=":thumb'+a+':" src="'+f+'" />'+b.aclose}return f="http://backend.deviantart.com/oembed?url=http://www.deviantart.com/deviation/"+a+"&format=thumb150",b.thumb.match(/.png$/i)&&(c=!1),b.anchor+'<img class="thumb'+(c?" shadow":"")+'"'+b.dimensions+' " alt=":thumb'+a+':" src="'+f+'" />'+b.aclose},wsc.dAmn.Emotes.Picker=function(a,b,c){b=b||{},b=Object.extend({title:"Emotes",event:{select:function(){},reload:function(){}}},b),Chatterbox.Popup.ItemPicker.call(this,a,b),this.settings=c,this.rbutton=null;for(var d="ABCDEFGHIJKLMNOPQRSTUVWXYZ",e="",f="",g=0;g<d.length;g++)e=d[g],f=e.toLowerCase(),this.add_page({ref:f,href:"#"+f,label:e,title:"Emotes beginning with "+e,items:[]},wsc.dAmn.Emotes.Page);this.add_page({ref:"misc",href:"#misc",label:"#",title:"Emotes not beginning with letters",items:[]},wsc.dAmn.Emotes.Page)},wsc.dAmn.Emotes.Picker.prototype.constructor=wsc.dAmn.Emotes.Picker,wsc.dAmn.Emotes.Picker.Disabled='<section class="pages">            <section class="disabled">                <p>The emote cloud is currently disabled.</p><p>To use emoticons from                the cloud, click the button below to enable them.</p><p>                <a href="#enable" class="button text">Enable</a>                </p>            </section>            </section>            <section class="buttons"></section>',wsc.dAmn.Emotes.Picker.prototype.state=function(a){this.settings.emotes.on=a||!1,this.rebuild(),this.refresh()},wsc.dAmn.Emotes.Picker.prototype.hide=function(){this.window.css({display:"none"})},wsc.dAmn.Emotes.Picker.prototype.show=function(){this.window.css({display:"block"}),this.refresh()},wsc.dAmn.Emotes.Picker.prototype.close=function(){this.hide()},wsc.dAmn.Emotes.Picker.prototype.build=function(a){Chatterbox.Popup.ItemPicker.prototype.build.call(this,a),this.rebuild()},wsc.dAmn.Emotes.Picker.prototype.rebuild=function(){var a=this;if(this.window.find(".inner .content").html(""),this.options.content=this.settings.emotes.on?Chatterbox.render("ip.main"):wsc.dAmn.Emotes.Picker.Disabled,this.window.find(".inner .content").html(this.options.content),this.pbook=this.window.find("section.pages"),this.buttons=this.window.find("section.buttons"),this.rbutton=this.add_button({href:"#reload",title:"Reload emoticons",label:"Reload"}),this.settings.emotes.fetching&&this.loading("Loading..."),this.settings.emotes.on||this.loading("Disabled"),this.rbutton.click(function(){return a.settings.emotes.on?a.settings.emotes.fetching?!1:a.rbutton.hasClass("evented")?!1:(a.reload(),!1):!1}),this.settings.emotes.on){this.tabs=this.window.find("section.tabs ul");var b=null;for(var c in this.pages)this.pages.hasOwnProperty(c)&&(b=this.pages[c],b.build(),0==c&&this.select_page(b))}else this.dis=this.pbook.find(".disabled"),this.dis.css({"max-width":330}),this.dis.find("p").css({margin:"5px 10px 5px 10px"}),this.dis.find("p").last().css({"text-align":"center","margin-top":25,"margin-bottom":25}),this.dis.find("p").first().css({"margin-top":25}),this.window.find("a[href=#enable].button").click(function(){return a.state(!0),a.settings.emotes.fetch(),a.settings.save(),!1})},wsc.dAmn.Emotes.Picker.prototype.loaded=function(){this.rbutton.html("Reload"),this.rbutton.removeClass("evented")},wsc.dAmn.Emotes.Picker.prototype.loading=function(a){a=a||"Reloading...",this.rbutton.addClass("evented"),this.rbutton.html(a)},wsc.dAmn.Emotes.Picker.prototype.reload=function(){this.loading(),this.options.event.reload()},wsc.dAmn.Emotes.Page=function(){Chatterbox.Popup.ItemPicker.Page.apply(this,arguments)},wsc.dAmn.Emotes.Page.prototype.constructor=wsc.dAmn.Emotes.Page,wsc.dAmn.Emotes.Page.prototype.refresh=function(){if(this.picker.settings.emotes.on){Chatterbox.Popup.ItemPicker.Page.prototype.refresh.call(this);var a=this;a.view.find("span.thumb img").error(function(){var b=a.view.find(this),c=b.parent().parent(),d=a.picker.settings.emotes.repair(c.find(".value").html());return delete a.picker.settings.emotes.emote[d],c.remove(),!1}),a.view.find("span.thumb img").load(function(){var b,c,d=a.view.find(this),e=d.width(),f=d.height();e/f>1?(b=parseInt(100*f/e),c=100):(c=parseInt(100*e/f),b=100),(c>e||b>f)&&(c=e,b=f),d.css({height:b,width:c}),d.parent().css({"float":"right",display:"block"})})}},wsc.dAmn.tadpole.Emotes=function(a,b){var c=b.menu.settings.add("emotes","CLOUD Emotes",function(){g(),a.ext.dAmn.save(),f()});c.button.append(' <span class="switch red">Off</span> <span class="note faint">turn on</span>');var d=c.button.find(".switch"),e=c.button.find(".note"),f=function(){return a.ext.dAmn.emotes.on?(d.hasClass("red")&&(d.removeClass("red"),d.addClass("green")),d.text("On"),void e.text("turn off")):(d.hasClass("green")&&(d.removeClass("green"),d.addClass("red")),d.text("Off"),void e.text("turn on"))},g=function(){var b=a.ext.dAmn.emotes.on;return a.ext.dAmn.emotes.on=!b,a.ext.dAmn.emotes.on?void a.ext.dAmn.emotes.fetch():void(null!==a.ext.dAmn.emotes.fint&&(clearTimeout(a.ext.dAmn.emotes.fint),a.ext.dAmn.emotes.fint=null))};f()},wsc.dAmn.avatar={},wsc.dAmn.avatar.ext=["gif","gif","jpg","png"],wsc.dAmn.avatar.link=function(a,b){var c=wsc.dAmn.avatar.src(a,b);return'<a target="_blank" title=":icon'+a+':" href="http://'+a+'.deviantart.com/"><img class="avatar"            alt=":icon'+a+':" src="'+c+'" height="50" /></a>'},wsc.dAmn.avatar.src=function(a,b){b=parseInt(b);var c=b>>2&15;b=3&b;var d=wsc.dAmn.avatar.ext[b]||"gif",e="default";if(c=c?"?"+c:"",0!=b){var f=new RegExp("\\$un(\\[([0-9]+)\\])","g"),e="$un[0]/$un[1]/{un}".replace(f,function(b,c,d){return"-"==a[d]?"_":a[d].toLowerCase()});e=replaceAll(e,"{un}",a.toLowerCase())}return"http://a.deviantart.net/avatars/"+e+"."+d+c},wsc.dAmn.BDS.Link=function(a,b,c){var d=function(){a.bind("BDS",e.cmd),a.bind("BDS.LINK.REQUEST",e.request),a.bind("BDS.LINK.REJECT",e.reject),a.bind("BDS.LINK.ACCEPT",e.accept),a.bind("BDS.LINK.CLOSE",e.close),a.bind("pkt.join",e.join),a.bind("pkt.part",e.part),a.bind("pkt.recv_join",e.recv_join),a.bind("pkt.recv_part",e.recv_part)};c.bds.link={white:new StringSet,connections:{},state:{closed:0,opening:1,open:2},conn:function(b,d,e,f){if(b=b.toLowerCase(),b in c.bds.link.connections)return c.bds.link.connections[b];var g=a.format_ns("@"+b),h={state:c.bds.link.state.closed,ns:g,un:b,close:function(){c.bds.link.close(h.un)},send:function(b){return h.state!=c.bds.link.state.open?!1:(a.npmsg(h.ns,b),!0)},oncmd:d||function(){},onopen:e||function(){},onclose:f||function(){}};return h},request:function(b,d,e){var f=c.bds.link.open(b,e);return null==f?null:d===!0?f:(a.npmsg(c.bds.mns,"BDS:LINK:REQUEST:"+b),f)},open:function(b,d){if(b=b.toLowerCase(),b in c.bds.link.connections)return null;var e=c.bds.link.conn(b,d);return e.state=c.bds.link.state.opening,c.bds.link.connections[b]=e,c.bds.channel.add(e.ns),a.hidden.add(e.ns),a.exclude.add(e.ns),a.join(e.ns),e},close:function(b,d){if(b=b.toLowerCase(),!(b in c.bds.link.connections))return!1;var e=c.bds.link.conn(b);return d!==!0&&e.send("BDS:LINK:CLOSE"),a.part(e.ns),e.state=c.bds.link.state.closed,!0}};var e={cmd:function(b){c.bds.channel.contains(b.ns)&&"@"==b.sns[0]&&c.bds.link.conn(b.sns.substr(1)).oncmd(b,a)},request:function(b){if(b.payload.toLowerCase()==a.settings.username.toLowerCase()){var d=a.channel(b.ns).info.members[b.user];if(parseInt(a.channel(b.ns).get_privclass_order(d.pc))<39&&!c.bds.link.white.contains(b.user))return void a.npmsg(b.ns,"BDS:LINK:REJECT:"+b.user);c.bds.link.open(b.user),a.npmsg(b.ns,"BDS:LINK:ACCEPT:"+b.user)}},reject:function(a){var b=a.user.toLowerCase();b in c.bds.link.connections&&c.bds.link.connections[b].close()},accept:function(b){b.payload.toLowerCase()==a.settings.username.toLowerCase()&&c.bds.link.open(b.user)},close:function(a){c.bds.link.close(a.user,!0)},join:function(b){if("ok"==b.pkt.arg.e&&c.bds.channel.contains(b.ns)){var d=c.bds.link.conn(b.sns.substr(1));if(1!=a.channel(b.ns).get_usernames().length){d.state=c.bds.link.state.open;var e={name:"BDS.LINK.OPEN",link:d,ns:d.ns};d.onopen(e,a),a.trigger("BDS.LINK.OPEN",e)}}},part:function(b){if(c.bds.channel.contains(b.ns)){var d=c.bds.link.conn(b.sns.substr(1));d.state=c.bds.link.state.closed;var e={name:"BDS.LINK.CLOSED",link:d,ns:d.ns};d.onclose(e,a),a.trigger("BDS.LINK.CLOSED",e),delete c.bds.link.connections[d.un]}},recv_join:function(b){if(c.bds.channel.contains(b.ns)){var d=c.bds.link.conn(b.sns.substr(1));if(d.state==c.bds.link.state.opening){d.state=c.bds.link.state.open;var e={name:"BDS.LINK.OPEN",link:d,ns:d.ns};d.onopen(e,a),a.trigger("BDS.LINK.OPEN",e)}}},recv_part:function(a){if(c.bds.channel.contains(a.ns)){var b=c.bds.link.conn(a.sns.substr(1));b.close(!0)}}};d()},wsc.dAmn.Stash={},wsc.dAmn.Stash.dimensions=function(a){var b,c,d=a.thumbnail_width,e=a.thumbnail_height;
return d/e>1?(c=parseInt(100*e/d),b=100):(b=parseInt(100*d/e),c=100),(b>d||c>e)&&(b=d,c=e),{height:e,width:d,thumb:{height:c,width:b}}},wsc.dAmn.Stash.Cache=function(){this.item={};var a=this;setInterval(function(){a.uncache()},3e5)},wsc.dAmn.Stash.Cache.prototype.uncache=function(){var a=(new Date).getTime();for(var b in this.item)this.item.hasOwnProperty(b)&&(a-this.item[b].time<36e5||delete this.item[b])},wsc.dAmn.Stash.Cache.prototype.get=function(a,b){var c=this.item[a];if(c)return void b(c);c={id:a,url:"http://sta.sh/"+a,time:(new Date).getTime(),html:null,data:null};var d=this,e=function(e){return c.data=e,d.item[a]=c,"error"in e||"photo"!=e.type?b(c):(c.html=wsc.dAmn.Stash.item_html(c.url,e),void b(c))};$.getJSON("http://backend.deviantart.com/oembed?url="+c.url+"&format=jsonp&callback=?",function(a){e(a)})},wsc.dAmn.Stash.cache=new wsc.dAmn.Stash.Cache,wsc.dAmn.Stash.item_html=function(a,b){var c=wsc.dAmn.Stash.dimensions(b),d=(c.width,c.height,b.title+" by "+b.author_name),e='<a class="stashlink" target="_blank" href="'+a+'" title="'+d+'">',f='width="'+c.thumb.width+'" height="'+c.thumb.height+'"',g=a.split("/").pop();return'<span class="stashthumb" id="'+g+'">'+e+'<img class="smaller thumb"'+f+' " alt="'+a+'" src="'+b.thumbnail_url_150+'" />        </a></span>'},wsc.dAmn.chatterbox.Stash=function(a){var b=function(){a.on("log_item.after",c.log_item)},c={log_item:function(a){var b=a.item.find('a[href^="http://sta.sh"]'),c=[];if(b.each(function(b,d){c.push(a.item.find(d))}),0!=c.length){var d=function(){return 0==c.length?(a.chan.st+=a.item.height(),a.chan.el.l.w.scrollTop(a.chan.st),void a.chan.scroll()):void e(c.pop())},e=function(a){if(!a)return d();var b=a.prop("href");if(!b)return d();b=b.split("/");var c=b[b.length-1];wsc.dAmn.Stash.cache.get(c,function(b){return b&&b.html?(wsc.dAmn.chatterbox.Stash.render(a,b),void d()):d()})};e(c.pop())}}};b()},wsc.dAmn.chatterbox.Stash.render=function(a,b){a.replaceWith(b.html)},wsc.dAmn.tadpole.Stash=function(a,b){var c=function(){b.middle("ns.log",function(a,b){var c=$(a.content).find('a[href^="http://sta.sh"]'),d=[];if(c.each(function(a,b){d.push($(b))}),0==d.length)return b(a);var e=function(){return 0==d.length?b(a):void f(d.pop())},f=function(b){if(!b)return e();var c=b.prop("href"),d=$("<span></span>").append(b).html();if(!c)return e();c=c.split("/");var f=c[c.length-1];wsc.dAmn.Stash.cache.get(f,function(b){return b&&b.html?(a.content=replaceAll(a.content,d,b.html),void e()):e()})};f(d.pop())})};c()},wsc.dAmn.tadpole.Stash.replace=function(a,b,c,d){if("error"in c)return d(a);if("photo"!=c.type)return d(a);var e="http://sta.sh/"+b[1];a.content=replaceAll(a.content,b[0],wsc.dAmn.Stash.item_html(e,c)),d(a)},wsc.dAmn.TablumpString=function(a,b){this._parser=b||new wsc.dAmn.Tablumps,this.tokens=this._parser.tokenise(a),this.raw=a,this._text=null,this._html=null,this._ansi=null,this._chonc=null},wsc.dAmn.TablumpString.prototype=new wsc.MessageString,wsc.dAmn.TablumpString.prototype.constructor=wsc.dAmn.TablumpString,wsc.dAmn.TablumpString.prototype=new String)constructor=wsc.dAmn.TablumpString,toString=valueOf=function(){return this.raw};wsc.dAmn.TablumpString.prototype.html=function(){return null==this._html&&(this._html=this._parser.render(1,this)),this._html},wsc.dAmn.TablumpString.prototype.text=function(){return null==this._text&&(this._text=this._parser.render(0,this)),this._text},wsc.dAmn.TablumpString.prototype.ansi=function(){return null==this._ansi&&(this._ansi=this._parser.render(3,this)),this._ansi},wsc.dAmn.TablumpString.prototype.chonc=function(){return null==this._chonc&&(this._chonc=this._parser.render(2,this)),this._chonc},wsc.dAmn.PARSE={RAW:0,TAG:1,ARG:2},wsc.dAmn.TablumpParser=function(){this.lumps=this.defaultMap()},wsc.dAmn.TablumpParser.prototype=new wsc.MessageParser,wsc.dAmn.TablumpParser.prototype.constructor=wsc.dAmn.TablumpParser,wsc.dAmn.TablumpParser.prototype.registerMap=function(a){this.lumps=a},wsc.dAmn.TablumpParser.prototype.extend=function(a){for(index in a)this.lumps[index]=a[index]},wsc.dAmn.TablumpParser.prototype.defaultMap=function(){return{"&b	":[0,"<b>","<b>","<b>","[1m"],"&/b	":[0,"</b>","</b>","</b>","[22m"],"&i	":[0,"<i>","<i>","<i>","[3m"],"&/i	":[0,"</i>","</i>","</i>","[23m"],"&u	":[0,"<u>","<u>","<u>","[4m"],"&/u	":[0,"</u>","</u>","</u>","[24m"],"&s	":[0,"<s>","<s>","<s>","[9m"],"&/s	":[0,"</s>","</s>","</s>","[29m"],"&sup	":[0,"<sup>"],"&/sup	":[0,"</sup>"],"&sub	":[0,"<sub>"],"&/sub	":[0,"</sub>"],"&code	":[0,"<code>"],"&/code	":[0,"</code>"],"&p	":[0,"<p>"],"&/p	":[0,"</p>"],"&ul	":[0,"<ul>"],"&/ul	":[0,"</ul>"],"&ol	":[0,"<ol>"],"&li	":[0,"<li>"],"&/li	":[0,"</li>"],"&/ol	":[0,"</ol>"],"&link	":[3,function(a){return a[0]+(a[1]?" ("+a[1]+")":"")},function(a){return t=a[1],'<a target="_blank" href="'+a[0]+'" title="'+(t||a[0])+'">'+(t||"[link]")+"</a>"},function(a){return t=a[1],'<a target="_blank" href="'+a[0]+'" title="'+(t||a[0])+'">'+(t||"[link]")+"</a>"}],"&acro	":[1,'<acronym title="{0}">'],"&/acro	":[0,"</acronym>"],"&abbr	":[1,'<abbr title="{0}">'],"&/abbr	":[0,"</abbr>"],"&img	":[3,'<img src="{0}" alt="{1}" title="{2}" />'],"&iframe	":[3,'<iframe src="{0}" width="{1}" height="{2}" />'],"&/iframe	":[0,"</iframe>"],"&a	":[2,'<a href="{0}" title="{1}">'],"&/a	":[0,"</a>"],"&br	":[0,"<br/>"],"&bcode	":[0,"<bcode>","<span><pre><code>"],"&/bcode	":[0,"</bcode>","</code></pre></span>"],"&avatar	":[2,":icon{0}:",function(a){return wsc.dAmn.avatar.link(a[0],a[1])}],"&emote	":[5,"{0}",'<img alt="{0}" width="{1}" height="{2}" title="{3}" src="http://e.deviantart.com/emoticons/{4}" />'],"&dev	":[2,":dev{1}:",'{0}<a target="_blank" alt=":dev{1}:" href="http://{1}.deviantart.com/">{1}</a>','{0}<a target="_blank" alt=":dev{1}:" href="http://{1}.deviantart.com/">{1}</a>',"{0}[36m{1}[39m"],"&thumb	":[6,":thumb{0}:",wsc.dAmn.Emotes.Tablumps,function(a){var b=(a[1].replace(/[^A-Za-z0-9]+/g,"-").replace(/^-+/,"").replace(/-+$/,"")||"-")+"-"+a[0],c='[<a target="_blank" href="http://www.deviantart.com/art/'+b+'" title="'+a[1]+'">';return c+"deviation: "+a[1]+"</a>]"},"[deviation: {1}]"],EOF:[0,"",null,null,"[m"]}},wsc.dAmn.TablumpParser.prototype.parse=function(a){return a=replaceAll(a,"<","&lt;"),a=replaceAll(a,">","&gt;"),new wsc.dAmn.TablumpString(a,this)},wsc.dAmn.TablumpParser.prototype.tokenise=function(a){if(!a)return[];for(var b=wsc.dAmn.PARSE.RAW,c=[],d="",e=0,f=[],g="",h="",i=0;i<a.length;i++)switch(h=a[i],b){case wsc.dAmn.PARSE.RAW:if("&"!=h){g+=h;break}d=h,b=wsc.dAmn.PARSE.TAG;break;case wsc.dAmn.PARSE.TAG:d+=h,(" "==h||"	"==h||"&"==h)&&(" "!=h&&"&"!=h&&this.lumps.hasOwnProperty(d)?(g.length>0&&(c.push(["raw",g]),g=""),f=[d,[]],e=this.lumps[d][0],c.push(f),d="",b=e>0?wsc.dAmn.PARSE.ARG:wsc.dAmn.PARSE.RAW):(g+=d,d="","&"==h&&(i--,g=g.substr(0,g.length-1)),b=wsc.dAmn.PARSE.RAW));break;case wsc.dAmn.PARSE.ARG:if("	"==h){if(e--,"&"==d){b=wsc.dAmn.PARSE.RAW,d="";break}f[1].push(d),d="",0==e&&(b=wsc.dAmn.PARSE.RAW);break}d+=h}return(g.length>0||d.length>0)&&c.push(["raw",g+d]),c},wsc.dAmn.TablumpParser.prototype.render=function(a,b){if(!b)return"";if(!b.hasOwnProperty("tokens"))return"";a+=1;var c="",d=[];for(var e in b.tokens)b.tokens.hasOwnProperty(e)&&(d=b.tokens[e],c+="raw"!=d[0]?this.renderOne(a,d[0],d[1]):d[1]);return c+this.renderOne(a,"EOF","")},wsc.dAmn.TablumpParser.prototype.renderOne=function(a,b,c){var d=this.lumps[b];if(void 0===d)return"&"+b+"	"+c.join("	");var e=d[a]||d[1];return"string"==typeof e?String.format(e,c):e.call(this,c)},wsc.dAmn.BDS.Peer=function(a,b,c){var d=function(){new wsc.dAmn.BDS.Peer.SignalHandler(a)};c.bds.peer={handler:null,calls:{},call:function(a){a=a.toLowerCase();for(var b in c.bds.peer.calls)if(c.bds.peer.calls.hasOwnProperty(b)&&b.toLowerCase()==a)return c.bds.peer.calls[b];return null},open:function(b,d,e,f,g,h){return c.bds.peer.call(d)||(c.bds.peer.calls[d]=new wsc.dAmn.BDS.Peer.Call(a,b,d,e,f,g,h)),c.bds.peer.calls[d]},remove:function(a){var b=c.bds.peer.call(a);b&&delete c.bds.peer.calls[a]},request:function(){}},d()},wsc.dAmn.BDS.Peer.bots=["botdom","damnphone"],wsc.dAmn.BDS.Peer.peer_options={iceServers:[{url:"stun:stun.l.google.com:19302"}]},wsc.dAmn.BDS.Peer.phone=null,wsc.dAmn.BDS.Peer.signal=null,wsc.dAmn.BDS.Peer.local={},wsc.dAmn.BDS.Peer.local.stream=null,wsc.dAmn.BDS.Peer.local.url=null,wsc.dAmn.BDS.Peer.remote={},wsc.dAmn.BDS.Peer.remote._empty={video:null,audio:null,conn:null},wsc.dAmn.BDS.Peer.chan={},wsc.dAmn.BDS.Peer.chan.group=!1,wsc.dAmn.BDS.Peer.chan.calls=[],wsc.dAmn.BDS.Peer.Call=function(a,b,c,d,e,f,g,h){this.client=a,this.bds=b,this.ns="",this.pns=c,this.user=d,this.app=e,this.app_ver=f,this.title="",this.pc="",this.localstream=null,this.localurl=null,this.constraints=g,this.peers={},this.closing=!1,this.timeout=null,this.group="chat:"==d.substr(0,5);var i=this.pns.split(":"),j=i.shift();"chat"==j?this.ns="chat:"+i.shift():"pchat"==j&&(this.ns="pchat:"+i.shift()+":"+i.shift()),"pc"==i[0]&&(i.shift(),this.pc=i.shift()),this.title=i.join(":"),this.group=-1!=wsc.dAmn.BDS.Peer.bots.indexOf(this.ns.substr(1)),this.signal=new wsc.dAmn.BDS.Peer.SignalChannel(a,this,b,c,e,f),this.onlocalstream=function(){},h&&(this.localstream=h,this.localurl=URL.createObjectURL(h)),this.onclose=function(){};var k=this;this._closed=function(){k.onclose()},k.ontimeout=function(){}},wsc.dAmn.BDS.Peer.Call.prototype.timedout=function(){this.timeout=null,this.ontimeout(),this.close()},wsc.dAmn.BDS.Peer.Call.prototype.set_local_stream=function(a){this.localstream=a,this.localurl=URL.createObjectURL(a),this.onlocalstream()},wsc.dAmn.BDS.Peer.Call.prototype.close=function(){if(!this.closing){this.closing=!0,this.signal.close();for(var a in this.peers)this.peers.hasOwnProperty(a)&&this.remove(a);this.client.bds.peer.remove(this.pns),this._closed(),this.closing=!1}},wsc.dAmn.BDS.Peer.Call.prototype.new_peer=function(a,b){var c=wsc.dAmn.BDS.peer_connection(this,a,b,this.constraints,this.localstream);return this.peers[a]=c,c},wsc.dAmn.BDS.Peer.Call.prototype.peer=function(a){return this.peers[a]||null},wsc.dAmn.BDS.Peer.Call.prototype.remove=function(a){var b=this.peer(a);b&&(delete this.peers[b],b.close())},wsc.dAmn.BDS.peer_connection=function(a,b,c,d){return wsc.dAmn.BDS.Peer.RTC.PeerConnection?new wsc.dAmn.BDS.Peer.Connection(a,b,c,d):null},wsc.dAmn.BDS.Peer.Connection=function(a,b,c,d,e){this.call=a,this.user=b,this.pc=new wsc.dAmn.BDS.Peer.RTC.PeerConnection(wsc.dAmn.BDS.Peer.peer_options,d),this.offer="",this.remote_offer=c||null,this.remote_set=!1,this.responding=null!=this.remote_offer,this.streamed=!1,this.remote_stream=null,this.stream=null,this.connected=!1,this.bindings(),this.remote_offer&&this.set_remote_description(this.remote_offer),e&&this.set_local_stream(e)},wsc.dAmn.BDS.Peer.Connection.prototype.bindings=function(){{var a=this;this.user}this.pc.onicecandidate=function(b){a.call.signal.candidate(a,b.candidate)},this.pc.onaddstream=function(b){a.set_remote_stream(b)},this.pc.onnegotiationneeded=function(b){a.onnegotiationneeded(b)},this.pc.onclose=function(){a._closed()};var b=function(){};this.onready=b,this.onopen=b,this.onclose=b,this.onreject=b,this.onremotedescription=b,this.onlocaldescription=b,this.onicecompleted=b,this.onremotestream=b,this.onlocalstream=b,this.onnegotiationneeded=b},wsc.dAmn.BDS.Peer.Connection.prototype.close=function(){try{this.pc.close()}catch(a){}this._closed()},wsc.dAmn.BDS.Peer.Connection.prototype._closed=function(){this.onclose()},wsc.dAmn.BDS.Peer.Connection.prototype.reject=function(a){this.onreject(a),this.call.remove(this.user)},wsc.dAmn.BDS.Peer.Connection.prototype.onerror=function(a){console.log(">> Got an error:",'"',a.message,'"',a)},wsc.dAmn.BDS.Peer.Connection.prototype.candidate=function(a){this.pc.addIceCandidate(a)},wsc.dAmn.BDS.Peer.Connection.prototype.ice_completed=function(){this.onicecompleted()},wsc.dAmn.BDS.Peer.Connection.prototype.create_offer=function(){var a=this;this.pc.createOffer(function(b){a.offer_created(b)},function(b){a.onerror(b)})},wsc.dAmn.BDS.Peer.Connection.prototype.offer_created=function(a){this.offer=a;var b=this;this.pc.setLocalDescription(this.offer,function(){b.local_description_set(0)},this.onerror)},wsc.dAmn.BDS.Peer.Connection.prototype.set_remote_description=function(a,b){this.remote_offer=a,this.responding="stable"==this.pc.signalingState;var c=this;this.pc.setRemoteDescription(this.remote_offer,function(){c.remote_description_set(b)},this.onerror)},wsc.dAmn.BDS.Peer.Connection.prototype.local_description_set=function(a){this.responding&&(this.connected=!0,this.responding=!1),this.onlocaldescription(a)},wsc.dAmn.BDS.Peer.Connection.prototype.remote_description_set=function(a){this.responding=0==a,this.remote_set=!0,this.responding||(this.connected=!0),this.onremotedescription(a)},wsc.dAmn.BDS.Peer.Connection.prototype.create_answer=function(){var a=this;this.responding=!0,this.pc.createAnswer(function(b){a.answer_created(b)},function(b){a.onerror(b)})},wsc.dAmn.BDS.Peer.Connection.prototype.answer_created=function(a){this.offer=a;var b=this;this.pc.setLocalDescription(this.offer,function(){b.local_description_set(1)},function(a){b.onerror(a)})},wsc.dAmn.BDS.Peer.Connection.prototype.set_remote_stream=function(a){this.remote_stream=a.stream,this.onremotestream()},wsc.dAmn.BDS.Peer.Connection.prototype.set_local_stream=function(a){this.pc.addStream(a),this.stream=a,this.onlocalstream()},wsc.dAmn.BDS.Peer.Connection.prototype.persist=function(){var a=this,b=this.call;a.onremotedescription=function(b){0==b&&a.create_answer()},a.onlocaldescription=function(c){switch(c){case 0:b.signal.offer(a);break;case 1:b.signal.answer(a)}},a.onnegotiationneeded=function(){a.create_offer()}},wsc.dAmn.BDS.Peer.SignalChannel=function(a,b,c,d,e,f){this.user=a.settings.username,this.nse=ns?","+ns:"",this.bds=c,this.pns=d,this.ns=ns,this.app=e,this.app_ver=f,this.client=a,this.call=b},wsc.dAmn.BDS.Peer.SignalChannel.prototype.command=function(){for(var a=Array.prototype.slice.call(arguments),b=a.shift(),c=this.pns,d=0;d<a.length;d++)a.hasOwnProperty(d)&&a[d]&&(c+=","+a[d]);this.client.npmsg(this.bds,"BDS:PEER:"+b+":"+c)},wsc.dAmn.BDS.Peer.SignalChannel.prototype.request=function(a,b){var c=this.call;c.timeout=setTimeout(function(){c.timedout()},1e4),this.command("REQUEST",this.user,a||this.app,(b||this.app_ver).toString())},wsc.dAmn.BDS.Peer.SignalChannel.prototype.ack=function(a,b,c){this.command("ACK",a,b||this.app,(c||this.app_ver).toString())},wsc.dAmn.BDS.Peer.SignalChannel.prototype.accept=function(a,b,c){this.command("ACCEPT",a,b||this.app,(c||this.app_ver).toString())},wsc.dAmn.BDS.Peer.SignalChannel.prototype.offer=function(a){this.command("OFFER",this.user,a.user,JSON.stringify(a.offer))},wsc.dAmn.BDS.Peer.SignalChannel.prototype.answer=function(a){this.command("ANSWER",this.user,a.user,JSON.stringify(a.offer))},wsc.dAmn.BDS.Peer.SignalChannel.prototype.candidate=function(a,b){this.command("CANDIDATE",this.user,a.user,JSON.stringify(b))},wsc.dAmn.BDS.Peer.SignalChannel.prototype.reject=function(a,b){this.command("REJECT",a,b)},wsc.dAmn.BDS.Peer.SignalChannel.prototype.close=function(a){this.command("CLOSE",a||this.user)},wsc.dAmn.BDS.Peer.SignalChannel.prototype.list=function(a){a=a?":"+a:"",this.client.npmsg(this.bds,"BDS:PEER:LIST"+a)},wsc.dAmn.BDS.Peer.SignalHandler=function(a){var b=this;a.bind("BDS.PEER.REQUEST",function(a,c){b.request(a,c)}),a.bind("BDS.PEER.ACK",function(a,c){b.ack(a,c)}),a.bind("BDS.PEER.REJECT",function(a,c){b.reject(a,c)}),a.bind("BDS.PEER.ACCEPT",function(a,c){b.accept(a,c)}),a.bind("BDS.PEER.OPEN",function(a,c){b.open(a,c)}),a.bind("BDS.PEER.END",function(a,c){b.end(a,c)}),a.bind("BDS.PEER.OFFER",function(a,c){b.offer(a,c)}),a.bind("BDS.PEER.ANSWER",function(a,c){b.answer(a,c)}),a.bind("BDS.PEER.CANDIDATE",function(a,c){b.candidate(a,c)}),a.bind("BDS.PEER.CLOSE",function(a,c){b.close(a,c)})},wsc.dAmn.BDS.Peer.SignalHandler.prototype.request=function(a,b){if("@"==a.sns[0]){var c=a.param[0],d=a.param[1],e=a.param[2],f=parseInt(a.param[3]),g=b.bds.peer.call(c);g||(g=b.bds.peer.open(a.ns,c,d,e,f)),g.signal.ack(d,e,f);var h=g.peer(d);return h||(h=g.new_peer(d)),b.trigger("peer.request",{name:"peer.request",ns:a.ns,call:g,user:d,app:e,version:f,peer:h}),!0}},wsc.dAmn.BDS.Peer.SignalHandler.prototype.ack=function(a,b){if("@"==a.sns[0]){var c=b.bds.peer.call(a.param[0]);if(c){{a.param[1],a.param[2],parseInt(a.param[3])}null!=c.timeout&&(clearTimeout(c.timeout),c.timeout=null)}}},wsc.dAmn.BDS.Peer.SignalHandler.prototype.reject=function(a,b){if("@"==a.sns[0]){var c=b.bds.peer.call(a.param[0]),d=a.param[1],e=a.param[2];if(c&&d.toLowerCase()==b.settings.username.toLowerCase()){var f=c.peer(a.user);f||(f=c.new_peer(a.user)),f.reject(e),b.trigger("peer.reject",{name:"peer.reject",ns:a.ns,pns:a.param[0],user:a.user,reason:e})}}},wsc.dAmn.BDS.Peer.SignalHandler.prototype.accept=function(a,b){if("@"==a.sns[0]){var c=b.bds.peer.call(a.param[0]);if(c){var d=a.param[1],e=a.param[2],f=parseInt(a.param[3]);if(d.toLowerCase()==b.settings.username.toLowerCase()){var g=c.peer(a.user);g||(g=c.new_peer(a.user)),b.trigger("peer.accept",{name:"peer.accept",ns:a.ns,pns:a.param[0],app:e,version:f,call:c,peer:g})}}}},wsc.dAmn.BDS.Peer.SignalHandler.prototype.open=function(){},wsc.dAmn.BDS.Peer.SignalHandler.prototype.end=function(){},wsc.dAmn.BDS.Peer.SignalHandler.prototype.offer=function(a,b){if("@"==a.sns[0]){var c=b.bds.peer.call(a.param[0]);if(c){var d=(c.pns,a.param[1]),e=a.param[2],f=new wsc.dAmn.BDS.Peer.RTC.SessionDescription(JSON.parse(a.param.slice(3).join(",")));if(e.toLowerCase()==b.settings.username.toLowerCase()){var g=c.peer(d);g||(g=c.new_peer(d)),b.trigger("peer.offer",{name:"peer.offer",ns:a.ns,pns:c.pns,call:c,peer:g,offer:f}),g.set_remote_description(f,0)}}}},wsc.dAmn.BDS.Peer.SignalHandler.prototype.answer=function(a,b){if("@"==a.sns[0]){var c=b.bds.peer.call(a.param[0]);if(c){var d=a.param[1],e=a.param[2],f=new wsc.dAmn.BDS.Peer.RTC.SessionDescription(JSON.parse(a.param.slice(3).join(",")));if(e.toLowerCase()==b.settings.username.toLowerCase()){var g=c.peer(d);g||(g=c.new_peer(d)),b.trigger("peer.answer",{name:"peer.answer",ns:a.ns,pns:c.pns,call:c,peer:g,answer:f}),g.set_remote_description(f,1)}}}},wsc.dAmn.BDS.Peer.SignalHandler.prototype.candidate=function(a,b){if("@"==a.sns[0]){var c=b.bds.peer.call(a.param[0]);if(c){var d=c.peer(a.param[1]);if(d){var e=a.param[2];if(e.toLowerCase()==b.settings.username.toLowerCase()){var f=JSON.parse(a.param.slice(3).join(","));if(!f)return void d.ice_completed();var g=new wsc.dAmn.BDS.Peer.RTC.IceCandidate(f);d.candidate(g),b.trigger("peer.candidate",{name:"peer.candidate",ns:a.ns,pns:c.pns,call:c,peer:d,candidate:f,ice:g})}}}}},wsc.dAmn.BDS.Peer.SignalHandler.prototype.close=function(a,b){if("@"==a.sns[0]){var c=b.bds.peer.call(a.param[0]);if(c){var d=c.peer(a.param[1]);d&&d.user.toLowerCase()!=b.settings.username.toLowerCase()&&(c.remove(d.user),b.trigger("peer.close",{name:"peer.close",ns:a.ns,evt:a,call:c,peer:d}))}}},wsc.dAmn.BDS.Peer.RTC={PeerConnection:null,SessionDescription:null,IceCandidate:null},window.mozRTCPeerConnection&&(wsc.dAmn.BDS.Peer.RTC.PeerConnection=mozRTCPeerConnection,wsc.dAmn.BDS.Peer.RTC.SessionDescription=mozRTCSessionDescription,wsc.dAmn.BDS.Peer.RTC.IceCandidate=mozRTCIceCandidate),window.webkitRTCPeerConnection&&(wsc.dAmn.BDS.Peer.RTC.PeerConnection=webkitRTCPeerConnection),window.RTCPeerConnection&&!wsc.dAmn.BDS.Peer.RTC.PeerConnection&&(wsc.dAmn.BDS.Peer.RTC.PeerConnection=RTCPeerConnection),window.RTCSessionDescription&&(wsc.dAmn.BDS.Peer.RTC.SessionDescription=RTCSessionDescription,wsc.dAmn.BDS.Peer.RTC.IceCandidate=RTCIceCandidate),function(a){a("*").hover(function(){a(this).data("hover",!0)},function(){a(this).data("hover",!1)}),a.fn.wsc=function(b,c){var d=a(window).data("wscclient");return("init"==b||void 0===d)&&(void 0==d&&(d=new wsc.Client(a(this),c,a.browser.mozilla||!1),setInterval(function(){d.loop()},12e4)),a(window).data("wscclient",d)),"init"!=b&&void 0!=b&&(b="jq_"+b,b in d&&d[b](a(this),c)),d},a.fn.wscui=function(b,c){return ui=a(window).data("wscui"),("init"==b||void 0===ui)&&(void 0==ui&&(ui=new Chatterbox.UI(a(this),c,a.browser.mozilla||!1),a(window).resize(ui.resize)),a(window).data("wscui",ui)),"init"!=b&&void 0!=b&&(b="jq_"+b,b in ui&&ui[b](a(this),c)),ui}}(jQuery);