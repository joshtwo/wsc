var wsc={};wsc.VERSION="1.7.51";wsc.STATE="release candidate";wsc.REVISION="0.21.136";wsc.defaults={};wsc.defaults.theme="wsct_dark";wsc.defaults.themes=["wsct_dAmn","wsct_dark"];function EventEmitter(){var h={},a=this;function g(l,m){var k=h[l]||false;if(k===false){h[l]=[m];return a}h[l].push(m);return a}function f(k){h[k]=[];return a}function b(){var k=Array.prototype.slice.call(arguments);var o=k.shift();var n=h[o]||false;var m=0;if(n===false){return m}for(var l in n){if(n.hasOwnProperty(l)){bubble=n[l].apply({},k);m++;if(bubble===false){break}}}return m}function j(k){return h[k]||[]}this.addListener=g;this.removeListeners=f;this.emit=b;this.listeners=j}var CryptoJS=CryptoJS||function(D,h){var o={},w=o.lib={},j=function(){},b=w.Base={extend:function(a){j.prototype=this;var g=new j;a&&g.mixIn(a);g.hasOwnProperty("init")||(g.init=function(){g.$super.init.apply(this,arguments)});g.init.prototype=g;g.$super=this;return g},create:function(){var a=this.extend();a.init.apply(a,arguments);return a
},init:function(){},mixIn:function(a){for(var g in a){a.hasOwnProperty(g)&&(this[g]=a[g])}a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},f=w.WordArray=b.extend({init:function(a,g){a=this.words=a||[];this.sigBytes=g!=h?g:4*a.length},toString:function(a){return(a||C).stringify(this)},concat:function(k){var n=this.words,l=k.words,m=this.sigBytes;k=k.sigBytes;this.clamp();if(m%4){for(var p=0;p<k;p++){n[m+p>>>2]|=(l[p>>>2]>>>24-8*(p%4)&255)<<24-8*((m+p)%4)}}else{if(65535<l.length){for(p=0;p<k;p+=4){n[m+p>>>2]=l[p>>>2]}}else{n.push.apply(n,l)}}this.sigBytes+=k;return this},clamp:function(){var a=this.words,g=this.sigBytes;a[g>>>2]&=4294967295<<32-8*(g%4);a.length=D.ceil(g/4)},clone:function(){var a=b.clone.call(this);a.words=this.words.slice(0);return a},random:function(g){for(var l=[],k=0;k<g;k+=4){l.push(4294967296*D.random()|0)}return new f.init(l,g)}}),A=o.enc={},C=A.Hex={stringify:function(l){var m=l.words;l=l.sigBytes;
for(var q=[],p=0;p<l;p++){var n=m[p>>>2]>>>24-8*(p%4)&255;q.push((n>>>4).toString(16));q.push((n&15).toString(16))}return q.join("")},parse:function(k){for(var l=k.length,n=[],m=0;m<l;m+=2){n[m>>>3]|=parseInt(k.substr(m,2),16)<<24-4*(m%8)}return new f.init(n,l/2)}},z=A.Latin1={stringify:function(k){var l=k.words;k=k.sigBytes;for(var n=[],m=0;m<k;m++){n.push(String.fromCharCode(l[m>>>2]>>>24-8*(m%4)&255))}return n.join("")},parse:function(k){for(var l=k.length,n=[],m=0;m<l;m++){n[m>>>2]|=(k.charCodeAt(m)&255)<<24-8*(m%4)}return new f.init(n,l)}},B=A.Utf8={stringify:function(a){try{return decodeURIComponent(escape(z.stringify(a)))}catch(k){throw Error("Malformed UTF-8 data")}},parse:function(a){return z.parse(unescape(encodeURIComponent(a)))}},y=w.BufferedBlockAlgorithm=b.extend({reset:function(){this._data=new f.init;this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=B.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(p){var r=this._data,v=r.words,u=r.sigBytes,s=this.blockSize,n=u/(4*s),n=p?D.ceil(n):D.max((n|0)-this._minBufferSize,0);
p=n*s;u=D.min(4*p,u);if(p){for(var q=0;q<p;q+=s){this._doProcessBlock(v,q)}q=v.splice(0,p);r.sigBytes-=u}return new f.init(q,u)},clone:function(){var a=b.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});w.Hasher=y.extend({cfg:b.extend(),init:function(a){this.cfg=this.cfg.extend(a);this.reset()},reset:function(){y.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);return this._doFinalize()},blockSize:16,_createHelper:function(a){return function(k,l){return(new a.init(l)).finalize(k)}},_createHmacHelper:function(a){return function(k,l){return(new x.HMAC.init(a,l)).finalize(k)}}});var x=o.algo={};return o}(Math);(function(z){function g(r,s,p,v,q,u,n){r=r+(s&p|~s&v)+q+n;return(r<<u|r>>>32-u)+s}function j(r,s,p,v,q,u,n){r=r+(s&v|p&~v)+q+n;return(r<<u|r>>>32-u)+s}function k(r,s,p,v,q,u,n){r=r+(s^p^v)+q+n;return(r<<u|r>>>32-u)+s}function h(r,s,p,v,q,u,n){r=r+(p^(s|~v))+q+n;return(r<<u|r>>>32-u)+s
}for(var b=CryptoJS,f=b.lib,w=f.WordArray,y=f.Hasher,f=b.algo,o=[],x=0;64>x;x++){o[x]=4294967296*z.abs(z.sin(x+1))|0}f=f.MD5=y.extend({_doReset:function(){this._hash=new w.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(Q,N){for(var V=0;16>V;V++){var P=N+V,n=Q[P];Q[P]=(n<<8|n>>>24)&16711935|(n<<24|n>>>8)&4278255360}var V=this._hash.words,P=Q[N+0],n=Q[N+1],O=Q[N+2],L=Q[N+3],J=Q[N+4],H=Q[N+5],F=Q[N+6],E=Q[N+7],p=Q[N+8],m=Q[N+9],l=Q[N+10],a=Q[N+11],M=Q[N+12],K=Q[N+13],I=Q[N+14],G=Q[N+15],U=V[0],T=V[1],S=V[2],R=V[3],U=g(U,T,S,R,P,7,o[0]),R=g(R,U,T,S,n,12,o[1]),S=g(S,R,U,T,O,17,o[2]),T=g(T,S,R,U,L,22,o[3]),U=g(U,T,S,R,J,7,o[4]),R=g(R,U,T,S,H,12,o[5]),S=g(S,R,U,T,F,17,o[6]),T=g(T,S,R,U,E,22,o[7]),U=g(U,T,S,R,p,7,o[8]),R=g(R,U,T,S,m,12,o[9]),S=g(S,R,U,T,l,17,o[10]),T=g(T,S,R,U,a,22,o[11]),U=g(U,T,S,R,M,7,o[12]),R=g(R,U,T,S,K,12,o[13]),S=g(S,R,U,T,I,17,o[14]),T=g(T,S,R,U,G,22,o[15]),U=j(U,T,S,R,n,5,o[16]),R=j(R,U,T,S,F,9,o[17]),S=j(S,R,U,T,a,14,o[18]),T=j(T,S,R,U,P,20,o[19]),U=j(U,T,S,R,H,5,o[20]),R=j(R,U,T,S,l,9,o[21]),S=j(S,R,U,T,G,14,o[22]),T=j(T,S,R,U,J,20,o[23]),U=j(U,T,S,R,m,5,o[24]),R=j(R,U,T,S,I,9,o[25]),S=j(S,R,U,T,L,14,o[26]),T=j(T,S,R,U,p,20,o[27]),U=j(U,T,S,R,K,5,o[28]),R=j(R,U,T,S,O,9,o[29]),S=j(S,R,U,T,E,14,o[30]),T=j(T,S,R,U,M,20,o[31]),U=k(U,T,S,R,H,4,o[32]),R=k(R,U,T,S,p,11,o[33]),S=k(S,R,U,T,a,16,o[34]),T=k(T,S,R,U,I,23,o[35]),U=k(U,T,S,R,n,4,o[36]),R=k(R,U,T,S,J,11,o[37]),S=k(S,R,U,T,E,16,o[38]),T=k(T,S,R,U,l,23,o[39]),U=k(U,T,S,R,K,4,o[40]),R=k(R,U,T,S,P,11,o[41]),S=k(S,R,U,T,L,16,o[42]),T=k(T,S,R,U,F,23,o[43]),U=k(U,T,S,R,m,4,o[44]),R=k(R,U,T,S,M,11,o[45]),S=k(S,R,U,T,G,16,o[46]),T=k(T,S,R,U,O,23,o[47]),U=h(U,T,S,R,P,6,o[48]),R=h(R,U,T,S,E,10,o[49]),S=h(S,R,U,T,I,15,o[50]),T=h(T,S,R,U,H,21,o[51]),U=h(U,T,S,R,M,6,o[52]),R=h(R,U,T,S,L,10,o[53]),S=h(S,R,U,T,l,15,o[54]),T=h(T,S,R,U,n,21,o[55]),U=h(U,T,S,R,p,6,o[56]),R=h(R,U,T,S,G,10,o[57]),S=h(S,R,U,T,F,15,o[58]),T=h(T,S,R,U,K,21,o[59]),U=h(U,T,S,R,J,6,o[60]),R=h(R,U,T,S,a,10,o[61]),S=h(S,R,U,T,O,15,o[62]),T=h(T,S,R,U,m,21,o[63]);
V[0]=V[0]+U|0;V[1]=V[1]+T|0;V[2]=V[2]+S|0;V[3]=V[3]+R|0},_doFinalize:function(){var p=this._data,q=p.words,m=8*this._nDataBytes,r=8*p.sigBytes;q[r>>>5]|=128<<24-r%32;var n=z.floor(m/4294967296);q[(r+64>>>9<<4)+15]=(n<<8|n>>>24)&16711935|(n<<24|n>>>8)&4278255360;q[(r+64>>>9<<4)+14]=(m<<8|m>>>24)&16711935|(m<<24|m>>>8)&4278255360;p.sigBytes=4*(q.length+1);this._process();p=this._hash;q=p.words;for(m=0;4>m;m++){r=q[m],q[m]=(r<<8|r>>>24)&16711935|(r<<24|r>>>8)&4278255360}return p},clone:function(){var l=y.clone.call(this);l._hash=this._hash.clone();return l}});b.MD5=y._createHelper(f);b.HmacMD5=y._createHmacHelper(f)})(Math);wsc.Transport=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.open(b);this.message(f);this.disconnect(a)};wsc.Transport.Create=function(g,b,f,a){if(typeof io!=="undefined"){return new wsc.SocketIO(g,b,f,a)}if(!window.WebSocket){throw"This browser does not support websockets."}return new wsc.WebSocket(g,b,f,a)};wsc.Transport.prototype.open=function(a){this._open=a||this.sopen
};wsc.Transport.prototype.message=function(a){this._message=a||this.smessage};wsc.Transport.prototype.disconnect=function(a){this._disconnect=a||this.sdisconnect};wsc.Transport.prototype.sopen=function(){};wsc.Transport.prototype.smessage=function(){};wsc.Transport.prototype.sdisconnect=function(){};wsc.Transport.prototype._open=function(b,a){};wsc.Transport.prototype._message=function(a){};wsc.Transport.prototype._disconnect=function(a){};wsc.Transport.prototype.connect=function(){};wsc.Transport.prototype.send=function(a){};wsc.Transport.prototype.close=function(){};wsc.WebSocket=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.cause=null;this.open(b);this.message(f);this.disconnect(a)};wsc.WebSocket.prototype=new wsc.Transport;wsc.WebSocket.prototype.constructor=wsc.WebSocket;wsc.WebSocket.prototype.onopen=function(b,a){this.sock=a||this.conn;this._open(b,this)};wsc.WebSocket.prototype.ondisconnect=function(a){this.sock=null;this.conn=null;this._disconnect({wsEvent:a,cause:this.cause})
};wsc.WebSocket.prototype.connect=function(){var a=this;this.conn=new WebSocket(this.server);this.conn.onopen=function(f,b){a.onopen(f,b)};this.conn.onmessage=this._message;this.conn.onclose=function(b){a.ondisconnect(b)}};wsc.WebSocket.prototype.send=function(a){if(this.sock==null){return -1}return this.sock.send(replaceAll(escape(a).replace(/\%u([\dA-F]{4})/g,"%26%23x$1%3B"),"+","%2B"))};wsc.WebSocket.prototype.close=function(a){if(this.sock==null){return}this.cause=a;this.sock.close()};wsc.SocketIO=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.open(b);this.message(f);this.disconnect(a)};wsc.SocketIO.prototype=new wsc.Transport("");wsc.SocketIO.prototype.constructor=wsc.SocketIO;wsc.SocketIO.prototype.connect=function(){var a=this;this.conn=io.connect(this.server);this.conn.on("connect",function(f,b){a.onopen(f,b)});this.conn.on("message",function(b){a._message({data:b})});this.conn.on("close",function(b){a.ondisconnect(b)})};wsc.SocketIO.prototype.onopen=function(b,a){this.sock=a||this.conn;
this._open(b,this)};wsc.SocketIO.prototype.ondisconnect=function(a){this.sock=null;this.conn=null;this._disconnect(a)};wsc.SocketIO.prototype.send=function(a){if(this.sock==null){return -1}return this.sock.send(replaceAll(escape(a).replace(/\%u([\dA-F]{4})/g,"%26%23x$1%3B"),"+","%2B"))};wsc.SocketIO.prototype.close=function(){if(this.sock==null){return}this.sock.close()};function $_GET(f,b){b=b||window.location.search;var a=new RegExp("&"+f+"(?:=([^&]*))?(?=&|$)","i");b=b.replace(/^\?/,"&").match(a);if(b){return typeof b[1]!="undefined"?decodeURIComponent(b[1].replace(/\+/g,"%20")):""}}function UnixTimestamp(a){ret=new Date(a*1000);return ret}var Months=["January","February","March","April","May","June","July","August","September","October","November","December"];function PosEnd(a){return a=="1"?"st":(a=="2"?"nd":(a=="3"?"rd":"th"))}function DateStamp(a){a=UnixTimestamp(a);date=String(a.getDate());month=a.getMonth();df=date[date.length-1];return date+PosEnd(df)+" of "+Months[month]+", "+a.getFullYear()
}function caseInsensitiveSort(g,f){g=g.toLowerCase();f=f.toLowerCase();return((g>f)?1:(g<f?-1:0))}function EscapeRegExp(a){return a.replace((new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g")),"\\$1")}String.format=function(){var a=Array.prototype.slice.call(arguments);var f=a.shift();a=a.shift();if(a.length==0){return f}var b=a.length;return f.replace(/{(\d+)}/g,function(g,h){if(b<=parseInt(h)){return g}return typeof a[h]!="undefined"?a[h]:g})};replaceAllRaw=function(f,b,a){while(f.indexOf(b)>-1){f=f.replace(b,a)}return f};replaceAll=function(f,b,a){return f.split(b).join(a)};Object.size=function(f){var b=0,a;for(a in f){if(f.hasOwnProperty(a)){b++}}return b};Object.steal=function(g,f){for(var h in f){if(!g.hasOwnProperty(h)&&!f.hasOwnProperty(h)){continue}if(typeof g[h]=="object"){g[h]=Object.extend(g[h],f[h])}else{g[h]=f[h]}}};Object.extend=function(g,f){var h={};Object.steal(h,g);Object.steal(h,f);return h};function zeroPad(b,a){a=a||2;a-=b.toString().length;
if(a>0){return new Array(a+(/\./.test(b)?2:1)).join("0")+b}return b+""}function formatTime(b,a){a=a||new Date();HH=a.getHours();hh=HH;b=replaceAll(b,"{mm}",zeroPad(a.getMinutes(),2));b=replaceAll(b,"{ss}",zeroPad(a.getSeconds(),2));mr="am";if(hh>11){mr="pm";if(hh>12){hh=hh-12}}else{if(hh==0){hh="12"}}b=replaceAll(b,"{hh}",zeroPad(hh,2));b=replaceAll(b,"{HH}",zeroPad(HH,2));b=replaceAll(b,"{mr}",mr);return b}function oxlist(a){last=a.pop();ret=a.join(", ");return ret+(ret.length>0?", and ":"")+last}function pluralise(b,a){return b+(a==1?"":"s")}function timeLengthString(f){if(f<=0){return"0 seconds."}var a=f;var g=[];g.unshift(["second",Math.round(a%60)]);a/=Math.round(60);g.unshift(["minute",Math.round(a%60)]);a/=Math.round(60);g.unshift(["hour",Math.round(a%24)]);a/=Math.round(24);g.unshift(["day",a]);var b=[];for(i in g){lapse=g[i];if(lapse[1]<1){continue}b.push(lapse[1].toString()+" "+pluralise(lapse[0],lapse[1]))}return oxlist(b)}function StringSet(a){this.items=a||[]}StringSet.prototype.add=function(b,a){if(!b){return false
}b=b.toLowerCase();if(this.contains(b)){return true}if(a){this.items.unshift(b)}else{this.items.push(b)}return true};StringSet.prototype.remove=function(a){if(!a){return false}a=a.toLowerCase();if(!this.contains(a)){return true}this.items.splice(this.items.indexOf(a),1);return true};StringSet.prototype.contains=function(a){if(!a){return false}return this.items.indexOf(a.toLowerCase())!=-1};wsc.Middleware=function(){this.callbacks={}};wsc.Middleware.prototype.add=function(b,f){var a=this.callbacks[b]||false;if(a===false){this.callbacks[b]=[]}this.callbacks[b].push(f);return this.callbacks[b].length};wsc.Middleware.prototype.run=function(b,h,f){var g=(this.callbacks[b]||[]).slice();g.push(h);var a=function(j){g.shift()(j,a)};a(f)};wsc.Storage=function(b,a){this.ns=b||null;this.parent=a||null};wsc.Storage.prototype.folder=function(a){if(this.ns!=null){a=this.ns+"."+a}return new wsc.Storage(a,this)};wsc.Storage.prototype.get=function(a,f){if(this.ns!=null){a=this.ns+"."+a}try{if(!localStorage.hasOwnProperty(a)){return f
}return localStorage[a]}catch(b){return f}};wsc.Storage.prototype.set=function(a,f){if(this.ns!=null){a=this.ns+"."+a}try{localStorage[a]=f}catch(b){}};wsc.Storage.prototype.remove=function(a){if(this.ns!=null){a=this.ns+"."+a}try{if(!localStorage.hasOwnProperty(a)){return false}return delete localStorage[a]}catch(b){}return false};var chains=[["recv","admin"]];wsc.Packet=function(g,j,a){if(!(g)){return null}if(a===undefined){a=true}j=j||"=";var b={cmd:null,param:null,arg:{},body:null,sub:[],raw:g};var l=null;var m=-1;try{m=g.indexOf("\n\n");if(m>-1){b.body=g.substr(m+2);g=g.substr(0,m)}l=g.split("\n");if(l[0].indexOf(j)==-1){cline=l.shift().split(" ");b.cmd=cline.shift()||null;b.param=cline.join(" ")||null}for(var f in l){arg=l[f];m=arg.search(j);if(m==-1){continue}b.arg[arg.substr(0,m)]=arg.substr(m+j.length)||""}if(b.body!=null&&a){subs=b.body.split("\n\n");for(var h in subs){sub=wsc.Packet(subs[h],j,false);if(sub==null){break}sub.body=subs.slice(h+1).join("\n\n");b.sub.push(sub)}}}catch(k){return null
}b.toString=function(){return packetToString(b)};b.name=packetEvtName(b);return b};function wsc_packetstr(h,j,f,a){var b="";if(h){b=h;if(j){b=b+" "+j}}if(f){for(var g in f){b=b+"\n"+g+"="+f[g]}}b=b+"\n";if(a){b=b+"\n"+a}return b}function packetToString(a){return wsc_packetstr(a.cmd,a.param,a.arg,a.body)}function packetEvtName(b){var g=b.cmd;var a=null;for(var f in chains){a=chains[f];if(a[0]!=g){continue}var h=b.sub[0];g=g+"_"+h.cmd;if(a.length>1&&h.param!=undefined){if(a[1]==h.cmd){return g+"_"+h.param}}}return g}wsc.Channel=function(b,f,g,a){this.info={members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""},};this.client=b;this.hidden=g;this.monitor=(a==undefined?false:a);this.raw=b.format_ns(f);this.selector=(this.raw.substr(0,2)=="pc"?"pc":"c")+"-"+b.deform_ns(f).slice(1).toLowerCase();this.namespace=b.deform_ns(f);this.monitor=Object.size(this.client.channelo)==0};wsc.Channel.prototype.build=function(){this.info.members={};if(this.namespace[0]=="@"){this.set_privclasses({pkt:{body:""}})
}};wsc.Channel.prototype.property=function(a){var b=a.pkt.arg.p;switch(b){case"title":case"topic":this.set_header(b,a);break;case"privclasses":this.set_privclasses(a);break;case"members":this.set_members(a);break;default:this.server_message("Received unknown property "+b+" received in "+this.info.namespace+".");break}};wsc.Channel.prototype.set_header=function(a,b){this.info[a]["content"]=b.value.text()||"";this.info[a]["by"]=b.by;this.info[a]["ts"]=b.ts};wsc.Channel.prototype.set_privclasses=function(j){if(this.namespace[0]=="@"){this.info.pc={100:"Room Members"};this.info.pc_order=[100]}else{this.info.pc={};this.info.pc_order=[];var a=j.pkt.body.split("\n");var g=[];for(var b in a){if(!a.hasOwnProperty(b)){continue}g=a[b].split(":");if(g.length==1){continue}this.info.pc_order.push(parseInt(g[0]));this.info.pc[parseInt(g[0])]=g[1]}}this.info.pc_order.sort(function(l,k){return k-l});var h=this.info.pc;var f=this.info.pc_order.slice(0)};wsc.Channel.prototype.get_privclass_order=function(a){a=a.toLowerCase();
for(var b in this.info.pc){if(!this.info.pc.hasOwnProperty(b)){continue}if(this.info.pc[b].toLowerCase()==a){return b}}};wsc.Channel.prototype.set_members=function(b){this.info.members={};for(var a in b.pkt.sub){if(!b.pkt.sub.hasOwnProperty(a)){continue}this.register_user(b.pkt.sub[a],true)}this.set_user_list()};wsc.Channel.prototype.set_user_list=function(){if(Object.size(this.info.members)==0){return}var f=this.get_usernames();var g=[];var b=null;for(var a in f){if(!f.hasOwnProperty(a)){continue}g.push(this.info.members[f[a]])}this.client.trigger("ns.user.list",{name:"set.userlist",ns:this.namespace,users:g})};wsc.Channel.prototype.user_info=function(a){var f=this.info.members[a];var b=f.symbol;return{name:a,pc:f.pc||"Room Members",symbol:b,conn:f.conn,hover:{member:f,name:a,avatar:'<img class="avatar" src="" height="50" width="50" />',link:b+'<a target="_blank" href="http://'+a+"."+this.client.settings.domain+'/">'+a+"</a>",info:[]}}};wsc.Channel.prototype.register_user=function(a,f){var b=a.param;
if(this.info.members[b]==undefined){this.info.members[b]=a.arg;this.info.members[b]["username"]=b;this.info.members[b]["conn"]=1;this.info.members[b]=this.user_info(b)}else{for(i in a.arg){this.info.members[b][i]=a.arg[i]}this.info.members[b]["conn"]++}if(!("pc" in this.info.members[b])){this.info.members[b]["pc"]="Room Members"}f=f||false;if(f){return}this.client.trigger("ns.user.registered",{name:"ns.user.registered",ns:this.namespace,user:b})};wsc.Channel.prototype.get_usernames=function(){var b=[];for(var a in this.info.members){b.push(a)}b.sort(caseInsensitiveSort);return b};wsc.Channel.prototype.remove_user=function(a,b){b=b||false;var f=this.info.members[a];if(f==undefined){return}f.conn--;if(f.conn==0||b){delete this.info.members[a]}this.client.trigger("ns.user.remove",{user:f.name,ns:this.namespace})};wsc.Channel.prototype.recv_join=function(b){var a=new wsc.Packet("user "+b.user+"\n"+b.info);this.register_user(a)};wsc.Channel.prototype.recv_part=function(a){this.remove_user(a.user)
};wsc.Channel.prototype.recv_privchg=function(a){var b=this;this.client.cascade("ns.user.privchg",function(f){var g=b.info.members[f.user];if(!g){return}g.pc=f.pc},a)};wsc.Channel.prototype.recv_kicked=function(a){this.remove_user(a.user,true);this.set_user_list()};wsc.MessageString=function(a,b){this._parser=b||new wsc.MessageParser();this.raw=a};with(wsc.MessageString.prototype=new String){constructor=wsc.MessageParser;toString=valueOf=function(){return this.raw}}wsc.MessageString.prototype.html=function(){return this.raw};wsc.MessageString.prototype.text=function(){return this.raw};wsc.MessageString.prototype.ansi=function(){return this.raw};wsc.MessageParser=function(){};wsc.MessageParser.prototype.parse=function(a){return new wsc.MessageString(a,this)};wsc.MessageParser.prototype.render=function(b,a){return a.raw};wsc.Protocol=function(b){this.mparser=b||new wsc.MessageParser;this.chains=[["recv","admin"]];this.maps={chatserver:["version"],login:["username",["e"],"data"],join:["ns",["e"]],part:["ns",["e","*r"]],property:["ns",["p","by","ts"],"*value"],recv_msg:[null,[["from","user"]],"*message"],recv_npmsg:[null,[["from","user"]],"message"],recv_action:[null,["s",["from","user"]],"*message"],recv_join:["user",["s"],"*info"],recv_part:["user",["s","r"]],recv_privchg:["user",["s","by","pc"]],recv_kicked:["user",[["i","s"],"by"],"*r"],recv_admin_create:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_update:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_rename:[null,["p",["by","user"],"prev",["name","pc"]]],recv_admin_move:[null,["p",["by","user"],"prev",["name","pc"],["n","affected"]]],recv_admin_remove:[null,["p",["by","user"],["name","pc"],["n","affected"]]],recv_admin_show:[null,["p"],"info"],recv_admin_showverbose:[null,["p"],"info"],recv_admin_privclass:[null,["p","e"],"command"],kicked:["ns",[["by","user"]],"*r"],ping:[],disconnect:[null,["e"]],send:["ns",["e"]],kick:["ns",[["u","user"],"e"]],get:["ns",["p","e"]],set:["ns",["p","e"]],kill:["ns",["e"]],unknown:[null,null,null,"packet"],};
var a=this;this.mapper={recv:function(h,g,f){g.ns=h.param;return a.map(h.sub[0],g,f)}}};wsc.Protocol.prototype.extend_maps=function(b){for(var a in b){this.maps[a]=b[a]}};wsc.Protocol.prototype.populate_keys=function(){this.tkeys={};for(var f in this.maps){if(!this.maps.hasOwnProperty(f)){continue}var j=this.maps[f];var h="";this.tkeys[f]=[];for(var g in j){if(!j.hasOwnProperty(g)){continue}h=j[g];if(!h){continue}if(g==1){var b="";for(var a in h){if(!h.hasOwnProperty(a)){continue}b=h[a];if(!b){continue}if(b instanceof Array){b=b[1]}if(b[0]=="*"){this.tkeys[f].push(b.substr(1))}else{this.tkeys[f].push(b)}}continue}if(h[0]=="*"){this.tkeys[f].push(h.substr(1))}else{this.tkeys[f].push(h)}}}};wsc.Protocol.prototype.parse=function(f){var b=this.event(f);if(!(b in this.maps)){console.log("unknown: ",b);console.log(this.maps);mapping=this.maps.unknown;b="unknown"}else{mapping=this.maps[b]}var a={name:b,pkt:f,ns:null};cmd=f.cmd;if(this.mapper[cmd]){this.mapper[cmd](f,a,mapping)}else{this.map(f,a,mapping)
}return a};wsc.Protocol.prototype.event=function(b){var g=b.cmd;var a=null;for(var f in this.chains){a=this.chains[f];if(a[0]!=g){continue}var h=b.sub[0];g=g+"_"+h.cmd;if(a.length>1&&h.param!=undefined){if(a[1]==h.cmd){return g+"_"+h.param}}}return g};wsc.Protocol.prototype.map=function(f,b,a){for(var l in a){if(a[l]==null){continue}var m=a[l];var o=m;var j="",h="";switch(parseInt(l)){case 0:b[m]=f.param;break;case 1:if(a[1] instanceof Array){for(var g in a[1]){m=a[1][g];if(m instanceof Array){b[m[1]]=f.arg[m[0]];o=m[1]}else{var j=m[0]=="*"?m.slice(1):m;b[m]=f.arg[j]||"";o=m}}}if(typeof a[1]=="string"){b[m]=f.arg.slice(0)}break;case 2:if(m instanceof Array){f.sub[0].sub=f.sub.slice(1);this.map(f.sub[0],b,m)}else{b[m]=f.body}break;case 3:b[m]=f.raw;break}if(o[0]!="*"){continue}j=o.slice(1);h=this.mparser.parse(b[o]);b[j]=h}};wsc.Flow=function(a){this.protocol=a||new wsc.Protocol()};wsc.Flow.prototype.open=function(a,f,b){a.trigger("connected",{name:"connected",pkt:new wsc.Packet("connected\n\n")});
a.connected=true;a.handshake();a.attempts=0};wsc.Flow.prototype.close=function(b,f){var a={name:"closed",pkt:new wsc.Packet("connection closed\n\n"),reason:"",evt:f,connected:b.connected,sio:b.conn instanceof wsc.SocketIO,cause:f.cause||null,reconnect:true};var g={name:"log",ns:"~System",msg:"",info:""};b.trigger("closed",a);if(b.connected){g.msg="Connection closed";b.trigger("log",g);b.connected=false;if(b.conn instanceof wsc.SocketIO){g.msg="At the moment there is a problem with reconnecting with socket.io";g.info="Refresh to connect";b.trigger("log",g);g.info="";return}}else{g.msg="Connection failed";b.trigger("log",g)}a.name="quit";if(b.attempts>2){a.reconnect=false;b.attempts=0;b.trigger("quit",a);return}if(f.cause){if(f.cause.hasOwnProperty("name")&&f.cause.name=="login"){b.trigger("quit",a);return}}setTimeout(function(){b.connect()},2000)};wsc.Flow.prototype.message=function(a,g){var b=new wsc.Packet(unescape(replaceAll(g.data,"+"," ")));if(b==null){return}var f=this.protocol.parse(b);
if(f.ns==null){f.ns=a.mns}f.sns=a.deform_ns(f.ns);this.handle(a,f);a.trigger("pkt",f);a.trigger("pkt."+f.name,f)};wsc.Flow.prototype.handle=function(a,f){try{this[f.name](f,a)}catch(b){}};wsc.Flow.prototype.ping=function(b,a){a.pong()};wsc.Flow.prototype.chatserver=function(b,a){a.login()};wsc.Flow.prototype.login=function(f,a){if(f.pkt.arg.e=="ok"){var h=f.pkt.sub[0];a.settings.username=f.pkt.param;a.settings.symbol=h.arg.symbol;a.settings.userinfo=h.arg;var b=function(){a.join(a.settings.autojoin);if(a.autojoin.on){for(var j in a.autojoin.channel){if(!a.autojoin.channel.hasOwnProperty(j)){continue}a.join(a.autojoin.channel[j])}}};if(a.fresh){b()}else{var g=false;for(key in a.channelo){if(a.channelo[key].namespace[0]!="~"){a.join(key);g=true}}if(!g){b()}}}else{a.close(f)}if(a.fresh){a.fresh=false}};wsc.Flow.prototype.join=function(f,a){if(f.pkt.arg["e"]=="ok"){var b=a.deform_ns(f.pkt.param);a.create_ns(b,a.hidden.contains(f.pkt.param))}else{a.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:"Failed to join "+a.deform_ns(f.pkt.param),info:f.pkt.arg["e"]})
}};wsc.Flow.prototype.part=function(f,a){var b=a.deform_ns(f.ns);var g=a.channel(b);if(f.e=="ok"){info="";if(f.r.length>0){info="["+f.r+"]"}else{a.remove_ns(f.ns)}msg="You have left "+b;g.server_message(msg,info);if(a.channels()==0){switch(f.r){case"bad data":case"bad msg":case"msg too big":break;default:if(f.r.indexOf("killed:")<0){return}break}this.message(a,{data:"disconnect\ne="+e.r+"\n"})}}else{a.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:"Couldn't leave "+b,info:f.e})}};wsc.Flow.prototype.kicked=function(b,a){if(b.r.toLowerCase().indexOf("autokicked")>-1){return}a.join(b.ns)};wsc.Flow.prototype.property=function(b,a){chan=a.channel(b.pkt.param);if(!chan){return}chan.property(b)};wsc.Flow.prototype.recv_joinpart=function(b,a){c=a.channel(b.ns);if(b.name=="recv_join"){c.recv_join(b)}else{c.recv_part(b)}};wsc.Flow.prototype.recv_join=wsc.Flow.prototype.recv_joinpart;wsc.Flow.prototype.recv_part=wsc.Flow.prototype.recv_joinpart;wsc.Flow.prototype.recv_msg=function(b,a){a.channel(b.ns).recv_msg(b)
};wsc.Flow.prototype.recv_action=wsc.Flow.prototype.recv_msg;wsc.Flow.prototype.recv_npmsg=wsc.Flow.prototype.recv_msg;wsc.Flow.prototype.recv_privchg=function(b,a){a.channel(b.ns).recv_privchg(b)};wsc.Flow.prototype.recv_kicked=function(b,a){a.channel(b.ns).recv_kicked(b)};wsc.defaults.Extension=function(b){var f={};var k=function(){b.bind("cmd.connect",g.connection);b.bind("cmd.set",g.setter);b.bind("cmd.join",g.join);b.bind("cmd.chat",g.pjoin);b.bind("cmd.part",g.part);b.bind("cmd.say",g.say);b.bind("cmd.npmsg",g.npmsg);b.bind("cmd.me",g.action);b.bind("cmd.promote",g.chgpriv);b.bind("cmd.demote",g.chgpriv);b.bind("cmd.ban",g.ban);b.bind("cmd.unban",g.ban);b.bind("cmd.kick",g.killk);b.bind("cmd.whois",g.whois);b.bind("cmd.title",g.title);b.bind("cmd.topic",g.title);b.bind("cmd.admin",g.admin);b.bind("cmd.disconnect",g.connection);b.bind("cmd.kill",g.killk);b.bind("cmd.raw",g.raw);b.bind("cmd.close",g.close);b.bind("pkt.property",h);b.bind("pkt.recv_admin_show",a);b.bind("pkt.recv_admin_showverbose",a);
b.bind("pkt.get",j);b.bind("cmd.gettitle",g.gett);b.bind("cmd.gettopic",g.gett);b.bind("cmd.theme",g.theme)};f.save=function(m,l){b.settings.ui.theme=m.theme;b.settings.ui.clock=m.clock;b.settings.ui.tabclose=m.tabclose};var g={};g.theme=function(m,l){l.ui.theme(m.args.split(" ").shift())};g.setter=function(n){var m=n.args.split(" ");var l=m.shift().toLowerCase();var m=m.join(" ");if(m.length==0){b.cchannel.serverMessage("Could not set "+l,"No data supplied");return}if(!(l in b.settings)){b.cchannel.serverMessage('Unknown setting "'+l+'"');return}b.settings[l]=m;b.cchannel.serverMessage("Changed "+l+" setting","value: "+m)};g.connection=function(l){b[l.cmd]()};g.join=function(l){var m=l.args.split(" ");var m=m.toString()==""?[]:m;if(l.ns!=l.target){m.unshift(l.target)}if(m.toString()==""){return}for(index in m){b.join(m[index])}};g.pjoin=function(l){var m=l.args.split(" ");var m=m.toString()==""?[]:m;if(l.ns!=l.target){m.unshift(l.target)}if(m.toString()==""){return}for(index in m){b.join("@"+m[index])
}};g.part=function(l){var m=l.args.split(" ");if(l.ns!=l.target){m.unshift(l.target)}if(m.toString()==""){b.part(l.ns);return}for(index in m){b.part(m[index])}};g.title=function(l){b.set(l.target,l.cmd,l.args)};g.chgpriv=function(m){var l=m.args.split(" ");b[m.cmd.toLowerCase()](m.target,l[0],l[1])};g.ban=function(p,l){var n=p.args.split(" ");var m=n.shift();var o=p.cmd;if(o=="ban"&&n.length>0){l.kick(p.target,m,n.join(" "))}l[o](p.target,m)};g.action=function(l){b.action(l.target,l.args)};g.raw=function(l){b.send(l.args.replace(/\\n/gm,"\n"))};g.killk=function(o,l){var p=o.args.split(" ");var m=p.shift();var n=p.length>0?p.join(" "):null;if(o.cmd=="kick"){l.kick(o.target,m,n)}else{l.kill(m,n)}};g.say=function(l){if(b.channel(l.target).monitor){return}b.say(l.target,l.args)};g.npmsg=function(l){b.npmsg(l.target,l.args)};g.clear=function(n,l){if(n.args.length>0){var o=n.args.split(" ");for(var m in o){if(!o.hasOwnProperty(m)){continue}l.ui.channel(n.target).clear_user(o[m])}}else{l.ui.channel(n.target).clear()
}};g.clearall=function(m,l){var o=null;if(m.args.length>0){var n=m.args.split(" ");o=function(q,r){for(var p in n){if(!n.hasOwnProperty(p)){continue}r.clear_user(n[p])}}}else{o=function(p,q){q.clear()}}l.ui.chatbook.each(o,true)};g.close=function(l){b.part(l.target);b.remove_ns(l.target)};g.whois=function(m,l){l.whois(m.args.split(" ")[0])};g.admin=function(m,l){l.admin(m.target,m.args)};g.disconnect=function(m,l){l.disconnect()};g.gett=function(m,l){var n=m.cmd.indexOf("title")>-1?"title":"topic";l.ui.control.set_text("/"+n+" "+l.channel(m.target).info[n].content)};var h=function(p,l){if(p.p!="info"){return}var n=p.pkt.sub;var q=n.shift().arg;q.username=p.sns.substr(1);q.connections=[];var o=null;var r={};while(n.length>0){r=n.shift();switch(r.cmd){case"conn":if(o!=null){q.connections.push(o)}o=r.arg;o.channels=[];break;case"agent":o.agent=[["agent",r.arg.agent]];if(r.arg.hasOwnProperty("url")){o.agent.push(["url",r.arg.url])}if(r.arg.hasOwnProperty("browser")){o.agent.push(["browser",r.arg.browser])
}for(var m in r.arg){if(m=="agent"||m=="url"||m=="browser"){continue}if(r.arg.hasOwnProperty(m)){o.agent.push([m,r.arg[m]])}}break;case"ns":o.channels.unshift(l.deform_ns(r.param));break}}q.connections.push(o);l.trigger("pkt.whois",{name:"pkt.whois",pkt:p.pkt,info:q})};var j=function(m,l){if(m.ns.indexOf("login:")!=0){return}var n=m.sns.substr(1);l.ui.pager.notice({ref:"whois-"+n,heading:"Whois Failed",content:"Whois failed for "+n+".\nNo such user online."},false,5000)};var a=function(p,m){var s=m.channel(p.ns);var l=p.info.split("\n");var r="";var q=[];var n="";for(var o in l){if(!l.hasOwnProperty(o)){continue}r=l[o].split(" ");if(p.p=="privclass"){q.push([r.shift(),r.shift().split("=")[1],r.join(" ")])}else{if(p.p=="users"){n=r.shift().split(":",1)[0];q.push([n,s.get_privclass_order(n),r.join(" ")])}}}m.ui.chatbook.current.log_pc(p.p=="privclass",q)};k();wsc.defaults.Extension.Ignore(b);wsc.defaults.Extension.Away(b,f);wsc.defaults.Extension.Autojoin(b);return f};wsc.defaults.Extension.Autojoin=function(a){var f=a.autojoin;
var g=function(){a.bind("cmd.autojoin",b)};f.join=function(){for(var h in a.autojoin.channel){if(!a.autojoin.channel.hasOwnProperty(h)){continue}a.join(a.autojoin.channel[h])}};f.add=function(h){if(a.autojoin.channel.indexOf(h)!=-1){return false}a.autojoin.channel.push(h);a.config_save();return true};f.remove=function(j){var h=a.autojoin.channel.indexOf(j);if(h==-1){return false}a.autojoin.channel.splice(h,1);a.config_save();return true};var b=function(j){var n=j.args.split(" ");if(!n){return}var q=n.shift().toLowerCase();var o=null;var r="";var k="";var p=false;var h=a.channel(j.ns);switch(q){case"add":o=f.add;r="Added {item} to your autojoin.";k="Already have {item} on your autojoin.";break;case"rem":case"remove":o=f.remove;r="Removed {item} from your autojoin.";k=s+" is not on your autojoin list.";break;case"on":a.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:"Autojoin on"});if(!a.autojoin.on){p=true;a.autojoin.on=true}break;case"off":a.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:"Autojoin off"});
if(a.autojoin.on){p=true;a.autojoin.on=false}break;default:f.join();break}var s="";var m=false;if(o!=null){for(var l in n){if(!n.hasOwnProperty(l)){continue}s=a.deform_ns(n[l]).toLowerCase();m=o(s);a.trigger("log",{name:"log",ns:"server:current",sns:"~current",msg:replaceAll((m?r:k),"{item}",s)})}}if(p){a.config_save()}};g()};wsc.defaults.Extension.Away=function(b,g){var k=b.storage.folder("away");g.away={on:false,reason:"",last:{},since:0,interval:60000,format:{setaway:"/me is away: {reason}",setback:"/me is back",away:"{user}: I've been away for {timesince}. Reason: {reason}"}};b.away=g.away;var j=function(){g.away.load();g.away.save();b.bind("cmd.setaway",f);b.bind("cmd.setback",h);b.bind("pkt.recv_msg",a);b.bind("pkt.recv_action",a)};var f=function(n,l){g.away.on=true;g.away.last={};g.away.since=new Date();g.away.reason=n.args;var o=l.say;var m=replaceAll(g.away.format.setaway,"{reason}",g.away.reason||"[silent away]");if(m.indexOf("/me ")==0){m=m.substr(4);o=l.action}l.each_channel(function(p){o.call(l,p,m)
});l.trigger("ext.away.away",{name:"ext.away.away",reason:g.away.reason||"[silent away]"})};var h=function(n,l){if(!g.away.on){return}g.away.on=false;var o=l.say;var m=g.away.format.setback;if(m.indexOf("/me ")==0){m=m.substr(4);o=l.action}l.each_channel(function(p){o.call(l,p,m)});l.trigger("ext.away.back",{name:"ext.away.back"})};var a=function(p){if(!g.away.on){return}if(g.away.reason.length==0){return}if(b.exclude.contains(p.ns)){return}var q=p.user.toLowerCase();var m=b.settings.username.toLowerCase();if(q==m){return}if(p.message.text().toLowerCase().indexOf(m)==-1){return}var n=new Date();var o=p.sns.toLowerCase();if(o in g.away.last){if((n-g.away.last[o])<=g.away.interval){return}}var l=timeLengthString((n-g.away.since)/1000);var r=replaceAll(g.away.format.away,"{user}",p.user);r=replaceAll(r,"{timesince}",l);b.say(p.ns,replaceAll(r,"{reason}",g.away.reason));g.away.last[o]=n};g.away.load=function(){g.away.format.setaway=k.get("setaway","/me is away: {reason}");g.away.format.setback=k.get("setback","/me is back");
g.away.format.away=k.get("away","{user}: I've been away for {timesince}. Reason: {reason}");g.away.interval=parseInt(k.get("interval",60000))};g.away.save=function(){k.set("interval",g.away.interval);k.set("setaway",g.away.format.setaway);k.set("setback",g.away.format.setback);k.set("away",g.away.format.away)};j()};wsc.defaults.Extension.Ignore=function(f){var g={};var h=f.storage.folder("ignore");var a=h.folder("ignored");var m=function(){l();k();f.bind("cmd.ignore",b);f.bind("cmd.unignore",j)};var b=function(q){var s=q.args.split(" ");var n="";var r="";var p=false;for(var o in s){if(!s.hasOwnProperty(o)){continue}n=s[o];tmod=f.mute_user(n);if(!tmod){continue}p=tmod;r=replaceAll(g.ignore,"{user}",n);if(r.indexOf("/me ")==0){r=r.substr(4);f.action(q.target,r)}else{f.say(q.target,r)}}if(p){k()}};var j=function(r){var v=r.args.split(" ");var o="";var u="";var n=-1;var q=false;var s=false;for(var p in v){if(!v.hasOwnProperty(p)){continue}o=v[p];s=f.unmute_user(o);if(!s){continue}q=s;u=replaceAll(g.unignore,"{user}",o);
if(u.indexOf("/me ")==0){u=u.substr(4);f.action(r.target,u)}else{f.say(r.target,u)}}if(q){k()}};var l=function(){g.ignore=h.get("ignore","/me is ignoring {user} now");g.unignore=h.get("unignore","/me is not ignoring {user} anymore");g.count=parseInt(h.get("count",0));var o=null;if(g.count>0){o=null;for(var n=0;n<g.count;n++){}}};var k=function(){h.set("ignore",g.ignore);h.set("unignore",g.unignore);for(var n=0;n<g.count;n++){a.remove(n)}};m()};wsc.Client=function(b,f,g){this.mozilla=g;this.storage=new wsc.Storage;this.storage.aj=this.storage.folder("autojoin");this.storage.aj.channel=this.storage.aj.folder("channel");this.fresh=true;this.attempts=0;this.connected=false;this.protocol=null;this.flow=null;this.ui=null;this.events=new EventEmitter();this.conn=null;this.channelo={};this.cchannel=null;this.cmds=[];this.settings={domain:"website.com",server:"ws://website.com/wsendpoint",symbol:"",username:"",userinfo:{},pk:"",monitor:["~Monitor",true],welcome:"Welcome to the wsc web client!",autojoin:"chat:channel",protocol:wsc.Protocol,mparser:wsc.MessageParser,flow:wsc.Flow,extend:[wsc.defaults.Extension],client:"chatclient",clientver:"0.3",developer:false};
this.autojoin={on:true,count:0,channel:[]};this.away={};var a=this;this.exclude=new StringSet();this.hidden=new StringSet();this.settings=Object.extend(this.settings,f);this.config_load();this.config_save();this.mw=new wsc.Middleware();this.settings.agent="Client ("+navigator.platform+"; HTML5; JavaScript) wsc/"+wsc.VERSION+"-r"+wsc.REVISION;this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.protocol=new this.settings.protocol(new this.settings.mparser());this.flow=new this.settings.flow(this.protocol);this.build();this.ext={};this.ext.defaults=wsc.defaults.Extension(this)};wsc.Client.prototype.config_load=function(){this.settings.developer=(this.storage.get("developer",this.settings.developer.toString())=="true");this.autojoin.on=(this.storage.aj.get("on","true")=="true");this.autojoin.count=parseInt(this.storage.aj.get("count","0"));this.autojoin.channel=[];var a=null;var f=0;for(var b=0;b<this.autojoin.count;b++){a=this.storage.aj.channel.get(b,null);
if(a==null){continue}f++;this.autojoin.channel.push(a)}this.autojoin.count=f};wsc.Client.prototype.config_save=function(){this.storage.set("developer",this.settings.developer);this.storage.aj.set("on",this.autojoin.on.toString());this.storage.aj.set("count",this.autojoin.count);for(var a=0;a<this.autojoin.count;a++){this.storage.aj.channel.remove(a)}if(this.autojoin.channel.length==0){this.storage.aj.set("count",0)}else{var b=-1;for(var a in this.autojoin.channel){if(!this.autojoin.channel.hasOwnProperty(a)){continue}b++;this.storage.aj.channel.set(b.toString(),this.autojoin.channel[a])}b++;this.storage.aj.set("count",b)}};wsc.Client.prototype.build=function(){this.create_ns(this.settings.monitor[0],true,true);var a=this};wsc.Client.prototype.loop=function(){};wsc.Client.prototype.add_extension=function(a){this.settings.extend.push(a);a(this)};wsc.Client.prototype.bind=function(b,a){this.events.addListener(b,a);if(b.indexOf("cmd.")!=0||b.length<=4){return}cmd=b.slice(4).toLowerCase();this.cmds.push(cmd)
};wsc.Client.prototype.clear_listeners=function(a){this.events.removeListeners(a)};wsc.Client.prototype.trigger=function(a,b){return this.events.emit(a,b,this)};wsc.Client.prototype.middle=function(a,b){return this.mw.add(a,b)};wsc.Client.prototype.cascade=function(a,f,b){this.mw.run(a,f,b)};wsc.Client.prototype.connect=function(){if(this.connected){return}this.attempts++;try{var a=this;this.conn=wsc.Transport.Create(this.settings.server);this.conn.open(function(f,g){a.flow.open(a,f,g)});this.conn.disconnect(function(f){a.flow.close(a,f)});this.conn.message(function(f){a.flow.message(a,f)});this.conn.connect();this.trigger("start",new wsc.Packet("client connecting\ne=ok\n\n"))}catch(b){console.log(b);this.trigger("start",new wsc.Packet("client connecting\ne=no websockets available\n\n"))}};wsc.Client.prototype.close=function(a){this.conn.close(a)};wsc.Client.prototype.channel=function(a,b){a=this.format_ns(a).toLowerCase();if(!this.channelo[a]){if(b){this.channelo[a]=b;return b}return null
}return this.channelo[a]};wsc.Client.prototype.channels=function(b){var a=[];for(ns in this.channelo){if(!this.channelo.hasOwnProperty(ns)){continue}if(this.channelo[ns].hidden){continue}a.push(this.channelo[ns].namespace)}return b?a:a.length};wsc.Client.prototype.each_channel=function(g,a){var f=null;for(var b in this.channelo){if(!this.channelo.hasOwnProperty(b)){continue}f=this.channelo[b];if(!a){if(this.exclude.contains(f.raw)){continue}}if(g(f.raw,f)===false){break}}};wsc.Client.prototype.deform_ns=function(b){var a=b[0];if(a=="#"||a=="@"||a=="~"||a=="+"){return b}if(b.indexOf("chat:")==0){return"#"+b.slice(5)}if(b.indexOf("server:")==0){return"~"+b.slice(7)}if(b.indexOf("feed:")==0){return"#"+b.slice(5)}if(b.indexOf("login:")==0){return"@"+b.slice(6)}if(b.indexOf("pchat:")==0){var f=b.split(":");f.shift();for(i in f){name=f[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}return"#"+b};wsc.Client.prototype.format_ns=function(a){var f=a.slice(1);switch(a[0]){case"@":var b=[f,this.lun];
b.sort(caseInsensitiveSort);b.unshift("pchat");a=b.join(":");break;case"~":a="server:"+f;break;case"+":a="feed:"+f;break;case"#":a="chat:"+f;break;default:if(a.indexOf("chat:")==0||a.indexOf("pchat:")==0||a.indexOf("server:")==0||a.indexOf("feed:")==0){break}a="chat:"+a;break}return a};wsc.Client.prototype.create_ns=function(b,f,a){var g=this.channel(b,new wsc.Channel(this,b,f,a));this.trigger("ns.create",{name:"ns.create",ns:b,chan:g,client:this});g.build()};wsc.Client.prototype.remove_ns=function(a){if(!a){return}this.cascade("ns.remove",function(b){var f=b.client.channel(b.ns);if(!f){return}delete b.client.channelo[f.raw.toLowerCase()]},{ns:a,client:this})};wsc.Client.prototype.select_ns=function(a){this.cchannel=this.channel(a)||this.cchannel};wsc.Client.prototype.log=function(a,b){var f=this.channel(a);if(!f){return}f.log(b)};wsc.Client.prototype.monitor=function(a){console.log(a)};wsc.Client.prototype.mute_user=function(a){};wsc.Client.prototype.unmute_user=function(a){};wsc.Client.prototype.send=function(a){return this.conn.send(a)
};wsc.Client.prototype.handshake=function(){this.send(wsc_packetstr(this.settings.client,this.settings.clientver,{agent:this.settings.agent,url:window.location.href,browser:navigator.userAgent}))};wsc.Client.prototype.login=function(){pkt="login "+this.settings.username+"\npk="+this.settings.pk+"\n";this.send(pkt)};wsc.Client.prototype.pong=function(){this.send(wsc_packetstr("pong"))};wsc.Client.prototype.join=function(a){this.send(wsc_packetstr("join",this.format_ns(a)))};wsc.Client.prototype.part=function(a){this.send(wsc_packetstr("part",this.format_ns(a)))};wsc.Client.prototype.say=function(a,b){var f=this;this.cascade("send.msg",function(g){f.send(wsc_packetstr("send",f.format_ns(g.ns),{},wsc_packetstr("msg","main",{},g.input)))},{input:b,ns:a})};wsc.Client.prototype.npmsg=function(a,b){var f=this;this.cascade("send.npmsg",function(g){f.send(wsc_packetstr("send",f.format_ns(g.ns),{},wsc_packetstr("npmsg","main",{},g.input)))},{input:b,ns:a})};wsc.Client.prototype.action=function(a,b){var f=this;
this.cascade("send.action",function(g){f.send(wsc_packetstr("send",f.format_ns(g.ns),{},wsc_packetstr("action","main",{},g.input)))},{input:b,ns:a})};wsc.Client.prototype.promote=function(f,a,b){this.send(wsc_packetstr("send",this.format_ns(f),{},wsc_packetstr("promote",a,{},(!b?"":b))))};wsc.Client.prototype.demote=function(f,a,b){this.send(wsc_packetstr("send",this.format_ns(f),{},wsc_packetstr("demote",a,{},(!b?"":b))))};wsc.Client.prototype.ban=function(b,a){this.send(wsc_packetstr("send",this.format_ns(b),{},wsc_packetstr("ban",a)))};wsc.Client.prototype.unban=function(b,a){this.send(wsc_packetstr("send",this.format_ns(b),{},wsc_packetstr("unban",a)))};wsc.Client.prototype.kick=function(b,a,f){var g=this;this.cascade("send.kick",function(h){g.send(wsc_packetstr("kick",g.format_ns(h.ns),{u:h.user},h.input||null))},{input:f||"",ns:b,user:a})};wsc.Client.prototype.kill=function(a,b){this.send(wsc_packetstr("kill","login:"+a,{},b||null))};wsc.Client.prototype.admin=function(a,b){this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("admin","",{},b)))
};wsc.Client.prototype.property=function(a,b){this.send(wsc_packetstr("get",this.format_ns(a),{p:b}))};wsc.Client.prototype.set=function(a,f,b){var g=this;this.cascade("send.set",function(h){g.send(wsc_packetstr("set",g.format_ns(h.ns),{p:h.property},h.input))},{input:b,ns:a,property:f})};wsc.Client.prototype.whois=function(a){this.send(wsc_packetstr("get","login:"+a,{p:"info"}))};wsc.Client.prototype.disconnect=function(){this.send(wsc_packetstr("disconnect"))};wsc.dAmn={};wsc.dAmn.VERSION="0.10.36";wsc.dAmn.STATE="alpha";wsc.dAmn.wsc=function(a,f){a.settings.client="dAmnClient";a.settings.clientver="0.3";a.settings.domain="deviantart.com";a.settings.agent+=" wsc/dAmn/"+wsc.dAmn.VERSION;var g=a.storage.folder("dAmn");g.bds=g.folder("bds");g.emotes=g.folder("emotes");g.colours=g.folder("colours");var b={emotes:{on:false,emote:[]},colours:{on:false,send:false,msg:"000000",user:"000000"}};b.save=function(){g.emotes.set("on",b.emotes.on);g.colours.set("on",b.colours.on);g.colours.set("send",b.colours.send);
g.colours.set("msg",b.colours.msg);g.colours.set("user",b.colours.user)};b.load=function(){b.emotes.on=(g.emotes.get("on","false")=="true");b.colours.on=(g.colours.get("on","false")=="true");b.colours.send=(g.colours.get("send","false")=="true");b.colours.msg=g.colours.get("msg","");b.colours.user=g.colours.get("user","")};b.load();b.save();a.protocol.extend_maps({dAmnServer:["version"]});a.protocol.mparser=new wsc.dAmn.TablumpParser;a.flow.dAmnServer=a.flow.chatserver;a.exclude.add("chat:devart");a.exclude.add("chat:damnidlers");wsc.dAmn.BDS(a,g.bds,b);wsc.dAmn.BDS.Link(a,g.bds,b);wsc.dAmn.BDS.Peer(a,g.bds,b);wsc.dAmn.wsc.Colours(a,g.colours,b);wsc.dAmn.wsc.Emotes(a,g.emotes,b);return b};wsc.dAmn.chatterbox=function(f){var a=f.client;var b={colours:{},emotes:{}};f.on("settings.save",a.ext.dAmn.save);f.on("settings.close",a.ext.dAmn.load);f.protocol.extend_messages({dAmnServer:{keys:["version"],template:'<span class="servermsg">** Connected to dAmnServer {version} *</span>',global:true}});
f.middle("user.hover",function(h,g){h.avatar=wsc.dAmn.avatar.link(h.name,h.member.usericon);if(h.member.realname&&h.info.indexOf(h.member.realname)==-1){h.info.push(h.member.realname)}if(h.member.typename&&h.info.indexOf(h.member.typename)==-1){h.info.push(h.member.typename)}g(h)});f.on("log_whois.before",function(g,h){g.avatar=wsc.dAmn.avatar.link(g.raw.username,g.raw.usericon);g.username=g.raw.symbol+'<b><a href="http://'+g.raw.username+'.deviantart.com/">'+g.raw.username+"</a></b>";if(g.raw.realname){g.info.push(g.raw.realname)}if(g.raw.typename){g.info.push(g.raw.typename)}});wsc.dAmn.chatterbox.Colours(a,f,b);wsc.dAmn.chatterbox.Emotes(a,f,b);wsc.dAmn.chatterbox.Stash(f,b);return b};wsc.dAmn.BDS=function(f,k,g){var h={};var a={};g.bds={version:"0.4",mns:"chat:datashare",gate:"chat:dsgateway",channel:(new StringSet()),provides:["BOTCHECK","CLINK"]};f.bds=g.bds;g.bds.channel.add(g.bds.mns);g.bds.channel.add(g.bds.gate);var l=function(){f.hidden.add(g.bds.mns);f.exclude.add(g.bds.mns);
f.hidden.add(g.bds.gate);f.exclude.add(g.bds.gate);f.bind("pkt.login",m);f.bind("pkt.recv_msg",b);f.bind("pkt.join",j.join);f.bind("BDS.BOTCHECK.DIRECT",j.botcheck);f.bind("BDS.BOTCHECK.ALL",j.botcheck);f.bind("BDS.BOTCHECK.OK",j.checkresp);f.bind("BDS.BOTCHECK.DENIED",j.checkresp);f.bind("CDS.LINK.REQUEST",j.clreq);f.bind("CDS.LINK.REJECT",j.clrj);f.bind("CDS.LINK.ACK",j.clra);f.bind("pkt.recv_join",j.pcrj);f.bind("pkt.recv_part",j.pcrp);f.bind("pkt.property",j.pcp);f.bind("closed",j.closed);f.middle("chan.recv_msg",function(o,n){j.hfilter(o,n)})};var m=function(n){if(n.pkt.arg.e!="ok"){return}f.join(g.bds.gate)};var b=function(q){if(q.user.toLowerCase()==f.settings.username.toLowerCase()){return}if(!g.bds.channel.contains(q.ns)){return}var p={ns:q.ns,sns:q.sns,message:q.message,user:q.user,name:"",payload:"",head:[null,null,null],params:[]};var s=q.message.split(":");var o=[null,null,null];var r=null;for(var n in o){o[n]=s.shift()||null;if(o[n]==null){return}}r=s.join(":");p.name=o.join(".");
p.payload=r;p.head=o;p.param=r.split(",");f.trigger(o[0],p);f.trigger(o[0]+"."+o[1],p);f.trigger(p.name,p)};var j={filter:function(o,n){if(f.settings.developer){n(o);return}if(o.ns[0]!="@"){n(o);return}var p=o.message.match(/<span class="cmsg u-([^"]+)">(.*)<\/span>/);if(!p){n(o);return}if(p[2].match(/^([A-Z0-9-_]+):([A-Z0-9-_]+):([A-Z0-9-_]+)(:.*|)$/)){return}n(o)},hfilter:function(o,n){if(f.settings.developer){n(o);return}if(o.sns[0]!="@"){n(o);return}if(o.message.match(/^([A-Z0-9-_]+):([A-Z0-9-_]+):([A-Z0-9-_]+)(:.*|)$/)){return}n(o)},closed:function(n){f.remove_ns(g.bds.mns);f.remove_ns(g.bds.gate)},join:function(n){if(n.ns.toLowerCase()!=g.bds.mns){return}if(n.pkt.arg.e!="ok"){return}},botcheck:function(o){if(o.head[2]!="ALL"&&o.payload!=f.settings.username){return}if(o.ns.toLowerCase()==g.bds.gate&&f.channel(g.bds.mns)!=null){return}var n=wsc.VERSION+"/0.0.0/"+wsc.dAmn.VERSION+"/"+g.bds.version;var p=CryptoJS.MD5(("wsc.dAmn"+n+f.settings.username+o.user).toLowerCase());f.npmsg(o.ns,"BDS:BOTCHECK:CLIENT:"+o.user+",wsc.dAmn,"+n+","+p)
},checkresp:function(n){if(n.ns.toLowerCase()!=g.bds.gate){return}if(n.param[0].toLowerCase()!=f.settings.username.toLowerCase()){return}if(f.channel(n.ns).info.members[f.settings.username].pc=="Visitors"){f.part(n.ns)}if(n.head[2]=="OK"){if(f.channel(g.bds.mns)==null){f.join(g.bds.mns)}return}f.ui.pager.notice({ref:"botcheckdenied",heading:"BDS Error",content:"Denied entry to backend channel.\nReason provided: <code>"+n.param.slice(1).join(",")+"</code>"})},clreq:function(r){if(r.payload.toLowerCase()!=f.settings.username.toLowerCase()){return}if(f.ui.umuted.indexOf(r.user.toLowerCase())!=-1){f.npmsg(r.ns,"CDS:LINK:REJECT:"+r.user+",You have been blocked");return}if(f.away.on){var p=new Date();var q=r.sns.toLowerCase();var n=timeLengthString((p-f.away.since)/1000);var s=replaceAll(f.away.format.away,"{user}",r.user);s=replaceAll(s,"{timesince}",n);f.npmsg(r.ns,"CDS:LINK:REJECT:"+r.user+",Away; "+f.away.reason);return}f.npmsg(r.ns,"CDS:LINK:ACK:"+r.user);var o=f.ui.pager.notice({ref:"clink-"+r.user,icon:'<img src="'+wsc.dAmn.avatar.src(r.user,f.channel(r.ns).info.members[r.user].usericon)+'" />',heading:"Chat "+r.user,content:r.user+" wants to talk in private.\nType <code>/chat "+r.user+"</code> to talk to them, or use the buttons below.",buttons:{accept:{ref:"accept",target:"accept",label:"Accept",title:"Join the private chat",click:function(){f.ui.pager.remove_notice(o);
f.join("@"+r.user);return false}},reject:{ref:"reject",target:"reject",label:"Reject",title:"Reject the private chat",click:function(){f.npmsg(r.ns,"CDS:LINK:REJECT:"+r.user);f.ui.pager.remove_notice(o);return false}}}},true);a[r.user]=o;o.onclose=function(){f.npmsg(r.ns,"CDS:LINK:REJECT:"+r.user)}},clrj:function(q){var n=q.user.toLowerCase();var r=q.payload.split(",");var o=r.shift();r=r.join(",");if(o.toLowerCase()!=f.settings.username.toLowerCase()){return}if(!(n in h)){return}clearTimeout(h[n]);f.channel("@"+n).server_message("Chat request rejected",r)},clra:function(q){var n=q.user.toLowerCase();var r=q.payload.split(",");var o=r.shift();if(o.toLowerCase()!=f.settings.username.toLowerCase()){return}clearTimeout(h[n])},pcp:function(p){if(p.ns.indexOf("pchat")!=0){return}if(f.bds.channel.contains(p.ns)){return}if(p.pkt.arg.p!="members"){return}if(f.channel(p.ns).get_usernames().length==2){f.bds.channel.add(p.ns);return}var n=p.sns.substr(1);var o=p.ns;f.ui.channel(o).server_message(n+" has not yet joined","Sending them a notice...");
f.npmsg("chat:datashare","CDS:LINK:REQUEST:"+n);h[n.toLowerCase()]=setTimeout(function(){try{f.ui.channel(o).server_message("Notification failed",n+" does not seem to be using a client that supports pchat notices.")}catch(q){}},10000)},pcrj:function(o){if(o.sns[0]!="@"){return}try{clearTimeout(h[o.user.toLowerCase()])}catch(n){}f.bds.channel.add(o.ns);if(!(o.user in a)){return}f.ui.pager.remove_notice(a[o.user])},pcrp:function(n){if(n.sns[0]!="@"){return}f.bds.channel.remove(n.ns)}};l()};wsc.dAmn.wsc.Colours=function(a,f,b){b.colours.send_colour=function(h,g){if(!b.colours.send){g(h);return}h.input+='<abbr title="colors:'+b.colours.user+":"+b.colours.msg+'"></abbr>';g(h)};a.middle("send.msg",b.colours.send_colour);a.middle("send.action",b.colours.send_colour)};wsc.dAmn.chatterbox.Colours=function(a,g,f){var b=a.ext.dAmn;f.colours.page=null;f.colours.configure_page=function(h,k){var j=h.settings.page("Colours");f.colours.page=j;var l={};l.on=b.colours.on;l.send=b.colours.send;l.msg=b.colours.msg;
l.user=b.colours.user;j.item("Form",{ref:"switch",title:"Enable Chromacity Colours",text:"Here you can turn chromacity colours on and off.\n\nYou                    can choose to parse other people's colours, and send your                    own colours.",fields:[["Checkbox",{ref:"enabled",items:[{value:"parse",title:"Parse colours",selected:l.on},{value:"send",title:"Send colours",selected:l.send}]}]],event:{change:function(m){b.colours.on=(m.data.enabled.indexOf("parse")!=-1);b.colours.send=(m.data.enabled.indexOf("send")!=-1)},save:function(m){l.on=b.colours.on;l.send=b.colours.send},close:function(m){b.colours.on=l.on;b.colours.send=l.send}}});j.item("Form",{ref:"colours",title:"Custom Colours",text:"Here you can set your own username colour and message colour.",fields:[["Colour",{ref:"usr",label:"Username Colour","default":"#"+l.user}],["Colour",{ref:"msg",label:"Message Colour","default":"#"+l.msg}]],event:{change:function(m){b.colours.user=m.data.usr.substr(1).toUpperCase();b.colours.msg=m.data.msg.substr(1).toUpperCase()
},save:function(m){l.user=b.colours.user;l.msg=b.colours.msg},close:function(m){b.colours.user=l.user;b.colours.msg=l.msg;f.colours.page=null},}})};f.colours.parse_colour=function(k){if(!b.colours.on){return}var j=k.item.find("abbr");if(j.length==0){return}j=j.last();var h=j.prop("title").match(/colors:([A-F0-9]{6}):([A-F0-9]{6})/);if(h==null){return}j.remove();k.item.find(".cmsg, .caction").css("color","#"+h[2]);k.item.find(".cmsg.user, .caction.user").css("color","#"+h[1])};g.on("settings.open.ran",f.colours.configure_page);g.on("log_item.after",f.colours.parse_colour)};wsc.dAmn.Emotes={};wsc.dAmn.wsc.Emotes=function(a,f,b){b.emotes.emote={};b.emotes.fint=null;b.emotes.fetching=false;b.emotes.loaded=false;b.emotes.fetch=function(){if(b.emotes.loaded){}else{}b.emotes.fetching=true;jQuery.getJSON("http://www.thezikes.org/publicemotes.php?format=jsonp&jsoncallback=?&"+(new Date()).getDay(),function(g){b.emotes.fetching=false;b.emotes.emote=g;if(!b.emotes.loaded){if(b.emotes.on){a.trigger("dAmn.emotes.loaded",{name:"dAmn.emotes.loaded"})
}}b.emotes.sort();b.emotes.loaded=true;b.emotes.fint=setTimeout(b.emotes.fetch,3600000)},function(){return false})};b.emotes.swap=function(m,g){if(!b.emotes.on){g(m);return}var h=m.input.match(/:([\S]+):/g);var l="";var k=-1;var j=function(n){return n!=h[k]};for(k in h){l=h[k];h=h.filter(j);if(!b.emotes.emote.hasOwnProperty(l)){continue}m.input=replaceAll(m.input,l,":thumb"+b.emotes.emote[l]["devid"]+":")}m.input=replaceAll(m.input,":B",":bucktooth:");g(m)};b.emotes.prepare=function(g){g=replaceAll(g,"&","&amp;");g=replaceAll(g,"<","&lt;");g=replaceAll(g,">","&gt;");return replaceAll(g,'"',"&quot;")};b.emotes.repair=function(g){g=replaceAll(g,"&quot;",'"');g=replaceAll(g,"&lt;","<");g=replaceAll(g,"&gt;",">");return replaceAll(g,"&amp;","&")};b.emotes.sort=function(){var m=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],];var l="ABCDEFGHIJKLMNOPQRSTUVWXYZ#";var n=null;var h=null;var g=false;var k=-1;var j=true};b.emotes.select=function(g){a.ui.control.set_text(a.ui.control.get_text()+b.emotes.repair(g))
};a.middle("send.msg",b.emotes.swap);a.middle("send.action",b.emotes.swap);a.middle("send.kick",b.emotes.swap);a.middle("send.set",b.emotes.swap);if(!b.emotes.on){return}b.emotes.fetch()};wsc.dAmn.chatterbox.Emotes=function(a,g,f){var b=a.ext.dAmn;f.emotes.page=null;f.emotes.configure_page=function(j,l){var k=j.settings.page("Emotes");f.emotes.page=k;var m={};m.on=b.emotes.on;var h="";if(m.on){if(!b.emotes.loaded||b.emotes.fetching){h="<em>Fetching emotes...</em>"}else{h="<em>Emotes loaded.</em>"}}k.item("Form",{ref:"switch",title:"Enable Emotes",text:"Here you can turn custom emotes on and off.",fields:[["Checkbox",{ref:"enabled",items:[{value:"yes",title:"On",selected:m.on}]}]],event:{change:function(n){b.emotes.on=(n.data.enabled.indexOf("yes")!=-1);b.emotes.picker.state(b.emotes.on);if(b.emotes.on){b.emotes.fetch();return}if(b.emotes.fint===null){return}clearTimeout(b.emotes.fint);b.emotes.fint=null},save:function(n){m.on=b.emotes.on;if(!b.emotes.on){}else{if(!b.emotes.fetching){}}},close:function(n){b.emotes.on=m.on;
b.load();b.emotes.page=null;if(b.emotes.fint===null){return}clearTimeout(b.emotes.fint);b.emotes.fint=null}}})};g.on("settings.open.ran",f.emotes.configure_page);a.bind("dAmn.emotes.loaded",function(j,h){g.pager.notice({ref:"emotes-loaded",heading:"Emote CLOUD",content:"Emoticons from zike's Emote CLOUD have been loaded."},false,5000,true)})};wsc.dAmn.Emotes.Tablumps=function(g){var m={id:g[0],thumb:g[4],server:parseInt(g[3]),flags:g[5].split(":"),dimensions:"",title:"",anchor:"",otitle:g[1]};m.flags[0]=parseInt(m.flags[0]);m.flags[1]=parseInt(m.flags[1]);m.flags[2]=parseInt(m.flags[2]);var f=m.thumb.match(/\.gif$/i);var j=g[2].split("x");var n=parseInt(j[0]);var k=parseInt(j[1]);var l,a;var b=(m.otitle.replace(/[^A-Za-z0-9]+/g,"-").replace(/^-+/,"").replace(/-+$/,"")||"-")+"-"+m.id;m.title=m.otitle+", "+n+"x"+k;m.anchor='<a target="_blank" href="http://www.deviantart.com/art/'+b+'" title="'+m.title+'">';if(n/k>1){a=parseInt((k*100)/n);l=100}else{l=parseInt((n*100)/k);a=100}if(l>n||a>k){l=n;
a=k}m.dimensions='width="'+l+'" height="'+a+'"';m.flags.push(f&&(n>200||k>200));return wsc.dAmn.Emotes.Thumb(m.id,m)};wsc.dAmn.Emotes.Thumb=function(l,g){g=Object.extend({title:"deviation by user",anchor:'<a href="http://url.com/devation__by_user.gif" target="_blank" title="deviation by user">',aclose:"</a>",thumb:"fs26/f/2008/160/b/2/deviation_by_username.gif",otitle:"deviation",flags:false,dimensions:"",server:"1",},(g||{}));var k=false;var a=g.thumb.match(/\.gif$/i);if(g.flags){if(g.flags[1]>0){return g.anchor+"[mature deviation: "+g.otitle+"]"+g.aclose}if(g.flags[2]>0){return g.anchor+"[deviation: "+g.otitle+"]"+g.aclose}if(g.flags[3]){return g.anchor+"[deviation: "+d.otitle+"]"+g.aclose}k=(g.flags[0]==0)}var j="";if(a){var h=g.thumb.replace(/:/,"/");j="http://fc0"+g.server+".deviantart.net/"+h;var b=h.split("/");if(b.length>1){b=b["."];if(b&&b.length>2){j="http://"+g.thumb}}return g.anchor+'<img class="thumb" title="'+g.title+'"'+g.dimensions+' alt=":thumb'+l+':" src="'+j+'" />'+g.aclose
}j="http://backend.deviantart.com/oembed?url=http://www.deviantart.com/deviation/"+l+"&format=thumb150";if(g.thumb.match(/.png$/i)){k=false}return g.anchor+'<img class="thumb'+(k?" shadow":"")+'"'+g.dimensions+' " alt=":thumb'+l+':" src="'+j+'" />'+g.aclose};wsc.dAmn.Emotes.Picker=function(j,a,f){a=a||{};a=Object.extend({title:"Emotes",event:{select:function(l){},reload:function(){}}},a);Chatterbox.Popup.ItemPicker.call(this,j,a);this.settings=f;this.rbutton=null;var k="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var h="";var g="";for(var b=0;b<k.length;b++){h=k[b];g=h.toLowerCase();this.add_page({ref:g,href:"#"+g,label:h,title:"Emotes beginning with "+h,items:[]},wsc.dAmn.Emotes.Page)}this.add_page({ref:"misc",href:"#misc",label:"#",title:"Emotes not beginning with letters",items:[]},wsc.dAmn.Emotes.Page)};wsc.dAmn.Emotes.Picker.prototype.constructor=wsc.dAmn.Emotes.Picker;wsc.dAmn.Emotes.Picker.Disabled='<section class="pages">            <section class="disabled">                <p>The emote cloud is currently disabled.</p><p>To use emoticons from                the cloud, click the button below to enable them.</p><p>                <a href="#enable" class="button text">Enable</a>                </p>            </section>            </section>            <section class="buttons"></section>';
wsc.dAmn.Emotes.Picker.prototype.state=function(a){this.settings.emotes.on=(a||false);this.rebuild();this.refresh()};wsc.dAmn.Emotes.Picker.prototype.hide=function(){this.window.css({display:"none"})};wsc.dAmn.Emotes.Picker.prototype.show=function(){this.window.css({display:"block"});this.refresh()};wsc.dAmn.Emotes.Picker.prototype.close=function(){this.hide()};wsc.dAmn.Emotes.Picker.prototype.build=function(a){Chatterbox.Popup.ItemPicker.prototype.build.call(this,a);this.rebuild()};wsc.dAmn.Emotes.Picker.prototype.rebuild=function(b){var a=this;this.window.find(".inner .content").html("");if(this.settings.emotes.on){this.options.content=Chatterbox.render("ip.main")}else{this.options.content=wsc.dAmn.Emotes.Picker.Disabled}this.window.find(".inner .content").html(this.options.content);this.pbook=this.window.find("section.pages");this.buttons=this.window.find("section.buttons");this.rbutton=this.add_button({href:"#reload",title:"Reload emoticons",label:"Reload"});if(this.settings.emotes.fetching){this.loading("Loading...")
}if(!this.settings.emotes.on){this.loading("Disabled")}this.rbutton.click(function(){if(!a.settings.emotes.on){return false}if(a.settings.emotes.fetching){return false}if(a.rbutton.hasClass("evented")){return false}a.reload();return false});if(this.settings.emotes.on){this.tabs=this.window.find("section.tabs ul");var h=this;var g=null;for(var f in this.pages){if(!this.pages.hasOwnProperty(f)){continue}g=this.pages[f];g.build();if(f==0){this.select_page(g)}}}else{this.dis=this.pbook.find(".disabled");this.dis.css({"max-width":330});this.dis.find("p").css({margin:"5px 10px 5px 10px",});this.dis.find("p").last().css({"text-align":"center","margin-top":25,"margin-bottom":25});this.dis.find("p").first().css({"margin-top":25});this.window.find("a[href=#enable].button").click(function(){a.state(true);a.settings.emotes.fetch();a.settings.save();return false})}};wsc.dAmn.Emotes.Picker.prototype.loaded=function(){this.rbutton.html("Reload");this.rbutton.removeClass("evented")};wsc.dAmn.Emotes.Picker.prototype.loading=function(a){a=a||"Reloading...";
this.rbutton.addClass("evented");this.rbutton.html(a)};wsc.dAmn.Emotes.Picker.prototype.reload=function(){this.loading();this.options.event.reload()};wsc.dAmn.Emotes.Page=function(){Chatterbox.Popup.ItemPicker.Page.apply(this,arguments)};wsc.dAmn.Emotes.Page.prototype.constructor=wsc.dAmn.Emotes.Page;wsc.dAmn.Emotes.Page.prototype.refresh=function(){if(!this.picker.settings.emotes.on){return}Chatterbox.Popup.ItemPicker.Page.prototype.refresh.call(this);var a=this;a.view.find("span.thumb img").error(function(){var f=a.view.find(this);var b=f.parent().parent();var g=a.picker.settings.emotes.repair(b.find(".value").html());delete a.picker.settings.emotes.emote[g];b.remove();return false});a.view.find("span.thumb img").load(function(){var j=a.view.find(this);var b=j.width();var g=j.height();var k,f;if(b/g>1){k=parseInt((g*100)/b);f=100}else{f=parseInt((b*100)/g);k=100}if(f>b||k>g){f=b;k=g}j.css({height:k,width:f});j.parent().css({"float":"right",display:"block"})})};wsc.dAmn.avatar={};wsc.dAmn.avatar.ext=["gif","gif","jpg","png"];
wsc.dAmn.avatar.link=function(a,b){var f=wsc.dAmn.avatar.src(a,b);return'<a target="_blank" title=":icon'+a+':" href="http://'+a+'.deviantart.com/"><img class="avatar"            alt=":icon'+a+':" src="'+f+'" height="50" /></a>'};wsc.dAmn.avatar.src=function(b,g){g=parseInt(g);var j=(g>>2)&15;g=g&3;var f=wsc.dAmn.avatar.ext[g]||"gif";var h="default";if(j){j="?"+j}else{j=""}if(g!=0){var a=new RegExp("\\$un(\\[([0-9]+)\\])","g");var h="$un[0]/$un[1]/{un}".replace(a,function(k,n,l){return b[l]=="-"?"_":b[l].toLowerCase()});h=replaceAll(h,"{un}",b.toLowerCase())}return"http://a.deviantart.net/avatars/"+h+"."+f+j};wsc.dAmn.BDS.Link=function(a,h,f){var g=function(){a.bind("BDS",b.cmd);a.bind("BDS.LINK.REQUEST",b.request);a.bind("BDS.LINK.REJECT",b.reject);a.bind("BDS.LINK.ACCEPT",b.accept);a.bind("BDS.LINK.CLOSE",b.close);a.bind("pkt.join",b.join);a.bind("pkt.part",b.part);a.bind("pkt.recv_join",b.recv_join);a.bind("pkt.recv_part",b.recv_part)};f.bds.link={white:(new StringSet()),connections:{},state:{closed:0,opening:1,open:2},conn:function(k,j,l,n){k=k.toLowerCase();
if(k in f.bds.link.connections){return f.bds.link.connections[k]}var o=a.format_ns("@"+k);var m={state:f.bds.link.state.closed,ns:o,un:k,close:function(){f.bds.link.close(m.un)},send:function(p){if(m.state!=f.bds.link.state.open){return false}a.npmsg(m.ns,p);return true},oncmd:(j||function(q,p){}),onopen:(l||function(q,p){}),onclose:(n||function(q,p){})};return m},request:function(k,o,j,l,n){var m=f.bds.link.open(k,j);if(m==null){return null}if(o===true){return m}a.npmsg(f.bds.mns,"BDS:LINK:REQUEST:"+k);return m},open:function(k,j,l,n){k=k.toLowerCase();if(k in f.bds.link.connections){return null}var m=f.bds.link.conn(k,j);m.state=f.bds.link.state.opening;f.bds.link.connections[k]=m;f.bds.channel.add(m.ns);a.hidden.add(m.ns);a.exclude.add(m.ns);a.join(m.ns);return m},close:function(j,l){j=j.toLowerCase();if(!(j in f.bds.link.connections)){return false}var k=f.bds.link.conn(j);if(l!==true){k.send("BDS:LINK:CLOSE")}a.part(k.ns);k.state=f.bds.link.state.closed;return true}};var b={cmd:function(j){if(!f.bds.channel.contains(j.ns)){return
}if(j.sns[0]!="@"){return}f.bds.link.conn(j.sns.substr(1)).oncmd(j,a)},request:function(k){if(k.payload.toLowerCase()!=a.settings.username.toLowerCase()){return}var j=a.channel(k.ns).info.members[k.user];if(parseInt(a.channel(k.ns).get_privclass_order(j.pc))<39){if(!f.bds.link.white.contains(k.user)){a.npmsg(k.ns,"BDS:LINK:REJECT:"+k.user);return}}f.bds.link.open(k.user);a.npmsg(k.ns,"BDS:LINK:ACCEPT:"+k.user)},reject:function(k){var j=k.user.toLowerCase();if(!(j in f.bds.link.connections)){return}f.bds.link.connections[j].close()},accept:function(j){if(j.payload.toLowerCase()!=a.settings.username.toLowerCase()){return}f.bds.link.open(j.user)},close:function(j){f.bds.link.close(j.user,true)},join:function(k){if(k.pkt.arg.e!="ok"){return}if(!f.bds.channel.contains(k.ns)){return}var j=f.bds.link.conn(k.sns.substr(1));if(a.channel(k.ns).get_usernames().length==1){return}j.state=f.bds.link.state.open;var l={name:"BDS.LINK.OPEN",link:j,ns:j.ns};j.onopen(l,a);a.trigger("BDS.LINK.OPEN",l)},part:function(k){if(!f.bds.channel.contains(k.ns)){return
}var j=f.bds.link.conn(k.sns.substr(1));j.state=f.bds.link.state.closed;var l={name:"BDS.LINK.CLOSED",link:j,ns:j.ns};j.onclose(l,a);a.trigger("BDS.LINK.CLOSED",l);delete f.bds.link.connections[j.un]},recv_join:function(k){if(!f.bds.channel.contains(k.ns)){return}var j=f.bds.link.conn(k.sns.substr(1));if(j.state!=f.bds.link.state.opening){return}j.state=f.bds.link.state.open;var l={name:"BDS.LINK.OPEN",link:j,ns:j.ns};j.onopen(l,a);a.trigger("BDS.LINK.OPEN",l)},recv_part:function(k){if(!f.bds.channel.contains(k.ns)){return}var j=f.bds.link.conn(k.sns.substr(1));j.close(true)},};g()};wsc.dAmn.chatterbox.Stash=function(f,a){var g=function(){f.on("log_item.after",b.log_item)};var b={log_item:function(j){var h=j.item.find('a[href^="http://sta.sh"]');h.each(function(l,k){var m=j.item.find(k);wsc.dAmn.chatterbox.Stash.fetch(j,m)})}};g()};wsc.dAmn.chatterbox.Stash.fetch=function(b,a){$.getJSON("http://backend.deviantart.com/oembed?url="+a.prop("href")+"&format=jsonp&callback=?",function(f){wsc.dAmn.chatterbox.Stash.render(b,a,f)
})};wsc.dAmn.chatterbox.Stash.render=function(r,j,x){if("error" in x){return}if(x.type!="photo"){return}var f=j.prop("href");var l=x.thumbnail_width;var s=x.thumbnail_height;var v,b;var y=x.title+" by "+x.author_name;var k='<a class="stashlink" target="_blank" href="'+f+'" title="'+y+'">';if(l/s>1){b=parseInt((s*100)/l);v=100}else{v=parseInt((l*100)/s);b=100}if(v>l||b>s){v=l;b=s}var q='width="'+v+'" height="'+b+'"';var g=!x.thumbnail_url.match(/.png$/i)?" shadow":"";var o=f.split("/").pop();var u='<span class="stashthumb" id="'+o+'">'+k+'<img class="smaller thumb'+g+'"'+q+' " alt="'+f+'" src="'+x.thumbnail_url_150+'" />        </a><a href="#toggle" class="button iconic plus" title="Larger"></a></span>';j.replaceWith(u);var a=r.item.find("span#"+o);j=a.find('a[href="'+f+'"]');var m=j.find("img.smaller");var z=null;var n=false;var p=a.find('a[href="#toggle"]');p.click(function(){if(!n){m.css("display","none");if(z==null){a.find("a.stashlink").append('<img class="larger thumb'+g+'" width="'+l+'"                height="'+s+'" alt="'+f+'" src="'+x.thumbnail_url+'" />');
z=a.find("img.larger")}z.css("display","inline");n=true;p.removeClass("plus");p.addClass("minus");p.prop("title","Smaller");r.chan.st+=r.item.height();r.chan.el.l.w.scrollTop(r.chan.st);r.chan.scroll();return false}z.css("display","none");m.css("display","inline");p.removeClass("minus");p.addClass("plus");p.prop("title","Larger");r.chan.st+=r.item.height();r.chan.el.l.w.scrollTop(r.chan.st);r.chan.scroll();n=false;return false});r.chan.st+=r.item.height();r.chan.el.l.w.scrollTop(r.chan.st);r.chan.scroll()};wsc.dAmn.TablumpString=function(a,b){this._parser=b||new wsc.dAmn.Tablumps();this.tokens=this._parser.tokenise(a);this.raw=a;this._text=null;this._html=null;this._ansi=null;this._chonc=null};wsc.dAmn.TablumpString.prototype=new wsc.MessageString;wsc.dAmn.TablumpString.prototype.constructor=wsc.dAmn.TablumpString;with(wsc.dAmn.TablumpString.prototype=new String){constructor=wsc.dAmn.TablumpString;toString=valueOf=function(){return this.raw}}wsc.dAmn.TablumpString.prototype.html=function(){if(this._html==null){this._html=this._parser.render(1,this)
}return this._html};wsc.dAmn.TablumpString.prototype.text=function(){if(this._text==null){this._text=this._parser.render(0,this)}return this._text};wsc.dAmn.TablumpString.prototype.ansi=function(){if(this._ansi==null){this._ansi=this._parser.render(3,this)}return this._ansi};wsc.dAmn.TablumpString.prototype.chonc=function(){if(this._chonc==null){this._chonc=this._parser.render(2,this)}return this._chonc};wsc.dAmn.PARSE={RAW:0,TAG:1,ARG:2};wsc.dAmn.TablumpParser=function(){this.lumps=this.defaultMap()};wsc.dAmn.TablumpParser.prototype=new wsc.MessageParser;wsc.dAmn.TablumpParser.prototype.constructor=wsc.dAmn.TablumpParser;wsc.dAmn.TablumpParser.prototype.registerMap=function(a){this.lumps=a};wsc.dAmn.TablumpParser.prototype.extend=function(a){for(index in a){this.lumps[index]=a[index]}};wsc.dAmn.TablumpParser.prototype.defaultMap=function(){return{"&b\t":[0,"<b>","<b>","<b>","\x1b[1m"],"&/b\t":[0,"</b>","</b>","</b>","\x1b[22m"],"&i\t":[0,"<i>","<i>","<i>","\x1b[3m"],"&/i\t":[0,"</i>","</i>","</i>","\x1b[23m"],"&u\t":[0,"<u>","<u>","<u>","\x1b[4m"],"&/u\t":[0,"</u>","</u>","</u>","\x1b[24m"],"&s\t":[0,"<s>","<s>","<s>","\x1b[9m"],"&/s\t":[0,"</s>","</s>","</s>","\x1b[29m"],"&sup\t":[0,"<sup>"],"&/sup\t":[0,"</sup>"],"&sub\t":[0,"<sub>"],"&/sub\t":[0,"</sub>"],"&code\t":[0,"<code>"],"&/code\t":[0,"</code>"],"&p\t":[0,"<p>"],"&/p\t":[0,"</p>"],"&ul\t":[0,"<ul>"],"&/ul\t":[0,"</ul>"],"&ol\t":[0,"<ol>"],"&li\t":[0,"<li>"],"&/li\t":[0,"</li>"],"&/ol\t":[0,"</ol>"],"&link\t":[3,function(a){return a[0]+(a[1]?(" ("+a[1]+")"):"")
},function(a){t=a[1];return'<a target="_blank" href="'+a[0]+'" title="'+(t||a[0])+'">'+(t||"[link]")+"</a>"},function(a){t=a[1];return'<a target="_blank" href="'+a[0]+'" title="'+(t||a[0])+'">'+(t||"[link]")+"</a>"}],"&acro\t":[1,'<acronym title="{0}">'],"&/acro\t":[0,"</acronym>"],"&abbr\t":[1,'<abbr title="{0}">'],"&/abbr\t":[0,"</abbr>"],"&img\t":[3,'<img src="{0}" alt="{1}" title="{2}" />'],"&iframe\t":[3,'<iframe src="{0}" width="{1}" height="{2}" />'],"&/iframe\t":[0,"</iframe>"],"&a\t":[2,'<a href="{0}" title="{1}">'],"&/a\t":[0,"</a>"],"&br\t":[0,"<br/>"],"&bcode\t":[0,"<bcode>","<span><pre><code>"],"&/bcode\t":[0,"</bcode>","</code></pre></span>"],"&avatar\t":[2,":icon{0}:",function(a){return wsc.dAmn.avatar.link(a[0],a[1])}],"&emote\t":[5,"{0}",'<img alt="{0}" width="{1}" height="{2}" title="{3}" src="http://e.deviantart.com/emoticons/{4}" />'],"&dev\t":[2,":dev{1}:",'{0}<a target="_blank" alt=":dev{1}:" href="http://{1}.deviantart.com/">{1}</a>','{0}<a target="_blank" alt=":dev{1}:" href="http://{1}.deviantart.com/">{1}</a>',"{0}\x1b[36m{1}\x1b[39m"],"&thumb\t":[6,":thumb{0}:",wsc.dAmn.Emotes.Tablumps,function(f){var b=(f[1].replace(/[^A-Za-z0-9]+/g,"-").replace(/^-+/,"").replace(/-+$/,"")||"-")+"-"+f[0];
var a='[<a target="_blank" href="http://www.deviantart.com/art/'+b+'" title="'+f[1]+'">';return a+"deviation: "+f[1]+"</a>]"},"[deviation: {1}]"],EOF:[0,"",null,null,"\x1b[m"]}};wsc.dAmn.TablumpParser.prototype.parse=function(b,a){b=replaceAll(b,"<","&lt;");b=replaceAll(b,">","&gt;");return new wsc.dAmn.TablumpString(b,this)};wsc.dAmn.TablumpParser.prototype.tokenise=function(j){if(!j){return[]}var a=wsc.dAmn.PARSE.RAW;var m=[];var b="";var g=0;var l=[];var f="";var n="";var k="";for(var h=0;h<j.length;h++){k=j[h];switch(a){case wsc.dAmn.PARSE.RAW:if(k!="&"){f+=k;break}b=k;a=wsc.dAmn.PARSE.TAG;break;case wsc.dAmn.PARSE.TAG:b+=k;if(k==" "||k=="\t"||k=="&"){if(k==" "||k=="&"||!this.lumps.hasOwnProperty(b)){f+=b;b="";if(k=="&"){h--;f=f.substr(0,f.length-1)}a=wsc.dAmn.PARSE.RAW}else{if(f.length>0){m.push(["raw",f]);f=""}l=[b,[]];g=this.lumps[b][0];m.push(l);b="";if(g>0){a=wsc.dAmn.PARSE.ARG}else{a=wsc.dAmn.PARSE.RAW}}}break;case wsc.dAmn.PARSE.ARG:if(k=="\t"){g--;if(b=="&"){a=wsc.dAmn.PARSE.RAW;
b="";break}l[1].push(b);b="";if(g==0){a=wsc.dAmn.PARSE.RAW}break}b+=k;break}}if(f.length>0||b.length>0){m.push(["raw",f+b])}return m};wsc.dAmn.TablumpParser.prototype.render=function(a,g){if(!g){return""}if(!g.hasOwnProperty("tokens")){return""}a=a+1;var h="";var f=[];for(var b in g.tokens){if(!g.tokens.hasOwnProperty(b)){continue}f=g.tokens[b];if(f[0]=="raw"){h+=f[1];continue}h+=this.renderOne(a,f[0],f[1])}return h+this.renderOne(a,"EOF","")};wsc.dAmn.TablumpParser.prototype.renderOne=function(b,a,h){var f=this.lumps[a];if(f===undefined){return"&"+a+"\t"+h.join("\t")}var g=f[b]||f[1];if(typeof(g)=="string"){return String.format(g,h)}else{return g.call(this,h)}};wsc.dAmn.BDS.Peer=function(a,g,b){var f=function(){var h=new wsc.dAmn.BDS.Peer.SignalHandler(a)};b.bds.peer={handler:null,calls:{},call:function(h){h=h.toLowerCase();for(var j in b.bds.peer.calls){if(!b.bds.peer.calls.hasOwnProperty(j)){continue}if(j.toLowerCase()==h){return b.bds.peer.calls[j]}}return null},open:function(l,m,j,k,h,n){if(!b.bds.peer.call(m)){b.bds.peer.calls[m]=new wsc.dAmn.BDS.Peer.Call(a,l,m,j,k,h,n)
}return b.bds.peer.calls[m]},remove:function(j){var h=b.bds.peer.call(j);if(!h){return}delete b.bds.peer.calls[j]},request:function(){},};f()};wsc.dAmn.BDS.Peer.bots=["botdom","damnphone"];wsc.dAmn.BDS.Peer.peer_options={iceServers:[{url:"stun:stun.l.google.com:19302"}]};wsc.dAmn.BDS.Peer.phone=null;wsc.dAmn.BDS.Peer.signal=null;wsc.dAmn.BDS.Peer.local={};wsc.dAmn.BDS.Peer.local.stream=null;wsc.dAmn.BDS.Peer.local.url=null;wsc.dAmn.BDS.Peer.remote={};wsc.dAmn.BDS.Peer.remote._empty={video:null,audio:null,conn:null};wsc.dAmn.BDS.Peer.chan={};wsc.dAmn.BDS.Peer.chan.group=false;wsc.dAmn.BDS.Peer.chan.calls=[];wsc.dAmn.BDS.Peer.Call=function(f,l,a,j,n,m,g,o){this.client=f;this.bds=l;this.ns="";this.pns=a;this.user=j;this.app=n;this.app_ver=m;this.title="";this.pc="";this.localstream=null;this.localurl=null;this.constraints=g;this.peers={};this.closing=false;this.timeout=null;this.group=j.substr(0,5)=="chat:";var b=this.pns.split(":");var k=b.shift();if(k=="chat"){this.ns="chat:"+b.shift()}else{if(k=="pchat"){this.ns="pchat:"+b.shift()+":"+b.shift()
}}if(b[0]=="pc"){b.shift();this.pc=b.shift()}this.title=b.join(":");this.group=wsc.dAmn.BDS.Peer.bots.indexOf(this.ns.substr(1))!=-1;this.signal=new wsc.dAmn.BDS.Peer.SignalChannel(f,this,l,a,n,m);this.onlocalstream=function(){};if(o){this.localstream=o;this.localurl=URL.createObjectURL(o)}this.onclose=function(){};var p=this;this._closed=function(){p.onclose()};p.ontimeout=function(){}};wsc.dAmn.BDS.Peer.Call.prototype.timedout=function(){this.timeout=null;this.ontimeout();this.close()};wsc.dAmn.BDS.Peer.Call.prototype.set_local_stream=function(a){this.localstream=a;this.localurl=URL.createObjectURL(a);this.onlocalstream()};wsc.dAmn.BDS.Peer.Call.prototype.close=function(){if(this.closing){return}this.closing=true;this.signal.close();for(var a in this.peers){if(!this.peers.hasOwnProperty(a)){continue}this.remove(a)}this.client.bds.peer.remove(this.pns);this._closed();this.closing=false};wsc.dAmn.BDS.Peer.Call.prototype.new_peer=function(a,b){var f=wsc.dAmn.BDS.peer_connection(this,a,b,this.constraints,this.localstream);
this.peers[a]=f;return f};wsc.dAmn.BDS.Peer.Call.prototype.peer=function(a){return this.peers[a]||null};wsc.dAmn.BDS.Peer.Call.prototype.remove=function(a){var b=this.peer(a);if(!b){return}delete this.peers[b];b.close()};wsc.dAmn.BDS.peer_connection=function(b,a,f,g){if(!wsc.dAmn.BDS.Peer.RTC.PeerConnection){return null}return new wsc.dAmn.BDS.Peer.Connection(b,a,f,g)};wsc.dAmn.BDS.Peer.Connection=function(b,a,f,h,g){this.call=b;this.user=a;this.pc=new wsc.dAmn.BDS.Peer.RTC.PeerConnection(wsc.dAmn.BDS.Peer.peer_options,h);this.offer="";this.remote_offer=f||null;this.remote_set=false;this.responding=this.remote_offer!=null;this.streamed=false;this.remote_stream=null;this.stream=null;this.connected=false;this.bindings();if(this.remote_offer){this.set_remote_description(this.remote_offer)}if(g){this.set_local_stream(g)}};wsc.dAmn.BDS.Peer.Connection.prototype.bindings=function(){var b=this;var a=this.user;this.pc.onicecandidate=function(g){b.call.signal.candidate(b,g.candidate)};this.pc.onaddstream=function(g){b.set_remote_stream(g)
};this.pc.onnegotiationneeded=function(g){b.onnegotiationneeded(g)};this.pc.onclose=function(){b._closed()};var f=function(){};this.onready=f;this.onopen=f;this.onclose=f;this.onreject=f;this.onremotedescription=f;this.onlocaldescription=f;this.onicecompleted=f;this.onremotestream=f;this.onlocalstream=f;this.onnegotiationneeded=f};wsc.dAmn.BDS.Peer.Connection.prototype.close=function(){try{this.pc.close()}catch(a){}this._closed()};wsc.dAmn.BDS.Peer.Connection.prototype._closed=function(){this.onclose()};wsc.dAmn.BDS.Peer.Connection.prototype.reject=function(a){this.onreject(a);this.call.remove(this.user)};wsc.dAmn.BDS.Peer.Connection.prototype.onerror=function(a){console.log(">> Got an error:",'"',a.message,'"',a)};wsc.dAmn.BDS.Peer.Connection.prototype.candidate=function(a){this.pc.addIceCandidate(a)};wsc.dAmn.BDS.Peer.Connection.prototype.ice_completed=function(){this.onicecompleted()};wsc.dAmn.BDS.Peer.Connection.prototype.create_offer=function(){var a=this;this.pc.createOffer(function(b){a.offer_created(b)
},function(b){a.onerror(b)})};wsc.dAmn.BDS.Peer.Connection.prototype.offer_created=function(b){this.offer=b;var a=this;this.pc.setLocalDescription(this.offer,function(){a.local_description_set(0)},this.onerror)};wsc.dAmn.BDS.Peer.Connection.prototype.set_remote_description=function(f,b){this.remote_offer=f;this.responding=this.pc.signalingState=="stable";var a=this;this.pc.setRemoteDescription(this.remote_offer,function(){a.remote_description_set(b)},this.onerror)};wsc.dAmn.BDS.Peer.Connection.prototype.local_description_set=function(a){if(this.responding){this.connected=true;this.responding=false}this.onlocaldescription(a)};wsc.dAmn.BDS.Peer.Connection.prototype.remote_description_set=function(a){this.responding=a==0;this.remote_set=true;if(!this.responding){this.connected=true}this.onremotedescription(a)};wsc.dAmn.BDS.Peer.Connection.prototype.create_answer=function(){var a=this;this.responding=true;this.pc.createAnswer(function(b){a.answer_created(b)},function(b){a.onerror(b)})};wsc.dAmn.BDS.Peer.Connection.prototype.answer_created=function(b){this.offer=b;
var a=this;this.pc.setLocalDescription(this.offer,function(){a.local_description_set(1)},function(f){a.onerror(f)})};wsc.dAmn.BDS.Peer.Connection.prototype.set_remote_stream=function(a){this.remote_stream=a.stream;this.onremotestream()};wsc.dAmn.BDS.Peer.Connection.prototype.set_local_stream=function(a){this.pc.addStream(a);this.stream=a;this.onlocalstream()};wsc.dAmn.BDS.Peer.Connection.prototype.persist=function(){var b=this;var a=this.call;b.onremotedescription=function(f){if(f!=0){return}b.create_answer()};b.onlocaldescription=function(f){switch(f){case 0:a.signal.offer(b);break;case 1:a.signal.answer(b);break;default:break}};b.onnegotiationneeded=function(){b.create_offer()}};wsc.dAmn.BDS.Peer.SignalChannel=function(f,h,a,j,g,b){this.user=f.settings.username;this.nse=ns?","+ns:"";this.bds=a;this.pns=j;this.ns=ns;this.app=g;this.app_ver=b;this.client=f;this.call=h};wsc.dAmn.BDS.Peer.SignalChannel.prototype.command=function(){var b=Array.prototype.slice.call(arguments);var g=b.shift();
var a=this.pns;for(var f=0;f<b.length;f++){if(!b.hasOwnProperty(f)||!b[f]){continue}a+=","+b[f]}this.client.npmsg(this.bds,"BDS:PEER:"+g+":"+a)};wsc.dAmn.BDS.Peer.SignalChannel.prototype.request=function(f,a){var b=this.call;b.timeout=setTimeout(function(){b.timedout()},10000);this.command("REQUEST",this.user,f||this.app,(a||this.app_ver).toString())};wsc.dAmn.BDS.Peer.SignalChannel.prototype.ack=function(b,f,a){this.command("ACK",b,f||this.app,(a||this.app_ver).toString())};wsc.dAmn.BDS.Peer.SignalChannel.prototype.accept=function(b,f,a){this.command("ACCEPT",b,f||this.app,(a||this.app_ver).toString())};wsc.dAmn.BDS.Peer.SignalChannel.prototype.offer=function(a){this.command("OFFER",this.user,a.user,JSON.stringify(a.offer))};wsc.dAmn.BDS.Peer.SignalChannel.prototype.answer=function(a){this.command("ANSWER",this.user,a.user,JSON.stringify(a.offer))};wsc.dAmn.BDS.Peer.SignalChannel.prototype.candidate=function(b,a){this.command("CANDIDATE",this.user,b.user,JSON.stringify(a))};wsc.dAmn.BDS.Peer.SignalChannel.prototype.reject=function(a,b){this.command("REJECT",a,b)
};wsc.dAmn.BDS.Peer.SignalChannel.prototype.close=function(a){this.command("CLOSE",(a||this.user))};wsc.dAmn.BDS.Peer.SignalChannel.prototype.list=function(a){a=a?":"+a:"";this.client.npmsg(this.bds,"BDS:PEER:LIST"+a)};wsc.dAmn.BDS.Peer.SignalHandler=function(a){var b=this;a.bind("BDS.PEER.REQUEST",function(g,f){b.request(g,f)});a.bind("BDS.PEER.ACK",function(g,f){b.ack(g,f)});a.bind("BDS.PEER.REJECT",function(g,f){b.reject(g,f)});a.bind("BDS.PEER.ACCEPT",function(g,f){b.accept(g,f)});a.bind("BDS.PEER.OPEN",function(g,f){b.open(g,f)});a.bind("BDS.PEER.END",function(g,f){b.end(g,f)});a.bind("BDS.PEER.OFFER",function(g,f){b.offer(g,f)});a.bind("BDS.PEER.ANSWER",function(g,f){b.answer(g,f)});a.bind("BDS.PEER.CANDIDATE",function(g,f){b.candidate(g,f)});a.bind("BDS.PEER.CLOSE",function(g,f){b.close(g,f)})};wsc.dAmn.BDS.Peer.SignalHandler.prototype.request=function(h,b){if(h.sns[0]!="@"){return}var k=h.param[0];var f=h.param[1];var l=h.param[2];var a=parseInt(h.param[3]);var g=b.bds.peer.call(k);
if(!g){g=b.bds.peer.open(h.ns,k,f,l,a)}g.signal.ack(f,l,a);var j=g.peer(f);if(!j){j=g.new_peer(f)}b.trigger("peer.request",{name:"peer.request",ns:h.ns,call:g,user:f,app:l,version:a,peer:j});return true},wsc.dAmn.BDS.Peer.SignalHandler.prototype.ack=function(h,b){if(h.sns[0]!="@"){return}var g=b.bds.peer.call(h.param[0]);if(!g){return}var f=h.param[1];var j=h.param[2];var a=parseInt(h.param[3]);if(g.timeout!=null){clearTimeout(g.timeout);g.timeout=null}};wsc.dAmn.BDS.Peer.SignalHandler.prototype.reject=function(g,a){if(g.sns[0]!="@"){return}var f=a.bds.peer.call(g.param[0]);var b=g.param[1];var j=g.param[2];if(!f){return}if(b.toLowerCase()!=a.settings.username.toLowerCase()){return}var h=f.peer(g.user);if(!h){h=f.new_peer(g.user)}h.reject(j);a.trigger("peer.reject",{name:"peer.reject",ns:g.ns,pns:g.param[0],user:g.user,reason:j})};wsc.dAmn.BDS.Peer.SignalHandler.prototype.accept=function(h,b){if(h.sns[0]!="@"){return}var g=b.bds.peer.call(h.param[0]);if(!g){return}var f=h.param[1];var k=h.param[2];
var a=parseInt(h.param[3]);if(f.toLowerCase()!=b.settings.username.toLowerCase()){return}var j=g.peer(h.user);if(!j){j=g.new_peer(h.user)}b.trigger("peer.accept",{name:"peer.accept",ns:h.ns,pns:h.param[0],app:k,version:a,call:g,peer:j})};wsc.dAmn.BDS.Peer.SignalHandler.prototype.open=function(b,a){};wsc.dAmn.BDS.Peer.SignalHandler.prototype.end=function(b,a){};wsc.dAmn.BDS.Peer.SignalHandler.prototype.offer=function(h,a){if(h.sns[0]!="@"){return}var f=a.bds.peer.call(h.param[0]);if(!f){return}var l=f.pns;var b=h.param[1];var k=h.param[2];var g=new wsc.dAmn.BDS.Peer.RTC.SessionDescription(JSON.parse(h.param.slice(3).join(",")));if(k.toLowerCase()!=a.settings.username.toLowerCase()){return}var j=f.peer(b);if(!j){j=f.new_peer(b)}a.trigger("peer.offer",{name:"peer.offer",ns:h.ns,pns:f.pns,call:f,peer:j,offer:g});j.set_remote_description(g,0)};wsc.dAmn.BDS.Peer.SignalHandler.prototype.answer=function(g,a){if(g.sns[0]!="@"){return}var f=a.bds.peer.call(g.param[0]);if(!f){return}var b=g.param[1];
var k=g.param[2];var j=new wsc.dAmn.BDS.Peer.RTC.SessionDescription(JSON.parse(g.param.slice(3).join(",")));if(k.toLowerCase()!=a.settings.username.toLowerCase()){return}var h=f.peer(b);if(!h){h=f.new_peer(b)}a.trigger("peer.answer",{name:"peer.answer",ns:g.ns,pns:f.pns,call:f,peer:h,answer:j});h.set_remote_description(j,1)};wsc.dAmn.BDS.Peer.SignalHandler.prototype.candidate=function(h,a){if(h.sns[0]!="@"){return}var f=a.bds.peer.call(h.param[0]);if(!f){return}var j=f.peer(h.param[1]);if(!j){return}var k=h.param[2];if(k.toLowerCase()!=a.settings.username.toLowerCase()){return}var b=JSON.parse(h.param.slice(3).join(","));if(!b){j.ice_completed();return}var g=new wsc.dAmn.BDS.Peer.RTC.IceCandidate(b);j.candidate(g);a.trigger("peer.candidate",{name:"peer.candidate",ns:h.ns,pns:f.pns,call:f,peer:j,candidate:b,ice:g})};wsc.dAmn.BDS.Peer.SignalHandler.prototype.close=function(f,a){if(f.sns[0]!="@"){return}var b=a.bds.peer.call(f.param[0]);if(!b){return}var g=b.peer(f.param[1]);if(!g){return}if(g.user.toLowerCase()==a.settings.username.toLowerCase()){return
}b.remove(g.user);a.trigger("peer.close",{name:"peer.close",ns:f.ns,evt:f,call:b,peer:g})};wsc.dAmn.BDS.Peer.RTC={PeerConnection:null,SessionDescription:null,IceCandidate:null,};if(window.mozRTCPeerConnection){wsc.dAmn.BDS.Peer.RTC.PeerConnection=mozRTCPeerConnection;wsc.dAmn.BDS.Peer.RTC.SessionDescription=mozRTCSessionDescription;wsc.dAmn.BDS.Peer.RTC.IceCandidate=mozRTCIceCandidate}if(window.webkitRTCPeerConnection){wsc.dAmn.BDS.Peer.RTC.PeerConnection=webkitRTCPeerConnection}if(window.RTCPeerConnection&&!wsc.dAmn.BDS.Peer.RTC.PeerConnection){wsc.dAmn.BDS.Peer.RTC.PeerConnection=RTCPeerConnection}if(window.RTCSessionDescription){wsc.dAmn.BDS.Peer.RTC.SessionDescription=RTCSessionDescription;wsc.dAmn.BDS.Peer.RTC.IceCandidate=RTCIceCandidate}(function(a){a("*").hover(function(b){a(this).data("hover",true)},function(b){a(this).data("hover",false)});a.fn.wsc=function(g,f){var b=a(window).data("wscclient");if(g=="init"||b===undefined){if(b==undefined){b=new wsc.Client(a(this),f,(a.browser.mozilla||false));
setInterval(function(){b.loop()},120000)}a(window).data("wscclient",b)}if(g!="init"&&g!=undefined){g="jq_"+g;if(g in b){b[g](a(this),f)}}return b};a.fn.wscui=function(f,b){ui=a(window).data("wscui");if(f=="init"||ui===undefined){if(ui==undefined){ui=new Chatterbox.UI(a(this),b,(a.browser.mozilla||false));a(window).resize(ui.resize)}a(window).data("wscui",ui)}if(f!="init"&&f!=undefined){f="jq_"+f;if(f in ui){ui[f](a(this),b)}}return ui}})(jQuery);